<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PromptVault</title>
<link rel="icon" href="/favicon.png" type="image/png">
    <meta name="description" content="Offline-first storage for high-quality AI prompts.">
    <meta name="theme-color" content="#000000">
    
    <style>
        :root {
            /* Modern macOS/iOS Dark Palette with Enhanced Blue */
            --bg-body: #050505;
            --bg-sidebar: rgba(20, 20, 22, 0.85); 
            --bg-panel: rgba(25, 25, 28, 0.7);
            --bg-card: rgba(35, 35, 40, 0.6);
            
            --border: rgba(255, 255, 255, 0.08);
            --border-light: rgba(255, 255, 255, 0.12);
            --border-accent: rgba(10, 132, 255, 0.3);
            
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-tertiary: rgba(255, 255, 255, 0.4);
            
            /* The Blue Tone */
            --accent: #0A84FF; 
            --accent-gradient: linear-gradient(135deg, #0A84FF, #0066CC);
            --accent-dim: rgba(10, 132, 255, 0.1);
            --accent-glow: rgba(10, 132, 255, 0.25);
            --accent-hover: rgba(10, 132, 255, 0.2);
            
            --danger: #FF453A;
            --danger-bg: rgba(255, 69, 58, 0.15);
            --success: #32D74B;
            --warning: #FF9F0A;
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            
            --font-sans: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-mono: "SF Mono", "Menlo", "Monaco", "Consolas", "Courier New", monospace;
            
            /* Dynamic Sidebar Width */
            --sidebar-width: 280px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at 50% -20%, #1a2a3a 0%, #000000 60%);
            color: var(--text-primary);
            font-family: var(--font-sans);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* --- Layout --- */
        #app {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr 300px;
            height: 100%;
            width: 100%;
            overflow: hidden;
            transition: grid-template-columns 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        #app.meta-collapsed {
            grid-template-columns: var(--sidebar-width) 1fr 0;
        }

        @media (max-width: 1024px) {
            #app { grid-template-columns: var(--sidebar-width) 1fr 0; }
            .right-panel-toggle { display: flex !important; }
        }
        @media (max-width: 768px) {
            #app { display: flex; flex-direction: column; }
            #sidebar, #meta-panel { display: none; }
            #sidebar.active, #meta-panel.active { 
                display: flex; position: absolute; z-index: 50; height: 100%; width: 100%; 
                background: #000;
            }
            .mobile-only { display: inline-flex !important; }
            /* Reset Sidebar Width on mobile to auto/full */
            :root { --sidebar-width: 100%; } 
        }

        /* --- Panels --- */
        .panel {
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            background: var(--bg-panel);
            backdrop-filter: blur(40px) saturate(150%);
            -webkit-backdrop-filter: blur(40px) saturate(150%);
            min-width: 0;
            height: 100%; 
            overflow: hidden;
            position: relative;
        }
        
        #sidebar { background: var(--bg-sidebar); }
        .panel:last-child { border-right: none; }
        
        .panel-header {
            padding: 0 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 56px;
            background: transparent;
            flex-shrink: 0;
        }

        .panel-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
            background: rgba(20, 20, 20, 0.5);
            margin-top: auto;
        }
        
        .panel-title {
            font-weight: 600;
            font-size: 15px;
            letter-spacing: -0.01em;
            color: var(--text-primary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            min-height: 0;
        }
        
        /* Sidebar Resizer */
        .resizer {
            position: absolute; right: 0; top: 0; bottom: 0; width: 4px;
            cursor: col-resize; z-index: 10;
            background: transparent;
            transition: background 0.2s;
        }
        .resizer:hover, .resizer.resizing { background: var(--accent); }

        /* Collapsed Sidebar Styles */
        #sidebar.collapsed {
            align-items: center;
        }
        #sidebar.collapsed .panel-title,
        #sidebar.collapsed #search-container,
        #sidebar.collapsed #quick-filters,
        #sidebar.collapsed .panel-content, 
        #sidebar.collapsed .resizer,
        #sidebar.collapsed .panel-footer button { display: none; }
        
        #sidebar.collapsed .panel-header { padding: 0; justify-content: center; width: 100%; flex-direction: column; height: auto; padding-top: 16px; gap: 16px; border-bottom: none;}
        #sidebar.collapsed .panel-header .flex-row { flex-direction: column; }
        #sidebar.collapsed .panel-footer { display: flex; justify-content: center; width: 100%; border-top: none; background: transparent; }
        
        /* Icon rail items for collapsed state */
        .collapsed-icon { display: none; width: 40px; height: 40px; justify-content: center; align-items: center; border-radius: 10px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
        .collapsed-icon:hover { background: var(--accent-dim); color: var(--accent); }
        #sidebar.collapsed .collapsed-icon { display: flex; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-dim); }

        /* --- Components --- */
        #search-container {
            padding: 12px 16px 8px 16px;
            position: relative;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #search-input {
            width: 100%;
            padding: 8px 30px 8px 32px;
            background: rgba(255,255,255,0.05);
            border: 1px solid transparent;
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            font-size: 13px;
            transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='rgba(235,235,245,0.6)'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 8px center;
            background-size: 16px;
        }
        #search-input:focus {
            background-color: rgba(255,255,255,0.08);
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent-dim);
        }
        #search-clear {
            position: absolute; right: 48px; top: 50%; transform: translateY(-50%);
            color: var(--text-tertiary); cursor: pointer; display: none; font-size: 14px;
        }
        #search-clear:hover { color: var(--text-primary); }
        
        #search-help-btn {
            color: var(--text-secondary); cursor: pointer; opacity: 0.7; font-size: 14px; padding: 4px;
        }
        #search-help-btn:hover { opacity: 1; color: var(--accent); }

        /* Quick Filters */
        #quick-filters {
            padding: 0 16px 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex; gap: 8px; flex-wrap: wrap;
            flex-shrink: 0;
        }
        .filter-chip {
            font-size: 11px; padding: 4px 10px; border-radius: 12px;
            background: rgba(255,255,255,0.05); color: var(--text-secondary);
            cursor: pointer; border: 1px solid transparent; transition: all 0.2s;
            user-select: none; font-weight: 500;
        }
        .filter-chip:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
        .filter-chip.active { background: var(--accent-dim); color: var(--accent); border-color: var(--accent-glow); }

        #prompt-list { padding: 0; }

        .prompt-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .prompt-item:hover { background: rgba(255,255,255,0.03); padding-left: 20px; }
        .prompt-item.active { 
            background: linear-gradient(90deg, rgba(10, 132, 255, 0.12) 0%, transparent 100%);
            border-left: 3px solid var(--accent);
            padding-left: 17px; 
        }
        
        .prompt-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; color: var(--text-primary); display: flex; justify-content: space-between; align-items: center; }
        .prompt-preview { 
            font-size: 13px; color: var(--text-secondary); line-height: 1.4;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
            margin-bottom: 6px;
        }
        
        /* Pinned Icon */
        .pin-btn {
            opacity: 0; color: var(--text-tertiary); cursor: pointer; transition: all 0.2s; margin-left: 8px;
        }
        .prompt-item:hover .pin-btn, .prompt-item.pinned .pin-btn { opacity: 1; }
        .prompt-item.pinned .pin-btn { color: var(--accent); transform: rotate(45deg); }
        .prompt-item .pin-btn:hover { color: var(--text-primary); }

        /* Micro Metadata */
        .prompt-meta { display: flex; align-items: center; justify-content: space-between; margin-top: 4px; }
        .meta-badges { display: flex; gap: 4px; align-items: center; }
        .tag-chip { 
            background: rgba(255,255,255,0.08); color: var(--text-tertiary); 
            padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 500;
            white-space: nowrap; max-width: 80px; overflow: hidden; text-overflow: ellipsis;
        }
        .tag-chip.more { background: transparent; color: var(--text-tertiary); padding: 0 2px; }

        .prompt-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
        .tag-badge { 
            font-size: 12px; padding: 4px 10px; border-radius: 6px; 
            background: var(--accent-dim); color: var(--accent);
            border: 1px solid var(--accent-glow); font-weight: 500;
            display: inline-block;
        }
        /* Tag Suggestions */
        .suggestion-chip {
            border: 1px dashed var(--text-tertiary); color: var(--text-secondary);
            background: transparent; padding: 2px 8px; border-radius: 4px; font-size: 10px;
            cursor: pointer; opacity: 0.7; transition: all 0.2s;
        }
        .suggestion-chip:hover { opacity: 1; border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }


        .var-badge {
            font-size: 10px; font-family: var(--font-mono); color: var(--accent); 
            background: var(--accent-dim); padding: 1px 4px; border-radius: 4px;
            display: inline-flex; align-items: center; height: 16px;
        }
        .meta-time { font-size: 11px; color: var(--text-tertiary); }
        
        .prompt-item.active .tag-chip { background: var(--accent-dim); color: var(--accent); }
        .prompt-item.active .meta-time { color: var(--text-secondary); }

        /* Interactive Chips */
        .tag-chip, .tag-badge, .pack-chip, .clickable-label { cursor: pointer; }
        .tag-chip:hover, .tag-badge:hover, .pack-chip:hover, .clickable-label:hover { opacity: 0.8; text-decoration: underline; }

        /* Pack Chips in List */
        .pack-chip {
            background: rgba(255, 159, 10, 0.15); color: var(--warning);
            border: 1px solid rgba(255, 159, 10, 0.2);
            padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;
            white-space: nowrap; max-width: 80px; overflow: hidden; text-overflow: ellipsis;
            margin-right: 4px; display: inline-block;
        }

        /* Usage Stats */
        #usage-stats {
            margin-top: 8px; font-size: 11px; color: var(--text-tertiary);
            display: flex; align-items: center; gap: 6px; font-weight: 500;
        }

        /* --- Editor --- */
        #editor-title {
            width: 100%; background: transparent; border: none; color: var(--text-primary);
            font-size: 26px; font-weight: 700; padding: 12px 0; margin-bottom: 8px; letter-spacing: -0.02em;
        }
        #editor-body {
            width: 100%; flex: 1; background: transparent; border: none; color: var(--text-primary);
            padding: 0; font-family: var(--font-mono); font-size: 15px; line-height: 1.6; resize: none;
        }
        #editor-status { 
            font-size: 11px; color: var(--text-tertiary); margin-top: 12px; padding-top: 12px;
            border-top: 1px solid var(--border); display: flex; justify-content: space-between; 
            font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em;
        }

        /* --- Meta --- */
        .meta-section { margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 16px; }
        .meta-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        
        .meta-label { 
            font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; 
            color: var(--text-tertiary); font-weight: 700; display: flex; align-items: center;
            cursor: pointer; user-select: none; padding: 4px 0;
            transition: color 0.2s;
        }
        .meta-label:hover { color: var(--text-secondary); }
        
        .meta-label .chevron { 
            transition: transform 0.2s; opacity: 0.5; margin-left: auto; width: 14px; height: 14px; 
        }
        .meta-section.collapsed .chevron { transform: rotate(-90deg); }
        .meta-section.collapsed .meta-content { display: none; }
        
        .meta-value-preview { 
            font-weight: 600; color: var(--accent); margin-left: 12px; font-size: 11px; 
            opacity: 0.9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; 
            text-transform: none; letter-spacing: normal;
        }
        
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 10px 16px; border-radius: var(--radius-sm); font-weight: 600;
            cursor: pointer; border: none; transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1);
            font-size: 13px; width: 100%; margin-bottom: 8px; text-decoration: none; user-select: none;
        }
        .btn:active { transform: scale(0.97); }
        .btn-icon { width: 32px; height: 32px; padding: 0; border-radius: 50%; width: auto; min-width: 32px; }
        .btn-sm { padding: 4px 8px; font-size: 11px; width: auto; margin: 0; }
        
        .btn-primary { background: var(--accent-gradient); color: white; box-shadow: 0 4px 15px var(--accent-dim); }
        .btn-primary:hover { box-shadow: 0 6px 20px var(--accent-glow); transform: translateY(-1px); }
        
        .btn-secondary { background: rgba(255,255,255,0.05); color: var(--text-primary); border: 1px solid rgba(255,255,255,0.05); }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.1); }
        
        .btn-ghost { background: transparent; color: var(--text-secondary); margin: 0; padding: 4px;}
        .btn-ghost:hover { background: rgba(255,255,255,0.05); color: var(--text-primary); }
        
        .btn-danger { background: rgba(255, 69, 58, 0.1); color: var(--danger); border: 1px solid rgba(255, 69, 58, 0.2); margin-bottom: 0; }
        .btn-danger:hover { background: rgba(255, 69, 58, 0.2); box-shadow: 0 0 15px rgba(255, 69, 58, 0.1); }

        /* Glass Square Button (New) */
        .btn-glass-square {
            width: 40px; height: 40px; padding: 0;
            border-radius: 10px;
            display: inline-flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.05);
            color: var(--text-secondary);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
        }
        .btn-glass-square:hover {
            background: var(--accent-dim);
            border-color: var(--accent-glow);
            color: var(--accent);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px var(--accent-dim);
        }
        .btn-glass-square:active { transform: scale(0.95); }

        /* Visibility of Info Button on Desktop when collapsed */
        .right-panel-toggle { display: none; }
        @media (max-width: 1024px) { .right-panel-toggle { display: flex !important; } }
        #app.meta-collapsed .right-panel-toggle { display: flex !important; }

        .btn-group { display: flex; gap: 8px; }
        .btn-group .btn { margin-bottom: 0; }

        .form-input { 
            width: 100%; padding: 10px 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-light);
            color: var(--text-primary); border-radius: var(--radius-sm); font-size: 14px; transition: border 0.2s;
        }
        .form-input:focus { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent-dim); }
        textarea.form-input { font-family: var(--font-sans); line-height: 1.4; resize: vertical; min-height: 80px; }
        
        /* Intent Select */
        .intent-select {
            width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-light);
            color: var(--text-primary); border-radius: var(--radius-sm); font-size: 13px; margin-bottom: 8px;
            cursor: pointer;
        }

        .variable-preview {
            background: var(--accent-dim); padding: 8px 12px; border-radius: var(--radius-sm);
            font-family: var(--font-mono); font-size: 12px; margin-bottom: 6px; color: var(--accent);
            border: 1px solid var(--accent-glow); display: inline-block; margin-right: 4px;
        }

        /* --- Packs & Versions --- */
        .checkbox-list { display: flex; flex-direction: column; gap: 4px; max-height: 140px; overflow-y: auto; margin-bottom: 8px; }
        .checkbox-item { 
            display: flex; align-items: center; gap: 10px; font-size: 13px; padding: 8px; 
            border-radius: var(--radius-sm); cursor: pointer; transition: background 0.2s;
        }
        .checkbox-item:hover { background: rgba(255,255,255,0.05); }
        input[type="checkbox"] { accent-color: var(--accent); width: 16px; height: 16px; cursor: pointer; }

        .version-item { 
            font-size: 12px; padding: 10px; border-bottom: 1px solid var(--border); 
            color: var(--text-secondary); transition: background 0.2s; display: flex; flex-direction: column; gap: 4px;
            cursor: pointer; /* Added cursor pointer */
        }
        .version-item:hover { background: rgba(255,255,255,0.05); color: var(--text-primary); }
        .version-header { display: flex; justify-content: space-between; align-items: center; }
        .version-date { color: var(--accent); font-weight: 600; }
        .version-diff { font-family: var(--font-mono); font-size: 10px; opacity: 0.7; }
        .version-actions { display: flex; gap: 6px; margin-top: 6px; opacity: 0.6; transition: opacity 0.2s; }
        .version-item:hover .version-actions { opacity: 1; }
        .v-btn { font-size: 10px; padding: 2px 6px; background: rgba(255,255,255,0.1); border-radius: 4px; cursor: pointer; border:none; color: var(--text-secondary); }
        .v-btn:hover { background: rgba(255,255,255,0.2); color: white; }
        .v-btn.danger:hover { background: var(--danger); }

        /* --- Modals --- */
        dialog {
            background: #151518; color: var(--text-primary); border: 1px solid var(--border-light);
            border-radius: var(--radius-lg); padding: 0; max-width: 450px; width: 90%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7); animation: slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        dialog::backdrop { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); }
        
        .dialog-header { padding: 20px; border-bottom: 1px solid var(--border); font-weight: 600; display: flex; justify-content: space-between; align-items: center; font-size: 16px; color: var(--accent); }
        .dialog-body { padding: 24px 20px; max-height: 60vh; overflow-y: auto; overflow-x: hidden; } /* Ensure dropdown visibility if needed, but here we constrain body */
        .dialog-footer { padding: 16px 20px; background: rgba(255,255,255,0.02); border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 13px; color: var(--text-secondary); }

        /* Manage Packs List */
        .manage-pack-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid var(--border); }
        .manage-pack-item:last-child { border-bottom: none; }
        .pack-actions { display: flex; gap: 8px; }
        .pack-link { cursor: pointer; color: var(--accent); text-decoration: none; }
        .pack-link:hover { text-decoration: underline; }

        /* Import Stats Styling */
        .import-stat-group { margin-bottom: 20px; }
        .import-stat-title { font-size: 14px; font-weight: 700; color: var(--accent); margin-bottom: 8px; display: flex; justify-content: space-between;}
        .import-stat-item { font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; display: flex; align-items: center; justify-content: space-between; padding: 4px 8px; background: rgba(255,255,255,0.03); border-radius: 4px; }
        .stat-badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .stat-new { background: rgba(50, 215, 75, 0.2); color: var(--success); }
        .stat-update { background: rgba(10, 132, 255, 0.2); color: var(--accent); }
        .stat-conflict { background: rgba(255, 69, 58, 0.2); color: var(--danger); }
        
        .strategy-select {
            width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-light);
            color: var(--text-primary); border-radius: 6px; font-size: 12px; margin-top: 4px;
        }

        /* Tag Manager Styling */
        .tag-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .tag-row:last-child { border-bottom: none; }
        .tag-info { font-size: 14px; }
        .tag-count { color: var(--text-tertiary); font-size: 12px; margin-left: 6px; }
        .tag-actions { display: flex; gap: 6px; }
        
        .search-help-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .search-help-table td { padding: 6px 0; border-bottom: 1px solid var(--border); color: var(--text-secondary); }
        .search-help-table td:first-child { color: var(--accent); font-family: var(--font-mono); padding-right: 12px; }
        .search-help-table tr:last-child td { border-bottom: none; }

        /* Autocomplete Styles */
        .autocomplete-wrapper { position: relative; }
        .autocomplete-dropdown {
            position: absolute; top: 100%; left: 0; right: 0;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius-sm); z-index: 100;
            max-height: 150px; overflow-y: auto; display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5); margin-top: 4px;
        }
        .autocomplete-item {
            padding: 8px 12px; font-size: 13px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .autocomplete-item:hover, .autocomplete-item.selected {
            background: var(--accent-dim); color: #fff;
        }
        .autocomplete-item .count { color: var(--text-tertiary); font-size: 11px; }
        .autocomplete-item:hover .count, .autocomplete-item.selected .count { color: rgba(255,255,255,0.8); }
        
        /* Pack Picker List Item */
        .pack-picker-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px; border-bottom: 1px solid var(--border); cursor: pointer; 
            border-radius: var(--radius-sm); transition: background 0.2s;
        }
        .pack-picker-item:last-child { border-bottom: none; }
        .pack-picker-item:hover { background: rgba(255,255,255,0.05); }

        /* Marketplace Overhaul (App Store Style) */
        #dialog-marketplace {
            width: 90vw; max-width: 1100px; height: 85vh; max-height: 900px;
            border-radius: 16px; overflow: hidden;
            padding: 0; background: #000; border: 1px solid var(--border-light);
            box-shadow: 0 50px 100px -20px rgba(0,0,0,0.9);
        }
        
        /* Apply flex display only when open */
        #dialog-marketplace[open] {
            display: flex;
            flex-direction: column;
        }

        .mp-layout { display: grid; grid-template-columns: 240px 1fr; height: 100%; overflow: hidden; }
        .mp-sidebar {
            background: rgba(30, 30, 35, 0.6); border-right: 1px solid var(--border);
            padding: 24px 16px; display: flex; flex-direction: column; gap: 4px;
            backdrop-filter: blur(50px);
        }
        .mp-nav-item {
            padding: 10px 16px; border-radius: 8px; color: var(--text-secondary);
            cursor: pointer; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 12px;
            transition: all 0.2s;
        }
        .mp-nav-item:hover { background: rgba(255,255,255,0.05); color: var(--text-primary); }
        .mp-nav-item.active { background: rgba(255,255,255,0.1); color: var(--text-primary); }
        .mp-nav-item svg { width: 20px; height: 20px; opacity: 0.8; }
        .mp-nav-header {
            font-size: 11px; font-weight: 700; color: var(--text-tertiary); text-transform: uppercase;
            padding: 0 16px; margin-top: 24px; margin-bottom: 8px; letter-spacing: 0.05em;
        }

        .mp-content {
            overflow-y: auto; padding: 0; position: relative;
            background: radial-gradient(circle at top right, rgba(20, 30, 40, 0.4), transparent 50%);
        }
        .mp-scroll-container { padding: 32px 40px; max-width: 1000px; margin: 0 auto; padding-bottom: 80px; }

        /* Components */
        /* === AI Marketplace Hero (Animated) === */

.mp-hero {
    width: 100%;
    height: 340px;
    border-radius: 18px;
    position: relative;
    overflow: hidden;
    margin-bottom: 40px;
    padding: 44px;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    cursor: pointer;

    /* Base animated gradient */
    background:
        radial-gradient(1200px 600px at 10% 10%, rgba(56,189,248,.35), transparent 40%),
        radial-gradient(800px 500px at 90% 20%, rgba(99,102,241,.35), transparent 45%),
        radial-gradient(900px 600px at 50% 90%, rgba(168,85,247,.25), transparent 50%),
        linear-gradient(135deg, #020617, #020617);

    animation: heroShift 18s ease-in-out infinite alternate;
    box-shadow: 0 30px 80px rgba(0,0,0,.6);
    border: 1px solid rgba(255,255,255,.12);
}

/* Glow Orbs */
.mp-hero::before,
.mp-hero::after {
    content: "";
    position: absolute;
    inset: -40%;
    background:
        radial-gradient(circle, rgba(56,189,248,.25), transparent 40%);
    filter: blur(80px);
    animation: floatGlow 22s linear infinite;
    pointer-events: none;
}

.mp-hero::after {
    background:
        radial-gradient(circle, rgba(168,85,247,.25), transparent 45%);
    animation-duration: 30s;
}

/* Scanline shimmer */
.mp-hero-scan {
    position: absolute;
    inset: 0;
    background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,.04),
        rgba(255,255,255,.04) 1px,
        transparent 1px,
        transparent 6px
    );
    mix-blend-mode: overlay;
    opacity: .15;
    pointer-events: none;
}

/* Content */
.mp-hero-content {
    position: relative;
    z-index: 3;
    max-width: 900px;
}

.mp-hero-tag {
    font-size: 11px;
    font-weight: 800;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: rgba(255,255,255,.7);
    margin-bottom: 10px;
}

.mp-hero-title {
    font-size: 42px;
    font-weight: 900;
    line-height: 1.05;
    letter-spacing: -0.03em;
    background: linear-gradient(90deg, #fff, #93c5fd);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    margin-bottom: 12px;
}

.mp-hero-desc {
    font-size: 17px;
    line-height: 1.6;
    color: rgba(255,255,255,.85);
    max-width: 520px;
}

/* Animations */
@keyframes heroShift {
    0% { background-position: 0% 0%; }
    100% { background-position: 100% 100%; }
}

@keyframes floatGlow {
    from { transform: translate3d(-10%, -10%, 0); }
    to   { transform: translate3d(10%, 10%, 0); }
}


        .mp-section-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; margin-top: 40px; border-bottom: 1px solid var(--border); padding-bottom: 12px;}
        .mp-section-header:first-of-type { margin-top: 0; }
        .mp-section-title { font-size: 22px; font-weight: 700; color: var(--text-primary); letter-spacing: -0.01em; }
        .mp-section-link { color: var(--accent); font-size: 14px; cursor: pointer; text-decoration: none; font-weight: 500; }
        .mp-section-link:hover { text-decoration: underline; }

        .app-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 24px; }
        .app-card-row {
            display: flex; gap: 16px; align-items: center; padding: 16px; border-bottom: 1px solid var(--border-light);
            cursor: pointer; transition: all 0.2s; border-radius: 16px; background: var(--bg-card); border: 1px solid var(--border);
        }
        .app-card-row:hover { background: rgba(255,255,255,0.08); transform: translateY(-2px); border-color: var(--border-accent); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .app-icon {
            width: 72px; height: 72px; border-radius: 18px; background: #333; flex-shrink: 0; object-fit: cover;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .app-info { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
        .app-title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .app-subtitle { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .app-meta { font-size: 11px; color: var(--text-tertiary); margin-top: 6px; display: flex; gap: 8px; align-items: center; }
        .app-badge { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-weight: 600; }

        .get-btn {
            background: rgba(10, 132, 255, 0.15); color: var(--accent); font-weight: 700; font-size: 13px;
            padding: 8px 24px; border-radius: 20px; border: none; cursor: pointer; text-transform: uppercase;
            transition: all 0.2s; min-width: 80px; text-align: center; letter-spacing: 0.03em;
        }
        .get-btn:hover { background: var(--accent); color: #fff; transform: scale(1.05); }
        .get-btn.installed { background: rgba(255,255,255,0.08); color: var(--text-tertiary); cursor: default; }
        .get-btn.installed:hover { background: rgba(255,255,255,0.08); color: var(--text-tertiary); transform: none; }
        .get-btn.update { background: var(--accent); color: #fff; }
        .get-btn.remove { background: rgba(255, 69, 58, 0.1); color: var(--danger); }
        .get-btn.remove:hover { background: var(--danger); color: white; }

        /* Details View in Sidebar */
        .mp-details-view { animation: fadeIn 0.3s ease; }
        .mp-details-header { display: flex; gap: 32px; margin-bottom: 40px; align-items: flex-start; }
        .mp-details-icon { width: 140px; height: 140px; border-radius: 32px; background: #333; box-shadow: 0 10px 40px rgba(0,0,0,0.5); object-fit: cover; }
        .mp-details-info { flex: 1; display: flex; flex-direction: column; justify-content: flex-start; padding-top: 10px; }
        .mp-details-title { font-size: 32px; font-weight: 800; color: var(--text-primary); margin-bottom: 8px; letter-spacing: -0.02em; }
        .mp-details-author { font-size: 16px; color: var(--text-secondary); margin-bottom: 24px; }
        .mp-details-desc { font-size: 16px; line-height: 1.6; color: var(--text-secondary); white-space: pre-wrap; margin-bottom: 40px; max-width: 800px; }
        .mp-back-btn { display: inline-flex; align-items: center; gap: 6px; color: var(--accent); cursor: pointer; margin-bottom: 24px; font-size: 15px; font-weight: 500; opacity: 0.8; transition: opacity 0.2s; }
        .mp-back-btn:hover { opacity: 1; text-decoration: underline; }
        
        .mp-actions-bar { display: flex; gap: 12px; margin-top: auto; }
        
        .mp-close-btn { 
            position: absolute; top: 20px; right: 20px; width: 32px; height: 32px; 
            border-radius: 50%; background: rgba(255,255,255,0.1); color: #fff; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; border: none;
            z-index: 10;
        }
        .mp-close-btn:hover { background: rgba(255,255,255,0.2); }

        /* Marketplace Prompt Preview */
        .mp-prompt-list {
            display: flex; flex-direction: column; background: rgba(255,255,255,0.02);
            border-radius: 12px; border: 1px solid var(--border); overflow: hidden; margin-top: 16px;
        }
        .mp-prompt-row {
            padding: 12px 16px; border-bottom: 1px solid var(--border-light); display: flex; gap: 12px;
        }
        .mp-prompt-row:last-child { border-bottom: none; }
        .mp-p-icon { color: var(--accent); opacity: 0.7; margin-top: 2px; }
        .mp-p-content { flex: 1; min-width: 0; }
        .mp-p-title { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 2px; }
        .mp-p-desc { font-size: 12px; color: var(--text-tertiary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Dashboard Styles - Enhanced */
        #dashboard-panel { display: none; padding: 32px; overflow-y: auto; background: var(--bg-body); }
        .dashboard-header { margin-bottom: 32px; display: flex; justify-content: space-between; align-items: flex-end; }
        .dashboard-welcome { font-size: 28px; font-weight: 800; color: var(--text-primary); letter-spacing: -0.02em; margin-bottom: 4px; background: linear-gradient(90deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
        .dashboard-date { color: var(--text-tertiary); font-size: 14px; font-weight: 500; }
        
        .dashboard-section-title { font-size: 14px; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 40px; }
        
        .stat-card { 
            background: linear-gradient(145deg, rgba(44, 44, 46, 0.4), rgba(30, 30, 32, 0.6));
            backdrop-filter: blur(10px);
            padding: 24px; border-radius: var(--radius-lg); 
            border: 1px solid var(--border-light);
            border-left: 4px solid var(--accent);
            display: flex; flex-direction: column; justify-content: space-between;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            min-height: 120px;
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); border-color: rgba(255,255,255,0.15); border-left-color: var(--accent-glow); }

        .stat-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .stat-icon { width: 32px; height: 32px; color: var(--accent); opacity: 0.8; background: var(--accent-dim); padding: 6px; border-radius: 8px; }
        .stat-value { font-size: 32px; font-weight: 800; color: var(--text-primary); line-height: 1; letter-spacing: -0.02em; }
        .stat-label { font-size: 13px; color: var(--text-secondary); font-weight: 500; margin-top: 4px; }

        /* Quick Access Cards */
        .qa-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-bottom: 40px; }
        .qa-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md);
            padding: 16px; display: flex; flex-direction: column; gap: 8px;
            transition: all 0.2s; cursor: pointer;
        }
        .qa-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .qa-title { font-weight: 600; color: var(--text-primary); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .qa-actions { display: flex; gap: 8px; margin-top: 8px; }

        /* Diff View - Enhanced */
        .diff-list { display: flex; flex-direction: column; gap: 16px; }
        .diff-container { 
            background: rgba(20, 20, 22, 0.6); 
            border-radius: var(--radius-md); 
            border: 1px solid var(--border); 
            overflow: hidden; 
        }
        .diff-header { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px; 
            background: rgba(255,255,255,0.03); 
            border-bottom: 1px solid var(--border-light);
            font-size: 13px; 
        }
        .diff-title { font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
        .diff-time { color: var(--text-tertiary); font-size: 12px; }
        .diff-content { 
            padding: 12px 16px; 
            font-family: var(--font-mono); 
            font-size: 13px; 
            line-height: 1.5; 
            overflow-x: auto;
        }
        .diff-line { white-space: pre-wrap; display: flex; }
        .diff-add { color: #81b0ff; background: rgba(10, 132, 255, 0.1); display: block; border-radius: 2px;} 
        .diff-rem { color: var(--text-tertiary); text-decoration: line-through; opacity: 0.6; display: block; }

        /* Run Button */
        .btn-run { background: rgba(10, 132, 255, 0.1); color: var(--accent); border: 1px solid rgba(10, 132, 255, 0.3); }
        .btn-run:hover { background: rgba(10, 132, 255, 0.2); box-shadow: 0 0 10px rgba(10, 132, 255, 0.1); }

        /* Meta Panel Tabs */
        .meta-persistent {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-panel);
            flex-shrink: 0;
            z-index: 5;
        }
        .meta-tabs {
            display: flex;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .tab-btn {
            flex: 1;
            padding: 12px 0;
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        .tab-btn:hover { color: var(--text-primary); background: rgba(255,255,255,0.02); }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
        
        .meta-tab-content { display: none; padding-top: 8px; animation: fadeIn 0.2s ease; }
        .meta-tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Danger Zone in Actions Tab */
        .danger-zone {
            padding: 16px;
            border: 1px solid rgba(255, 69, 58, 0.2);
            background: rgba(255, 69, 58, 0.05);
            border-radius: var(--radius-md);
            margin-top: 16px;
        }
        .danger-title { color: var(--danger); font-weight: 600; font-size: 13px; margin-bottom: 8px; }
        .danger-desc { color: var(--text-secondary); font-size: 12px; margin-bottom: 12px; line-height: 1.4; }

        /* Toast using Popover API (or fallback) */
        #toast {
            position: fixed; 
            bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(30, 30, 30, 0.9); backdrop-filter: blur(10px); border: 1px solid var(--border-light);
            color: var(--text-primary); padding: 12px 24px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-size: 14px; font-weight: 500; 
            display: flex; align-items: center; gap: 10px;
            
            width: max-content;
            max-width: 90vw;

            /* Popover Reset */
            margin: 0; border-width: 1px;
            opacity: 0; transition: opacity 0.3s, transform 0.3s;
            transform: translateX(-50%) translateY(20px);
            pointer-events: none; /* Let clicks pass when hidden, though popover handles this */
            z-index: 1000;
        }
        
        /* Fix for browser popover default styles overriding positioning */
        #toast:popover-open { 
            opacity: 1; 
            /* Reset UA centering */
            inset: auto;
            margin: 0;
            top: auto;
            right: auto;
            /* Re-apply desired positioning */
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(0); 
        }
        
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); } /* Fallback class */
        #toast.error { border-color: var(--danger); color: var(--danger); }
        
        .flex-row { display: flex; gap: 8px; align-items: center; }
        .right-panel-toggle { display: none; }
        .mobile-only { display: none; }
    </style>
</head>
<body>

<div id="app">
    <!-- Left: Sidebar -->
    <div id="sidebar" class="panel">
        <div class="panel-header">
            <span class="panel-title" style="color:var(--accent);">PromptVault</span>
            <button class="btn btn-secondary btn-icon" onclick="app.toggleCollapse()" title="Collapse/Expand">
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
            </button>
            <div class="resizer" id="sidebar-resizer"></div>
        </div>
        
        <!-- Collapsed Icons -->
        <div class="collapsed-icon" onclick="app.toggleCollapse()" title="Expand"><svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></div>
        <div class="collapsed-icon" onclick="app.createNewPrompt()" title="New Prompt"><svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg></div>
        <div class="collapsed-icon" onclick="app.toggleDashboard()" title="Dashboard"><svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg></div>
        <div class="collapsed-icon" onclick="Marketplace.open()" title="Store"><svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg></div>
        <div class="collapsed-icon" onclick="document.getElementById('dialog-settings').showModal()" title="Settings"><svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg></div>

        <div id="search-container">
            <input type="text" id="search-input" placeholder="Search prompts..." oninput="app.handleSearch(this.value)">
            <div id="search-clear" onclick="app.clearSearch()">âœ•</div>
            <div id="search-help-btn" onclick="document.getElementById('dialog-search-help').showModal()">?</div>
        </div>
        <div id="quick-filters">
            <div class="filter-chip" data-filter="untagged" onclick="app.toggleFilter('untagged')">Untagged</div>
            <div class="filter-chip" data-filter="hasVars" onclick="app.toggleFilter('hasVars')">Has Vars</div>
            <div class="filter-chip" data-filter="recent" onclick="app.toggleFilter('recent')">Recent</div>
            <div class="filter-chip" data-filter="used" onclick="app.toggleFilter('used')">Used</div>
        </div>
        <div class="panel-content" id="prompt-list"></div>
        <div class="panel-footer">
            <div class="flex-row" style="margin-bottom:8px;">
                <button class="btn-glass-square"
        onclick="app.toggleDashboard()"
        title="Dashboard"
        style="margin-right:4px; flex:1">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <defs>
            <linearGradient id="pvbDash" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#38bdf8"/>
                <stop offset="100%" stop-color="#2563eb"/>
            </linearGradient>
            <filter id="pvbGlow" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur stdDeviation="1.5" result="blur"/>
                <feMerge>
                    <feMergeNode in="blur"/>
                    <feMergeNode in="SourceGraphic"/>
                </feMerge>
            </filter>
        </defs>
        <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
              stroke="url(#pvbDash)"
              stroke-width="2.1"
              stroke-linecap="round"
              stroke-linejoin="round"
              filter="url(#pvbGlow)"/>
    </svg>
</button>

<button class="btn-glass-square"
        onclick="app.createNewPrompt()"
        title="New Prompt"
        style="flex:1">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
        <defs>
            <linearGradient id="pvbPlus" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#22d3ee"/>
                <stop offset="100%" stop-color="#0ea5e9"/>
            </linearGradient>
            <filter id="pvbGlow2" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur stdDeviation="1.5" result="blur"/>
                <feMerge>
                    <feMergeNode in="blur"/>
                    <feMergeNode in="SourceGraphic"/>
                </feMerge>
            </filter>
        </defs>
        <path d="M12 4v16m8-8H4"
              stroke="url(#pvbPlus)"
              stroke-width="2.4"
              stroke-linecap="round"
              filter="url(#pvbGlow2)"/>
    </svg>
<button class="btn btn-secondary"
        onclick="Marketplace.open()"
        style="
            flex:1;
            margin-bottom:0;
            display:flex;
            align-items:center;
            gap:10px;
            padding:8px 12px;
        ">
    <span style="
        width:22px;
        height:22px;
        border-radius:6px;
        display:flex;
        align-items:center;
        justify-content:center;
        background:linear-gradient(135deg,#38bdf8,#2563eb);
        box-shadow:0 0 10px rgba(56,189,248,.35);
        font-size:14px;
    ">
        ðŸ›ï¸
    </span>

    <span style="
        font-weight:500;
        letter-spacing:.2px;
        background:linear-gradient(135deg,#e5e7eb,#93c5fd);
        -webkit-background-clip:text;
        background-clip:text;
        color:transparent;
    ">
        Marketplace
    </span>
</button>


<button class="btn btn-secondary btn-icon"
        onclick="document.getElementById('dialog-settings').showModal()"
        title="Settings"
        style="margin-bottom:0;">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
        <defs>
            <linearGradient id="pvbSettings" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#38bdf8"/>
                <stop offset="100%" stop-color="#0ea5e9"/>
            </linearGradient>
            <filter id="pvbSettingsGlow" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur stdDeviation="1.4" result="blur"/>
                <feMerge>
                    <feMergeNode in="blur"/>
                    <feMergeNode in="SourceGraphic"/>
                </feMerge>
            </filter>
        </defs>
        <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
              stroke="url(#pvbSettings)"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              filter="url(#pvbSettingsGlow)"/>
        <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              stroke="url(#pvbSettings)"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              filter="url(#pvbSettingsGlow)"/>
    </svg>
</button>

            </div>
        </div>
    </div>

    <!-- Center: Editor -->
    <div id="editor-panel" class="panel">
        <div class="panel-header" id="editor-header">
<a href="/projects/" class="btn btn-secondary" style="width:auto; padding:8px 12px;">
    â† Back to Projects
</a>

            <div class="flex-row">
                <button class="btn btn-secondary mobile-only" onclick="app.toggleSidebar()" style="width: auto;">
                    <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                </button>
                <span id="editor-status-text" style="color: var(--text-secondary); font-size: 13px; font-weight: 500;">Editor</span>
            </div>
            <div class="flex-row">
                 <button class="btn btn-primary" onclick="app.saveCurrentPrompt(false)" style="width: auto; padding: 8px 16px;">Save</button>
                 <button class="btn btn-secondary right-panel-toggle" onclick="app.toggleMetaPanel()" style="width: auto; padding: 8px 12px;">Info</button>
            </div>
        </div>
        <div class="panel-content" style="display: flex; flex-direction: column;">
            <input type="text" id="editor-title" placeholder="Untitled Prompt" oninput="app.markDirty()">
            <textarea id="editor-body" placeholder="Start typing your prompt... Use {{variable}} for dynamic placeholders." oninput="app.handleBodyInput()"></textarea>
            <div id="editor-status">
                <span id="word-count">0 words</span>
                <span id="last-saved">Unsaved</span>
            </div>
        </div>
    </div>

    <!-- Dashboard Panel (NEW) -->
    <div id="dashboard-panel" class="panel">
        <div class="panel-header">
            <span class="panel-title" style="color:var(--accent);">Dashboard</span>
        </div>
        <div class="panel-content">
            <div class="dashboard-header">
                <div>
                    <div class="dashboard-welcome" id="dashboard-welcome">Hello</div>
                    <div class="dashboard-date" id="dashboard-date"></div>
                </div>
            </div>

            <div class="dashboard-section-title">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                Overview
            </div>
            
            <div class="dashboard-grid">
                <!-- Total Prompts -->
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg></div>
                    </div>
                    <div>
                        <div class="stat-value" id="stat-total">0</div>
                        <div class="stat-label">Total Prompts</div>
                    </div>
                </div>
                <!-- Used This Week -->
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></div>
                    </div>
                    <div>
                        <div class="stat-value" id="stat-used-week">0</div>
                        <div class="stat-label">Used This Week</div>
                    </div>
                </div>
                <!-- Most Used -->
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg></div>
                    </div>
                    <div>
                        <div class="stat-value" id="stat-most-used">-</div>
                        <div class="stat-label">Most Used Count</div>
                    </div>
                </div>
                <!-- Never Used -->
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="color:var(--text-tertiary); background:rgba(255,255,255,0.05);"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg></div>
                    </div>
                    <div>
                        <div class="stat-value" id="stat-never-used">0</div>
                        <div class="stat-label">Never Used</div>
                    </div>
                </div>
            </div>

            <!-- Quick Access (Pinned) -->
            <div id="quick-access-section" style="display:none;">
                <div class="dashboard-section-title" style="margin-top: 32px;">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M16 12V4h1V2H7v2h1v8l-2 2v2h5v6l1 1 1-1v-6h5v-2l-2-2z"/></svg>
                    Quick Access
                </div>
                <div class="qa-grid" id="quick-access-list"></div>
            </div>
            
            <div class="dashboard-section-title" style="margin-top: 32px;">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Recent Activity
            </div>
            <div id="dashboard-diffs" class="diff-list"></div>
        </div>
    </div>

    <!-- Right: Meta (Refactored) -->
    <div id="meta-panel" class="panel">
        <div class="panel-header">
            <span class="panel-title">Properties</span>
            <button class="btn btn-ghost btn-icon" onclick="app.toggleMetaPanel()">âœ•</button>
        </div>
        
        <!-- Persistent Action Bar (Sticky) -->
        <div class="meta-persistent">
            <div class="flex-row" style="gap: 8px;">
                <button class="btn btn-primary" style="height: 3.5rem; font-size: 1.05rem; flex:2;" onclick="app.triggerCopy()">
                   Copy
                </button>
                <button class="btn btn-run" style="height: 3.5rem; font-size: 1.05rem; flex:1;" onclick="app.runPrompt()" title="Run Prompt in Browser">
                   Run 
                </button>
            </div>
            <div id="detected-vars" style="margin-top: 10px;"></div>
            <!-- Feature 2: Usage Stats Container -->
            <div id="usage-stats"></div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="meta-tabs">
            <button class="tab-btn active" onclick="app.switchMetaTab('overview')">Overview</button>
            <button class="tab-btn" onclick="app.switchMetaTab('behavior')">Behavior</button>
            <button class="tab-btn" onclick="app.switchMetaTab('history')">History</button>
            <button class="tab-btn" onclick="app.switchMetaTab('actions')">Actions</button>
        </div>

        <div class="panel-content" id="meta-content-area" style="padding-top: 8px;">
            <!-- Tab: Overview -->
            <div id="tab-overview" class="meta-tab-content active">
                <div class="meta-section" id="sec-tags">
                    <div class="meta-label" onclick="app.toggleSection('sec-tags')">
                        <span>Tags</span>
                        <svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </div>
                    <div class="meta-content">
                        <input type="text" id="tags-input" class="form-input" placeholder="Add tags..." onchange="app.updateTags(this.value)">
                        <div id="tag-suggestions" style="display:flex; flex-wrap:wrap; gap:6px; margin-top:8px;"></div>
                        <div id="active-tags" class="prompt-tags" style="margin-top: 8px;"></div>
                    </div>
                </div>

                <div class="meta-section" id="sec-notes">
                    <div class="meta-label" onclick="app.toggleSection('sec-notes')">
                        <span>Notes & Reference</span>
                        <svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </div>
                    <div class="meta-content">
                        <textarea id="notes-input" class="form-input" placeholder="Add usage tips, context, or reminders..." oninput="app.markDirty()"></textarea>
                    </div>
                </div>

                <div class="meta-section" id="sec-packs">
                    <div class="meta-label" onclick="app.toggleSection('sec-packs')">
                        <span>Prompt Packs</span>
                        <span class="meta-value-preview" id="preview-packs"></span>
                        <svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </div>
                    <div class="meta-content">
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                            <button class="btn-ghost" onclick="app.openManagePacks()">Manage</button>
                            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('dialog-pack').showModal()">+ New Pack</button>
                        </div>
                        <div id="packs-list" class="checkbox-list"></div>
                    </div>
                </div>
            </div>

            <!-- Tab: Behavior -->
            <div id="tab-behavior" class="meta-tab-content">
                <!-- Run Target Config -->
                <div class="meta-section" id="sec-run-target">
                    <div class="meta-label" onclick="app.toggleSection('sec-run-target')">
                        <span>Run Target</span>
                        <span class="meta-value-preview" id="preview-run-target">Default</span>
                        <svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </div>
                    <div class="meta-content">
                        <select id="run-target-select" class="intent-select" onchange="app.updateRunTarget(this.value)">
    <option value="">Custom URL...</option>

    <optgroup label="Open & paste (reliable)">
        <option value="https://chatgpt.com/">ChatGPT</option>
        <option value="https://gemini.google.com/app">Google Gemini</option>
        <option value="https://claude.ai/new">Claude</option>
        <option value="https://copilot.microsoft.com/">Microsoft Copilot</option>
    </optgroup>

    <optgroup label="Prefill (if supported)">
        <option value="https://www.perplexity.ai/search?q={{prompt}}">Perplexity</option>
    </optgroup>

    <optgroup label="Legacy templates">
        <option value="https://chatgpt.com/?q={{prompt}}">ChatGPT (legacy)</option>
        <option value="https://chat.openai.com/?q={{prompt}}">ChatGPT (legacy openai)</option>
        <option value="https://gemini.google.com/app?q={{prompt}}">Gemini (legacy)</option>
        <option value="https://claude.ai/new?q={{prompt}}">Claude (legacy)</option>
        <option value="https://copilot.microsoft.com/?q={{prompt}}">Copilot (legacy)</option>
    </optgroup>
</select>
                        <input type="text" id="run-target-input" class="form-input" placeholder="https://site.com/?q={{prompt}}" onchange="app.saveRunTargetCustom(this.value)" style="margin-top:4px; font-family:var(--font-mono); font-size:11px;">
                    </div>
                </div>

                <!-- Intent -->
                <div class="meta-section" id="sec-intent">
                    <div class="meta-label" onclick="app.toggleSection('sec-intent')">
                        <span>Intent</span>
                        <span class="meta-value-preview" id="preview-intent"></span>
                        <svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </div>
                    <div class="meta-content">
                        <select id="intent-select" class="intent-select" onchange="app.updateIntent(this.value)">
                            <option value="">Unclassified</option>
                            <option value="Generate">Generate</option>
                            <option value="Rewrite">Rewrite</option>
                            <option value="Analyze">Analyze</option>
                            <option value="Brainstorm">Brainstorm</option>
                            <option value="Summarize">Summarize</option>
                        </select>
                    </div>
                </div>
                
                <!-- Enhanced Actions -->
                <div class="meta-section" id="sec-actions">
                    <div class="meta-label" onclick="app.toggleSection('sec-actions')">
                        <span>File Actions</span>
                        <svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </div>
                    <div class="meta-content">
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="app.duplicateCurrentPrompt()" title="Duplicate Prompt">Duplicate</button>
                            <button class="btn btn-secondary" onclick="app.downloadCurrentPrompt()" title="Download as Text">Download .txt</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: History -->
            <div id="tab-history" class="meta-tab-content">
                 <div class="meta-section" id="sec-versions">
                    <div class="meta-label" onclick="app.toggleSection('sec-versions')">
                        <span>Version History</span>
                        <svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </div>
                    <div class="meta-content">
                        <div id="versions-list" style="max-height: 200px; overflow-y: auto;">
                            <div style="color: var(--text-tertiary); font-size: 13px; font-style: italic;">No history yet</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Actions -->
            <div id="tab-actions" class="meta-tab-content">
                 <div class="danger-zone">
                    <div class="danger-title">Danger Zone</div>
                    <div class="danger-desc">Deleting a prompt is permanent and cannot be undone.</div>
                    <button class="btn btn-danger" onclick="app.openDeletePromptDialog()">Delete Prompt</button>
                 </div>
            </div>
        </div>
    </div>
</div>

<!-- Dialogs -->
<dialog id="dialog-vars" onkeydown="if(event.key === 'Enter') app.finalizeCopy()">
    <div class="dialog-header">
        <span>Fill Variables</span>
        <button class="btn btn-ghost btn-icon" onclick="document.getElementById('dialog-vars').close()">âœ•</button>
    </div>
    <div class="dialog-body" id="vars-form-body"></div>
    <div class="dialog-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('dialog-vars').close()" style="width: auto;">Cancel</button>
        <button class="btn btn-primary" onclick="app.finalizeCopy()" style="width: auto;">Continue</button>
    </div>
</dialog>

<!-- Marketplace Dialog (Overhauled) -->
<dialog id="dialog-marketplace" class="mp-dialog">
    <button class="mp-close-btn" onclick="document.getElementById('dialog-marketplace').close()">âœ•</button>
    <div class="mp-layout">
        <!-- Sidebar -->
        <div class="mp-sidebar">
            <div style="padding: 0 16px; margin-bottom: 20px;">
                <input type="file" id="marketplace-import" accept=".pvb" style="display:none;" onchange="Marketplace.importFromFile(this)">
                <div style="font-weight: 800; font-size: 20px; color: #fff; margin-bottom: 4px;">Marketplace</div>
                <div style="font-size: 12px; color: var(--text-tertiary);">Prompt Bundle Library</div>
            </div>

            <div class="mp-nav-item active" onclick="Marketplace.switchView('discover')" id="nav-discover">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                Discover
            </div>
            
            <div class="mp-nav-header">Library</div>
            <div class="mp-nav-item" onclick="Marketplace.switchView('installed')" id="nav-installed">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Installed
            </div>
            <div class="mp-nav-item" onclick="Marketplace.switchView('updates')" id="nav-updates">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                Updates <span id="mp-update-badge" style="background:var(--danger); color:white; font-size:10px; padding:2px 6px; border-radius:10px; margin-left:auto; display:none;">0</span>
            </div>

            <div style="margin-top: auto; padding: 16px;">
                <button class="btn btn-secondary" onclick="document.getElementById('marketplace-import').click()" style="width: 100%; justify-content: flex-start; gap: 8px;">
                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                    Import .pvb
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <div class="mp-content" id="mp-content-area">
            <!-- Dynamic Content -->
        </div>
    </div>
</dialog>

<!-- Export Bundle Setup Dialog (NEW) -->
<dialog id="dialog-export-bundle">
    <div class="dialog-header">
        <span>Export for Marketplace</span>
        <button class="btn btn-ghost btn-icon" onclick="document.getElementById('dialog-export-bundle').close()">âœ•</button>
    </div>
    <div class="dialog-body">
        <input type="hidden" id="export-bundle-pack-id">
        <div class="form-group">
            <label>Bundle Name</label>
            <input type="text" id="export-bundle-name" class="form-input" placeholder="My Awesome Pack">
        </div>
        <div class="form-group">
            <label>Version</label>
            <input type="text" id="export-bundle-ver" class="form-input" placeholder="1.0.0" value="1.0.0">
        </div>
        <div class="form-group">
            <label>Description</label>
            <textarea id="export-bundle-desc" class="form-input" placeholder="What's in this bundle?" style="min-height:60px;"></textarea>
        </div>
        <div class="form-group">
            <label>Author</label>
            <input type="text" id="export-bundle-author" class="form-input" placeholder="Your Name">
        </div>
        <div class="form-group">
            <label>Cover Image URL (Optional)</label>
            <input type="text" id="export-bundle-img" class="form-input" placeholder="https://...">
        </div>
    </div>
    <div class="dialog-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('dialog-export-bundle').close()">Cancel</button>
        <button class="btn btn-primary" onclick="app.confirmBundleExport()">Export .pvb</button>
    </div>
</dialog>

<!-- Dialog: Unsaved Changes -->
<dialog id="dialog-unsaved">
    <div class="dialog-header">
        <span>Unsaved Changes</span>
    </div>
    <div class="dialog-body">
        <p style="color:var(--text-secondary);font-size:14px;line-height:1.5;">You have unsaved edits. What would you like to do?</p>
    </div>
    <div class="dialog-footer">
        <button class="btn btn-secondary" id="btn-unsaved-cancel">Cancel</button>
        <button class="btn btn-danger" id="btn-unsaved-discard">Discard</button>
        <button class="btn btn-primary" id="btn-unsaved-save">Save & Continue</button>
    </div>
</dialog>

<dialog id="dialog-delete-prompt">
    <div class="dialog-header">
        <span style="color: var(--danger)">Delete Prompt?</span>
        <button class="btn btn-ghost btn-icon" onclick="document.getElementById('dialog-delete-prompt').close()">âœ•</button>
    </div>
    <div class="dialog-body">
        <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px; line-height: 1.5;">Are you sure you want to delete this prompt? This action cannot be undone.</p>
    </div>
    <div class="dialog-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('dialog-delete-prompt').close()" style="width: auto;">Cancel</button>
        <button class="btn btn-danger" onclick="app.confirmDeletePrompt()" style="width: auto;">Delete</button>
    </div>
</dialog>

<!-- Dialog: View Version (NEW) -->
<dialog id="dialog-version-view">
    <div class="dialog-header">
        <span>Version Content</span>
        <button class="btn btn-ghost btn-icon" onclick="document.getElementById('dialog-version-view').close()">âœ•</button>
    </div>
    <div class="dialog-body">
        <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 8px;">Read-only preview</div>
        <pre id="version-view-content" style="white-space: pre-wrap; font-family: var(--font-mono); font-size: 13px; color: var(--text-secondary); margin: 0; max-height: 50vh; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 6px; border: 1px solid var(--border);"></pre>
    </div>
    <div class="dialog-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('dialog-version-view').close()">Close</button>
        <button class="btn btn-secondary" id="btn-view-copy">Copy</button>
        <button class="btn btn-primary" id="btn-view-restore">Restore</button>
    </div>
</dialog>

<dialog id="dialog-settings">
    <div class="dialog-header">
        <span>Settings & Data</span>
        <button class="btn btn-ghost btn-icon" onclick="document.getElementById('dialog-settings').close()">âœ•</button>
    </div>
    <div class="dialog-body">
        <div class="meta-label">Export</div>
        <div class="flex-row" style="flex-wrap: wrap;">
            <button class="btn btn-secondary" onclick="app.exportVault()" style="flex: 1;">Backup Vault (.json)</button>
            <button class="btn btn-secondary" onclick="app.exportLibraryCSV()" style="flex: 1;">Export Library (.csv)</button>
        </div>
        <!-- NEW -->
        <div class="flex-row" style="flex-wrap: wrap; margin-top: 8px;">
            <button class="btn btn-secondary" onclick="app.openPackExportPicker('md')" style="flex: 1;">Export Pack (.md)</button>
            <button class="btn btn-secondary" onclick="app.openPackExportPicker('pvb')" style="flex: 1;">Export Bundle (.pvb)</button>
        </div>
        
        <div class="meta-label" style="margin-top: 24px;">Import</div>
        <div style="margin-bottom: 8px; font-size: 12px; color: var(--text-tertiary);">Supports .json (Vault), .csv (Library), .md (Pack), .pvb (Bundle)</div>
        <input type="file" id="import-file" class="form-input" accept=".json,.csv,.md,.pvb" onchange="app.handleFileSelect(this)">

        <div class="meta-label" style="margin-top: 24px;">Storage & Reset</div>
        <button class="btn btn-secondary" onclick="app.clearCache()" style="margin-bottom: 8px;">Clear App Cache</button>
        
        <div class="meta-label" style="margin-top: 16px; color: var(--danger);">Danger Zone</div>
        <button class="btn btn-danger" onclick="app.openNukeDialog()">Delete All Data</button>
    </div>
</dialog>

<dialog id="dialog-nuke">
    <div class="dialog-header" style="border-bottom-color: var(--danger);">
        <span style="color: var(--danger);">PERMANENT DELETION</span>
        <button class="btn btn-ghost btn-icon" onclick="document.getElementById('dialog-nuke').close()">âœ•</button>
    </div>
    <div class="dialog-body">
        <p style="color: var(--text-primary); margin-bottom: 12px; font-size: 14px;">This will wipe ALL prompts and local data. There is no undo.</p>
        <div class="form-group">
            <label style="color: var(--text-secondary);">Type <strong>DELETE</strong> to confirm:</label>
            <input type="text" id="nuke-confirm-input" class="form-input" placeholder="DELETE">
        </div>
    </div>
    <div class="dialog-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('dialog-nuke').close()" style="width: auto;">Cancel</button>
        <button class="btn btn-danger" onclick="app.confirmNuke()" style="width: auto;">Erase Everything</button>
    </div>
</dialog>

<dialog id="dialog-pack">
    <div class="dialog-header">
        <span>Create Prompt Pack</span>
        <button class="btn btn-ghost btn-icon" onclick="document.getElementById('dialog-pack').close()">âœ•</button>
    </div>
    <div class="dialog-body">
        <div class="form-group">
            <label>Pack Name</label>
            <input type="text" id="new-pack-name" class="form-input" placeholder="e.g. Email Templates">
        </div>
    </div>
    <div class="dialog-footer">
        <button class="btn btn-primary" onclick="app.createPack()" style="width: auto;">Create Pack</button>
    </div>
</dialog>

<dialog id="dialog-manage-packs">
    <div class="dialog-header">
        <span>Manage Prompt Packs</span>
        <button class="btn btn-ghost btn-icon" onclick="document.getElementById('dialog-manage-packs').close()">âœ•</button>
    </div>
    <div class="dialog-body" id="manage-packs-list"></div>
    <div class="dialog-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('dialog-manage-packs').close()" style="width: auto;">Close</button>
    </div>
</dialog>

<dialog id="dialog-pack-preview">
    <div class="dialog-header">
        <span id="preview-pack-title">Pack Preview</span>
        <button class="btn btn-ghost btn-icon" onclick="document.getElementById('dialog-pack-preview').close()">âœ•</button>
    </div>
    <div class="dialog-body" id="preview-pack-content"></div>
    <div class="dialog-footer">
        <button class="btn btn-secondary" id="btn-export-pack-md" style="width: auto;">Export .md</button>
        <button class="btn btn-primary" id="btn-export-pack-pvb" style="width: auto;">Export .pvb</button>
    </div>
</dialog>

<!-- Import Preview Dialog -->
<dialog id="dialog-import-preview">
    <div class="dialog-header">
        <span>Import Preview</span>
        <button class="btn btn-ghost btn-icon" onclick="document.getElementById('dialog-import-preview').close()">âœ•</button>
    </div>
    <div class="dialog-body">
        <div id="import-stats"></div>
        <div id="import-conflicts-section" style="margin-top: 16px; display: none;">
            <div class="meta-label" style="color: var(--text-primary);">Conflict Resolution</div>
            <div class="form-group">
                <label>Strategy for updates (ID match):</label>
                <select id="import-strategy-update" class="strategy-select">
                    <option value="merge">Merge (Keep newest)</option>
                    <option value="overwrite">Overwrite Local</option>
                    <option value="skip">Skip (Keep Local)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Strategy for naming conflicts (Name match):</label>
                <select id="import-strategy-conflict" class="strategy-select">
                    <option value="duplicate">Duplicate (Create Copy)</option>
                    <option value="skip">Skip</option>
                    <option value="overwrite">Overwrite Local</option>
                </select>
            </div>
        </div>
        <div id="import-details-list" style="margin-top:16px; max-height: 200px; overflow-y:auto; border: 1px solid var(--border); border-radius: 8px; padding: 8px;"></div>
    </div>
    <div class="dialog-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('dialog-import-preview').close()" style="width: auto;">Cancel</button>
        <button class="btn btn-primary" onclick="app.executeImport()" style="width: auto;">Confirm Import</button>
    </div>
</dialog>

<!-- Tag Manager Dialog -->
<dialog id="dialog-tag-manager">
    <div class="dialog-header">
        <span>Tag Manager</span>
        <button class="btn btn-ghost btn-icon" onclick="document.getElementById('dialog-tag-manager').close()">âœ•</button>
    </div>
    <div class="dialog-body">
        <div style="margin-bottom: 16px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
            <div class="flex-row" style="justify-content: space-between; align-items: center;">
                <span style="font-size: 13px; color: var(--text-secondary);">Cleanup: <strong id="untagged-count" style="color: var(--text-primary);">0</strong> prompts have no tags.</span>
                <button class="btn btn-secondary btn-sm" onclick="app.filterUntagged()">Show Untagged</button>
            </div>
        </div>
        <div id="tag-manager-list"></div>
    </div>
    <div class="dialog-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('dialog-tag-manager').close()">Close</button>
    </div>
</dialog>

<!-- Search Help Dialog -->
<dialog id="dialog-search-help">
    <div class="dialog-header">
        <span>Search Operators</span>
        <button class="btn btn-ghost btn-icon" onclick="document.getElementById('dialog-search-help').close()">âœ•</button>
    </div>
    <div class="dialog-body">
        <table class="search-help-table">
            <tr><td>tag:value</td><td>Match tag (e.g. tag:email)</td></tr>
            <tr><td>intent:value</td><td>Match intent (e.g. intent:generate)</td></tr>
            <tr><td>pack:value</td><td>Match pack name (e.g. pack:"Work")</td></tr>
            <tr><td>notes:value</td><td>Search inside notes</td></tr>
            <tr><td>has:vars</td><td>Has {{variables}}</td></tr>
            <tr><td>created:>2024-01-01</td><td>Created after date</td></tr>
            <tr><td>updated:>2024-01-01</td><td>Updated after date</td></tr>
        </table>
        <p style="margin-top:12px; font-size:12px; color:var(--text-tertiary);">Combine multiple terms. Use quotes for spaces.</p>
    </div>
</dialog>

<!-- Pack Picker Dialog (NEW) -->
<dialog id="dialog-pack-picker">
    <div class="dialog-header">
        <span id="pack-picker-title">Select Pack</span>
        <button class="btn btn-ghost btn-icon" onclick="document.getElementById('dialog-pack-picker').close()">âœ•</button>
    </div>
    <div class="dialog-body" id="pack-picker-list"></div>
    <!-- Added footer here -->
    <div class="dialog-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('dialog-pack-picker').close()">Close</button>
    </div>
</dialog>

<!-- Tag Selector Dialog (NEW) -->
<dialog id="dialog-tag-selector">
    <div class="dialog-header">
        <span id="tag-selector-title">Select Tag</span>
        <button class="btn btn-ghost btn-icon" onclick="document.getElementById('dialog-tag-selector').close()">âœ•</button>
    </div>
    <div class="dialog-body" style="overflow: visible;">
        <label id="tag-selector-label" class="form-label" style="display:block;margin-bottom:8px;color:var(--text-secondary);font-size:13px;"></label>
        <div class="autocomplete-wrapper">
            <input type="text" id="tag-selector-input" class="form-input" autocomplete="off">
            <div id="tag-selector-dropdown" class="autocomplete-dropdown"></div>
        </div>
        <div id="tag-selector-hint" style="font-size: 12px; margin-top: 6px; color: var(--text-tertiary); height: 1.2em; display:flex; align-items:center;"></div>
    </div>
    <div class="dialog-footer">
        <button class="btn btn-secondary" id="btn-tag-selector-cancel">Cancel</button>
        <button class="btn btn-primary" id="btn-tag-selector-ok">Merge</button>
    </div>
</dialog>

<!-- Generic Confirmation Dialog -->
<dialog id="dialog-confirm">
    <div class="dialog-header">
        <span id="confirm-title">Confirm</span>
    </div>
    <div class="dialog-body">
        <p id="confirm-msg" style="color:var(--text-secondary);font-size:14px;line-height:1.5;"></p>
    </div>
    <div class="dialog-footer">
        <button class="btn btn-secondary" id="btn-confirm-cancel">Cancel</button>
        <button class="btn btn-primary" id="btn-confirm-ok">Confirm</button>
    </div>
</dialog>

<!-- Tag Operation Confirmation Dialog -->
<dialog id="dialog-tag-confirm">
    <div class="dialog-header">
        <span id="tag-confirm-title">Confirm</span>
    </div>
    <div class="dialog-body">
        <p id="tag-confirm-msg" style="color:var(--text-secondary);font-size:14px;line-height:1.5;"></p>
    </div>
    <div class="dialog-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('dialog-tag-confirm').close()">Cancel</button>
        <div style="flex:1"></div>
        <button class="btn btn-secondary" onclick="app.exportVault()">Backup Vault</button>
        <button class="btn btn-primary" id="btn-tag-confirm-proceed">Proceed</button>
    </div>
</dialog>

<!-- Generic Input Dialog -->
<dialog id="dialog-input">
    <div class="dialog-header">
        <span id="input-title">Input</span>
    </div>
    <div class="dialog-body">
        <label id="input-label" style="display:block;margin-bottom:8px;color:var(--text-secondary);font-size:13px;"></label>
        <input type="text" id="input-field" class="form-input" onkeydown="if(event.key === 'Enter') document.getElementById('btn-input-ok').click()">
    </div>
    <div class="dialog-footer">
        <button class="btn btn-secondary" id="btn-input-cancel">Cancel</button>
        <button class="btn btn-primary" id="btn-input-ok">OK</button>
    </div>
</dialog>

<div id="toast" popover="manual">Action Successful</div>

<script id="sw-source" type="javascript/worker">
const CACHE_NAME = 'promptvault-v2';
const ASSETS = ['./'];
self.addEventListener('install', (e) => { e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(ASSETS))); self.skipWaiting(); });
self.addEventListener('fetch', (e) => { e.respondWith(fetch(e.request).then(res => { const clone = res.clone(); caches.open(CACHE_NAME).then(cache => cache.put(e.request, clone)); return res; }).catch(() => caches.match(e.request))); });
</script>

<script>
const uuid = () => crypto.randomUUID();
const now = () => new Date().toISOString();
const showToast = (msg, type = 'success') => {
    const t = document.getElementById('toast'); 
    t.innerText = msg; t.className = ''; 
    if (type === 'error') t.classList.add('error'); 
    try { t.showPopover(); } catch(e) { t.classList.add('show'); }
    setTimeout(() => { try { t.hidePopover(); } catch(e) { t.classList.remove('show'); } }, 3000);
};

// --- Keyword Map for Suggestions ---
const KEYWORD_MAP = {
    'email': 'Email', 'letter': 'Email', 'compose': 'Email', 'reply': 'Email',
    'code': 'Coding', 'function': 'Coding', 'script': 'Coding', 'html': 'Coding', 'css': 'Coding', 'js': 'Coding', 'python': 'Coding',
    'image': 'Image', 'photo': 'Image', 'generate': 'Image', 'midjourney': 'Image', 'dalle': 'Image',
    'summarize': 'Summary', 'summary': 'Summary', 'shorten': 'Summary', 'tldr': 'Summary',
    'rewrite': 'Editing', 'edit': 'Editing', 'proofread': 'Editing', 'grammar': 'Editing',
    'translate': 'Translation', 'language': 'Translation',
    'analyze': 'Analysis', 'data': 'Analysis', 'report': 'Analysis',
    'brainstorm': 'Ideas', 'ideas': 'Ideas', 'list': 'Ideas',
    'seo': 'Marketing', 'marketing': 'Marketing', 'ad': 'Marketing', 'copy': 'Marketing'
};

// --- IO Utilities ---
const IO = {
    // CSV Handling
    escapeCSV: (str) => {
        if (str === null || str === undefined) return '';
        const s = String(str);
        if (s.includes('"') || s.includes(',') || s.includes('\n')) {
            return `"${s.replace(/"/g, '""')}"`;
        }
        return s;
    },
    parseCSVLine: (line) => {
        const res = [];
        let cur = '';
        let inQuote = false;
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (inQuote) {
                if (char === '"') {
                    if (i + 1 < line.length && line[i + 1] === '"') { cur += '"'; i++; }
                    else { inQuote = false; }
                } else { cur += char; }
            } else {
                if (char === '"') { inQuote = true; }
                else if (char === ',') { res.push(cur); cur = ''; }
                else { cur += char; }
            }
        }
        res.push(cur);
        return res;
    },
    promptsToCSV: (prompts) => {
        const headers = ['id', 'title', 'tags', 'prompt_body', 'notes', 'variables_detected', 'created_at', 'updated_at', 'intent', 'is_pinned', 'last_used_at'];
        const rows = prompts.map(p => {
            return [
                p.id, p.title, (p.tags||[]).join('|'), p.body, p.notes, 
                (IO.detectVars(p.body)||[]).join('|'), p.createdAt, p.updatedAt,
                p.intent || '', p.isPinned ? 'true' : 'false', p.lastUsedAt || ''
            ].map(IO.escapeCSV).join(',');
        });
        return [headers.join(','), ...rows].join('\n');
    },
    parseCSV: (text) => {
        const lines = text.split(/\r?\n/);
        const headers = IO.parseCSVLine(lines[0]);
        const prompts = [];
        let result = [];
        let currentRow = [];
        let currentField = '';
        let insideQuotes = false;
        
        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const nextChar = text[i + 1];
            if (insideQuotes) {
                if (char === '"' && nextChar === '"') { currentField += '"'; i++; }
                else if (char === '"') { insideQuotes = false; }
                else { currentField += char; }
            } else {
                if (char === '"') { insideQuotes = true; }
                else if (char === ',') { currentRow.push(currentField); currentField = ''; }
                else if (char === '\n' || char === '\r') {
                    if (char === '\r' && nextChar === '\n') i++;
                    currentRow.push(currentField);
                    if (currentRow.length > 1) result.push(currentRow);
                    currentRow = []; currentField = '';
                } else { currentField += char; }
            }
        }
        if (currentField || currentRow.length > 0) { currentRow.push(currentField); result.push(currentRow); }
        
        result.shift(); 
        return result.map(row => {
            const p = {};
            headers.forEach((h, i) => {
                let val = row[i];
                if (h === 'tags' || h === 'variables_detected') val = val ? val.split('|') : [];
                else if (h === 'is_pinned') val = val === 'true';
                p[h === 'prompt_body' ? 'body' : h.replace(/_([a-z])/g, g => g[1].toUpperCase())] = val; // simple camelCase convert
            });
            // Fix key mapping for CSV manual restore if needed, mostly handled by explicit keys above
            if(p.isPinned === undefined && p.is_pinned !== undefined) p.isPinned = p.is_pinned;
            return p;
        });
    },

    // Markdown Handling
    detectVars: (text) => [...new Set([...(text||'').matchAll(/{{\s*([^}]+)\s*}}/g)].map(m => m[1]))],
    packToMD: (pack, prompts, appVersion) => {
        const fm = [
            '---',
            `pack_name: ${pack.name}`,
            `pack_id: ${pack.id}`,
            `exported_at: ${new Date().toISOString()}`,
            `app_version: ${appVersion}`,
            '---'
        ].join('\n');
        
        const body = prompts.map(p => {
            return `## ${p.title}
**ID:** ${p.id}
**Tags:** ${(p.tags||[]).join(', ')}
${p.intent ? `**Intent:** ${p.intent}\n` : ''}
${p.notes ? `**Notes:** ${p.notes}\n` : ''}
\`\`\`text
${p.body}
\`\`\`
`;
        }).join('\n---\n\n');
        return `${fm}\n\n# ${pack.name}\n\n${body}`;
    },
    parseMD: (text) => {
        const fmMatch = text.match(/^---\n([\s\S]*?)\n---/);
        const meta = {};
        if (fmMatch) {
            fmMatch[1].split('\n').forEach(line => {
                const parts = line.split(':');
                if (parts.length >= 2) meta[parts[0].trim()] = parts.slice(1).join(':').trim();
            });
        }
        
        const content = text.replace(/^---\n[\s\S]*?\n---/, '');
        const sections = content.split(/^## /gm).slice(1);
        const prompts = sections.map(s => {
            const lines = s.split('\n');
            const title = lines[0].trim();
            const idMatch = s.match(/\*\*ID:\*\* (.*)/);
            const tagsMatch = s.match(/\*\*Tags:\*\* (.*)/);
            const notesMatch = s.match(/\*\*Notes:\*\* (.*)/);
            const intentMatch = s.match(/\*\*Intent:\*\* (.*)/);
            const codeMatch = s.match(/```text\n([\s\S]*?)\n```/);
            
            return {
                id: idMatch ? idMatch[1].trim() : uuid(),
                title: title,
                tags: tagsMatch ? tagsMatch[1].split(',').map(t=>t.trim()).filter(t=>t) : [],
                notes: notesMatch ? notesMatch[1].trim() : '',
                intent: intentMatch ? intentMatch[1].trim() : null,
                body: codeMatch ? codeMatch[1] : ''
            };
        });
        return { meta, prompts };
    },

    // Bundle Handling
    createBundle: (pack, prompts, appVersion, metadata = {}) => {
        return {
            bundle_version: metadata.version || "1.0.0",
            meta: metadata,
            exported_at: now(),
            app_version: appVersion,
            packs: [pack],
            prompts: prompts
        };
    }
};

// --- Import Manager ---
const ImportManager = {
    pendingImport: null,
    analyze: async (data, type) => {
        let candidates = { packs: [], prompts: [] };
        if (type === 'json') {
            try {
                const parsed = JSON.parse(data);
                candidates = { packs: parsed.packs || [], prompts: parsed.prompts || [] };
            } catch(e) {
                console.error("Failed to parse JSON", e);
            }
        } else if (type === 'csv') {
            candidates.prompts = IO.parseCSV(data);
        } else if (type === 'md') {
            const parsed = IO.parseMD(data);
            if (parsed.meta.pack_name) {
                candidates.packs.push({ 
                    id: parsed.meta.pack_id || uuid(), 
                    name: parsed.meta.pack_name, 
                    promptIds: parsed.prompts.map(p => p.id) 
                });
            }
            candidates.prompts = parsed.prompts;
        } else if (type === 'pvb') {
            const j = JSON.parse(data);
            candidates = { packs: j.packs || [], prompts: j.prompts || [] };
        }

        const plan = { newPrompts: [], updates: [], conflicts: [], newPacks: [] };
        const existingPrompts = app.state.prompts;
        
        candidates.prompts.forEach(c => {
            if (!c.id) c.id = uuid();
            const idMatch = existingPrompts.find(p => p.id === c.id);
            const nameMatch = existingPrompts.find(p => p.title === c.title && p.id !== c.id);
            if (idMatch) {
                if (idMatch.body !== c.body || idMatch.title !== c.title) plan.updates.push({ current: idMatch, candidate: c });
            } else if (nameMatch) {
                plan.conflicts.push({ current: nameMatch, candidate: c });
            } else {
                if (!c.createdAt) c.createdAt = now();
                if (!c.updatedAt) c.updatedAt = now();
                if (!c.versions) c.versions = [];
                plan.newPrompts.push(c);
            }
        });

        candidates.packs.forEach(p => {
            if (!app.state.packs.find(ep => ep.id === p.id)) plan.newPacks.push(p);
        });

        ImportManager.pendingImport = plan;
        return plan;
    },

    execute: async (strategies) => {
        const plan = ImportManager.pendingImport;
        if (!plan) return;
        for (const p of plan.newPrompts) await db.put('prompts', p);
        for (const p of plan.newPacks) await db.put('packs', p);
        for (const up of plan.updates) {
            if (strategies.update === 'merge' || strategies.update === 'overwrite') {
                const final = { ...up.current, ...up.candidate };
                if (strategies.update === 'merge') final.tags = [...new Set([...(up.current.tags||[]), ...(up.candidate.tags||[])])];
                await db.put('prompts', final);
            }
        }
        for (const cf of plan.conflicts) {
            if (strategies.conflict === 'duplicate') {
                const dup = { ...cf.candidate, id: uuid(), title: cf.candidate.title + ' (Imported)' };
                await db.put('prompts', dup);
            } else if (strategies.conflict === 'overwrite') {
                const ov = { ...cf.current, ...cf.candidate, id: cf.current.id };
                await db.put('prompts', ov);
            }
        }
        return true;
    }
};

const db = {
    conn: null,
    async init() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open('PromptVaultDB', 2); // Bump version for Marketplace
            req.onupgradeneeded = (e) => {
                const conn = e.target.result;
                if (!conn.objectStoreNames.contains('prompts')) conn.createObjectStore('prompts', { keyPath: 'id' });
                if (!conn.objectStoreNames.contains('packs')) conn.createObjectStore('packs', { keyPath: 'id' });
                if (!conn.objectStoreNames.contains('marketplace')) conn.createObjectStore('marketplace', { keyPath: 'id' });
            };
            req.onsuccess = (e) => { this.conn = e.target.result; resolve(this.conn); };
            req.onerror = (e) => reject(e);
        });
    },
    async getAll(store) {
        return new Promise((res, rej) => { const req = this.conn.transaction(store, 'readonly').objectStore(store).getAll(); req.onsuccess = () => res(req.result); req.onerror = () => rej(req.error); });
    },
    async put(store, item) {
        return new Promise((res, rej) => { const req = this.conn.transaction(store, 'readwrite').objectStore(store).put(item); req.onsuccess = () => res(req.result); req.onerror = () => rej(req.error); });
    },
    async delete(store, id) {
        return new Promise((res, rej) => { const req = this.conn.transaction(store, 'readwrite').objectStore(store).delete(id); req.onsuccess = () => res(); req.onerror = () => rej(req.error); });
    },
    async clear(store) {
        return new Promise((res, rej) => { const req = this.conn.transaction(store, 'readwrite').objectStore(store).clear(); req.onsuccess = res; req.onerror = rej; });
    }
};

// --- Marketplace Module (OVERHAULED) ---
const Marketplace = {
    pkgs: [],
    view: 'discover', // discover, installed, updates, details
    activePackId: null,

    // Remote catalog (optional)
    remoteIndexUrl: './packs/index.json',
    _remoteSyncing: false,

    async load() {
        const all = await db.getAll('marketplace');
        this.pkgs = (all || []).filter(p => !p.hidden);
        this.updateBadges();
        this.render();
    },
    open() {
        this.load();
        this.syncRemotePacks(); // pull in server packs (if available)
        this.switchView('discover');
        document.getElementById('dialog-marketplace').showModal();
    },

    async syncRemotePacks() {
        if (this._remoteSyncing) return;
        this._remoteSyncing = true;
        try {
            const idxRes = await fetch(this.remoteIndexUrl, { cache: 'no-store' });
            if (!idxRes.ok) throw new Error(`Remote index HTTP ${idxRes.status}`);
            const idx = await idxRes.json();

            // allow either: {packs:[{url:"..."}]} OR ["...","..."]
            const entries = Array.isArray(idx) ? idx : (idx.packs || []);
            if (!Array.isArray(entries) || entries.length === 0) return;

            const existingAll = await db.getAll('marketplace');
            const byId = new Map((existingAll || []).map(p => [p.id, p]));

            for (const entry of entries) {
                const url = typeof entry === 'string' ? entry : entry.url;
                if (!url) continue;

                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) { console.warn('Failed to fetch pack', url, res.status); continue; }
                const raw = await res.text();

                let bundle;
                try { bundle = JSON.parse(raw); } catch (e) { console.warn('Invalid JSON', url); continue; }
                if (!bundle.packs || !bundle.prompts) { console.warn('Invalid PVB structure', url); continue; }

                const meta = bundle.meta || {};
                const pkgId = bundle.packs[0]?.id || meta.id || uuid();
                const ver = meta.version || bundle.bundle_version || '1.0.0';
                const name = meta.title || bundle.packs[0]?.name || 'Pack';
                const desc = meta.description || `Contains ${bundle.prompts.length} prompts.`;
                const prev = byId.get(pkgId);

                let installState = prev ? (prev.installState || 'not-installed') : 'not-installed';
                if (prev && (prev.installState === 'installed') && prev.version !== ver) installState = 'needs-update';

                const pkg = {
                    id: pkgId,
                    version: ver,
                    name: name,
                    description: desc,
                    author: meta.author || (typeof entry === 'object' ? (entry.author || 'Unknown') : 'Unknown'),
                    tags: meta.tags || (typeof entry === 'object' ? (entry.tags || ['Official']) : ['Official']),
                    image: meta.image || (typeof entry === 'object' ? (entry.image || null) : null),
                    source: 'remote',
                    remoteUrl: url,
                    rawBundle: raw,
                    hidden: prev ? !!prev.hidden : false,
                    createdAt: prev ? prev.createdAt : (typeof entry === 'object' && entry.createdAt ? entry.createdAt : now()),
                    updatedAt: now(),
                    installState: installState,
                    installedPromptIds: prev ? (prev.installedPromptIds || []) : [],
                    installedPackIds: prev ? (prev.installedPackIds || []) : []
                };

                await db.put('marketplace', pkg);
            }
        } catch (e) {
            // Silent fail: Marketplace still works offline / without a server catalog
            console.log('Remote marketplace sync skipped:', e.message);
        } finally {
            this._remoteSyncing = false;
            this.load();
        }
    },

    updateBadges() {
        const updates = this.pkgs.filter(p => p.installState === 'needs-update').length;
        const badge = document.getElementById('mp-update-badge');
        badge.innerText = updates;
        badge.style.display = updates > 0 ? 'inline-block' : 'none';
    },
    switchView(viewName) {
        this.view = viewName;
        // Update sidebar active state
        document.querySelectorAll('.mp-nav-item').forEach(el => el.classList.remove('active'));
        const activeNav = document.getElementById(`nav-${viewName}`);
        if(activeNav) activeNav.classList.add('active');
        
        this.render();
    },
    
    // Core Render Dispatcher
    render() {
        const container = document.getElementById('mp-content-area');
        container.innerHTML = '';
        container.className = 'mp-content'; // Reset animations
        
        const scroll = document.createElement('div');
        scroll.className = 'mp-scroll-container';
        container.appendChild(scroll);

        if (this.view === 'details' && this.activePackId) {
            this.renderDetails(scroll);
        } else if (this.view === 'installed') {
            this.renderList(scroll, this.pkgs.filter(p => p.installState === 'installed' || p.installState === 'needs-update'), "Installed");
        } else if (this.view === 'updates') {
            this.renderList(scroll, this.pkgs.filter(p => p.installState === 'needs-update'), "Available Updates");
        } else {
            this.renderDiscover(scroll);
        }
    },

    renderDiscover(container) {
    const featured = this.pkgs.length > 0
        ? this.pkgs[Math.floor(Math.random() * this.pkgs.length)]
        : null;

    const hero = document.createElement('div');
    hero.className = 'mp-hero';

    if (featured) {
        hero.onclick = () => this.showDetails(featured.id);

        // Optional image overlay if pack provides one
        if (featured.image) {
            hero.style.backgroundImage = `url('${featured.image}')`;
hero.style.backgroundSize = 'cover';
hero.style.backgroundPosition = 'center';

        }

        hero.innerHTML = `
            <div class="mp-hero-scan"></div>
            <div class="mp-hero-content">
                <div class="mp-hero-tag">AI Prompt Pack</div>
                <div class="mp-hero-title">${featured.name}</div>
                <div class="mp-hero-desc">
                    ${featured.description.substring(0, 120)}â€¦
                </div>
            </div>
        `;
    } else {
        hero.innerHTML = `
            <div class="mp-hero-scan"></div>
            <div class="mp-hero-content">
                <div class="mp-hero-tag">AI Prompt Marketplace</div>
                <div class="mp-hero-title">PromptVault Store</div>
                <div class="mp-hero-desc">
                    Curated AI prompt packs. Import once. Use forever.
                </div>
            </div>
        `;
    }

    container.appendChild(hero);

    // Continue with existing sections
    this.renderSectionHeader(container, "Recently Added");
    const recent = [...this.pkgs].sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

    if (recent.length === 0) {
        container.innerHTML += `
            <div style="text-align:center;padding:40px;color:var(--text-tertiary);">
                No packs yet. Import one to get started.
            </div>
        `;
        return;
    }

    const grid = document.createElement('div');
    grid.className = 'app-grid';
    recent.forEach(pkg => grid.innerHTML += this.createCardHTML(pkg));
    container.appendChild(grid);
},

    renderList(container, items, title) {
        this.renderSectionHeader(container, title);
        if (items.length === 0) {
            container.innerHTML += `<div style="text-align:center; padding: 40px; color: var(--text-tertiary);">No items found.</div>`;
            return;
        }
        const grid = document.createElement('div');
        grid.className = 'app-grid'; // Reuse grid layout or could be list
        items.forEach(pkg => {
             grid.innerHTML += this.createCardHTML(pkg);
        });
        container.appendChild(grid);
    },

    createCardHTML(pkg) {
        const btn = this.createButtonHTML(pkg);
        const iconSrc = pkg.image || ''; 
        // Fallback icon logic in HTML if src fails or is empty handled by CSS mostly, but here we can check
        const imgTag = iconSrc 
            ? `<img src="${iconSrc}" class="app-icon" onerror="this.style.display='none'">` 
            : `<div class="app-icon" style="display:flex;align-items:center;justify-content:center;color:#666;font-size:24px;font-weight:bold;">${pkg.name.charAt(0)}</div>`;

        return `
            <div class="app-card-row" onclick="Marketplace.showDetails('${pkg.id}')">
                ${imgTag}
                <div class="app-info">
                    <div class="app-title">${pkg.name}</div>
                    <div class="app-subtitle">${pkg.author || 'Unknown Author'}</div>
                    <div class="app-meta">
                        ${(pkg.tags||[]).slice(0,2).map(t => `<span class="app-badge">${t}</span>`).join('')}
                    </div>
                </div>
                ${btn}
            </div>
        `;
    },

    createButtonHTML(pkg) {
        // Prevent bubble up
        const clk = `event.stopPropagation();`;
        if (pkg.installState === 'installed') {
            return `<button class="get-btn installed" onclick="${clk}">Open</button>`;
        } else if (pkg.installState === 'needs-update') {
            return `<button class="get-btn update" onclick="${clk} Marketplace.install('${pkg.id}')">Update</button>`;
        } else {
            return `<button class="get-btn" onclick="${clk} Marketplace.install('${pkg.id}')">Get</button>`;
        }
    },

    renderSectionHeader(container, title) {
        const div = document.createElement('div');
        div.className = 'mp-section-header';
        div.innerHTML = `<div class="mp-section-title">${title}</div>`;
        container.appendChild(div);
    },

    // --- Details View ---
    showDetails(id) {
        this.activePackId = id;
        this.view = 'details';
        this.render();
    },

    renderDetails(container) {
        const pkg = this.pkgs.find(p => p.id === this.activePackId);
        if (!pkg) return this.switchView('discover');

        // Extract prompts for preview
        let promptsHtml = '';
        try {
            const bundle = JSON.parse(pkg.rawBundle);
            const prompts = bundle.prompts || [];
            if(prompts.length > 0) {
                const list = prompts.slice(0, 6).map(p => `
                    <div class="mp-prompt-row">
                        <div class="mp-p-icon">
                            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        </div>
                        <div class="mp-p-content">
                            <div class="mp-p-title">${p.title || 'Untitled Prompt'}</div>
                            <div class="mp-p-desc">${app.escapeHtml(p.body.substring(0, 100).replace(/\n/g, ' '))}</div>
                        </div>
                    </div>
                `).join('');
                
                const more = prompts.length > 6 ? `<div style="padding:12px; text-align:center; font-size:12px; color:var(--text-tertiary); background:rgba(255,255,255,0.02);">+ ${prompts.length - 6} more prompts</div>` : '';
                
                promptsHtml = `
                    <div class="mp-section-header" style="margin-top:40px;"><div class="mp-section-title">Included Prompts (${prompts.length})</div></div>
                    <div class="mp-prompt-list">
                        ${list}
                        ${more}
                    </div>
                `;
            }
        } catch(e) { console.error("Error parsing bundle for preview", e); }

        container.innerHTML = `
            <div class="mp-details-view">
                <div class="mp-back-btn" onclick="Marketplace.switchView('discover')">
                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    Back to Discover
                </div>

                <div class="mp-details-header">
                     ${pkg.image 
                        ? `<img src="${pkg.image}" class="mp-details-icon">` 
                        : `<div class="mp-details-icon" style="display:flex;align-items:center;justify-content:center;color:#666;font-size:48px;">${pkg.name.charAt(0)}</div>`}
                    
                    <div class="mp-details-info">
                        <div class="mp-details-title">${pkg.name}</div>
                        <div class="mp-details-author">${pkg.author || 'Unknown Author'}</div>
                        <div style="display:flex; gap:10px;">
                            ${this.createDetailsButton(pkg)}
                            <button class="btn btn-secondary" style="border-radius:20px;" onclick="Marketplace.remove('${pkg.id}')">Remove from List</button>
                        </div>
                    </div>
                </div>

                <div class="mp-section-header"><div class="mp-section-title">About this Bundle</div></div>
                <div class="mp-details-desc">${pkg.description || "No description provided."}</div>
                
                <div style="display:flex; gap: 8px; font-size: 13px; color: var(--text-tertiary); margin-bottom: 20px;">
                    <span>Version ${pkg.version}</span> â€¢ 
                    <span>Imported ${new Date(pkg.createdAt).toLocaleDateString()}</span>
                </div>

                ${promptsHtml}
            </div>
        `;
    },

    createDetailsButton(pkg) {
        if (pkg.installState === 'installed') {
            return `<button class="get-btn remove" onclick="Marketplace.uninstall('${pkg.id}')">Uninstall</button>`;
        } else if (pkg.installState === 'needs-update') {
            return `<button class="get-btn update" style="font-size:14px; padding: 10px 32px;" onclick="Marketplace.install('${pkg.id}')">Update</button>`;
        } else {
            return `<button class="get-btn" style="font-size:14px; padding: 10px 32px;" onclick="Marketplace.install('${pkg.id}')">Get</button>`;
        }
    },

    // --- Import Logic (Kept mostly same, updated object structure) ---
    async importFromFile(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const raw = e.target.result;
                const bundle = JSON.parse(raw);
                if(!bundle.packs || !bundle.prompts) throw new Error("Invalid PVB");
                
                const pkgId = bundle.packs[0]?.id || uuid();
                const existing = this.pkgs.find(p => p.id === pkgId);
                const meta = bundle.meta || {};
                const name = meta.title || bundle.packs[0]?.name || "Imported Pack";
                const desc = meta.description || `Contains ${bundle.prompts.length} prompts. Imported from file.`;
                const ver = meta.version || bundle.bundle_version || "1.0.0";
                
                const pkg = {
                    id: pkgId,
                    version: ver,
                    name: name,
                    description: desc,
                    author: meta.author || "Unknown",
                    tags: ["Imported"],
                    image: meta.image || null, 
                    source: "file",
                    rawBundle: raw,
                    createdAt: existing ? existing.createdAt : now(),
                    updatedAt: now(),
                    installState: existing ? (existing.version !== ver ? "needs-update" : existing.installState) : "not-installed",
                    installedPromptIds: existing ? existing.installedPromptIds : [],
                    installedPackIds: existing ? existing.installedPackIds : []
                };
                
                await db.put('marketplace', pkg);
                this.load();
                showToast("Bundle added to Library");
            } catch(err) { console.error(err); showToast("Invalid Bundle", "error"); }
            input.value = '';
        };
        reader.readAsText(file);
    },

    // --- Actions ---
    async install(id) {
        const pkg = this.pkgs.find(p => p.id === id); if(!pkg) return;
        try {
            const bundle = JSON.parse(pkg.rawBundle);
            for(const p of bundle.prompts) await db.put('prompts', p);
            for(const k of bundle.packs) await db.put('packs', k);
            
            pkg.installState = "installed";
            pkg.installedPromptIds = bundle.prompts.map(p => p.id);
            pkg.installedPackIds = bundle.packs.map(p => p.id);
            pkg.updatedAt = now();
            
            await db.put('marketplace', pkg);
            await app.loadData(); app.renderList();
            this.load();
            showToast("Package Installed");
        } catch(e) { console.error(e); showToast("Install Failed", "error"); }
    },
    async uninstall(id) {
        const pkg = this.pkgs.find(p => p.id === id); if(!pkg) return;
        if(!(await app.confirm("Uninstalling will remove all associated prompts.", "Uninstall Package", true))) return;
        
        for(const pid of pkg.installedPromptIds || []) await db.delete('prompts', pid);
        for(const kid of pkg.installedPackIds || []) await db.delete('packs', kid);
        
        pkg.installState = "not-installed";
        pkg.installedPromptIds = [];
        pkg.installedPackIds = [];
        
        await db.put('marketplace', pkg);
        await app.loadData(); app.renderList();
        this.load();
        showToast("Package Uninstalled");
    },
    async remove(id) {
        const pkg = this.pkgs.find(p => p.id === id); if(!pkg) return;
        
        if (pkg.installState === 'installed') {
            if (!(await app.confirm("This bundle is currently installed. Removing it will uninstall all its prompts first. Continue?", "Remove Bundle", true))) return;
            for(const pid of pkg.installedPromptIds || []) await db.delete('prompts', pid);
            for(const kid of pkg.installedPackIds || []) await db.delete('packs', kid);
            await app.loadData(); app.renderList();
        } else {
             if (!(await app.confirm("Remove this bundle from your library?", "Remove Bundle"))) return;
        }

        // For remote packs, "Remove" should hide it (otherwise it will be re-synced)
        if (pkg.source === 'remote') {
            pkg.hidden = true;
            pkg.updatedAt = now();
            await db.put('marketplace', pkg);
        } else {
            await db.delete('marketplace', id);
        }

// âœ… Keep in-memory list in sync so the UI updates immediately
this.pkgs = this.pkgs.filter(p => p.id !== id);
this.updateBadges();

// Return to discover if viewing details of deleted item
if (this.view === 'details' && this.activePackId === id) {
    this.activePackId = null;
    this.switchView('discover');   // renders using updated this.pkgs
} else {
    this.render();                // re-render current view using updated this.pkgs
}

showToast(pkg.source === 'remote' ? "Bundle Hidden" : "Bundle Removed");

    }
};

const app = {
    state: { 
        prompts: [], packs: [], activePromptId: null, searchQuery: '', dirty: false, 
        sidebarWidth: 280, collapsed: false, view: 'editor', 
        filters: { untagged: false, hasVars: false, recent: false, used: false },
        sectionState: JSON.parse(localStorage.getItem('metaSectionState')) || {}, // Load saved state
        activeMetaTab: 'overview'
    },

    async init() {
        await db.init();
        
        // Restore Section States
        Object.keys(this.state.sectionState).forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                if(this.state.sectionState[id]) el.classList.remove('collapsed');
                else el.classList.add('collapsed');
            }
        });
        
        // Load UI State
        const savedWidth = localStorage.getItem('sidebarWidth');
        if (savedWidth) {
            this.state.sidebarWidth = parseInt(savedWidth);
            document.documentElement.style.setProperty('--sidebar-width', `${this.state.sidebarWidth}px`);
        }
        const savedCollapsed = localStorage.getItem('sidebarCollapsed');
        if (savedCollapsed === 'true') {
            this.toggleCollapse(false); // don't animate on init
        }
        
        // Resizer Logic
        const resizer = document.getElementById('sidebar-resizer');
        let isResizing = false;
        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            resizer.classList.add('resizing');
        });
        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            let newWidth = e.clientX;
            if (newWidth < 220) newWidth = 220;
            if (newWidth > 520) newWidth = 520;
            this.state.sidebarWidth = newWidth;
            document.documentElement.style.setProperty('--sidebar-width', `${newWidth}px`);
        });
        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = 'default';
                resizer.classList.remove('resizing');
                localStorage.setItem('sidebarWidth', this.state.sidebarWidth);
            }
        });

        await this.loadData();
        if (this.state.prompts.length === 0) await this.createWelcomePrompt();
        
        if ('serviceWorker' in navigator) { 
            try { 
                const b = new Blob([document.getElementById('sw-source').textContent], {type: 'text/javascript'}); 
                const swUrl = URL.createObjectURL(b);
                navigator.serviceWorker.register(swUrl)
                    .then(() => console.log('SW Registered'))
                    .catch(err => console.log('SW registration skipped (environment limitation):', err.message)); 
            } catch(e) {
                console.log('SW not supported in this environment');
            } 
        }

        this.renderList();
        if (this.state.prompts.length > 0) this.selectPrompt(this.state.prompts[0].id);
        
        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => { 
            if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); this.saveCurrentPrompt(false); }
            if ((e.ctrlKey || e.metaKey) && e.key === '\\') { e.preventDefault(); this.toggleCollapse(); }
        });
    },

    async loadData() {
        const [prompts, packs] = await Promise.all([db.getAll('prompts'), db.getAll('packs')]);
        this.state.prompts = prompts.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
        this.state.packs = packs;
    },

    async createWelcomePrompt() {
        const welcome = { id: uuid(), title: "Welcome to PromptVault", body: "This is a secure, offline-first vault for your prompts.\n\nTry using variables like {{Name}}.", notes: "Welcome notes", tags: ["Guide"], versions: [], createdAt: now(), updatedAt: now() };
        await db.put('prompts', welcome); 
        this.state.prompts.push(welcome);
    },

    async createNewPrompt() {
        if(this.state.dirty) {
            const choice = await this.promptUnsaved();
            if (choice === 'cancel') return;
            if (choice === 'save') await this.saveCurrentPrompt();
            this.state.dirty = false;
        }
        const newPrompt = { id: uuid(), title: "", body: "", notes: "", tags: [], versions: [], createdAt: now(), updatedAt: now() };
        await db.put('prompts', newPrompt); this.state.prompts.unshift(newPrompt);
        this.selectPrompt(newPrompt.id); 
        
        // Ensure editor view
        if(this.state.view === 'dashboard') this.toggleDashboard();
        document.getElementById('editor-title').focus();
    },

    async selectPrompt(id) {
        if (this.state.activePromptId && this.state.dirty) {
            const choice = await this.promptUnsaved();
            if (choice === 'cancel') return;
            if (choice === 'save') await this.saveCurrentPrompt();
            // Discard falls through, dirty is reset below
        }
        this.state.activePromptId = id; this.state.dirty = false;
        
        // Ensure editor view
        if(this.state.view === 'dashboard') this.toggleDashboard();
        
        this.renderList(); this.renderEditor();
        if (window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('active');
    },

    getActivePrompt() { return this.state.prompts.find(p => p.id === this.state.activePromptId); },

    async saveCurrentPrompt(silent = false) {
        const prompt = this.getActivePrompt(); if (!prompt) return;
        const title = document.getElementById('editor-title').value;
        const body = document.getElementById('editor-body').value;
        const notes = document.getElementById('notes-input').value;
        const intent = document.getElementById('intent-select').value;
        
        if (body !== prompt.body && prompt.body.trim().length > 0) {
            const wordDiff = body.length - prompt.body.length;
            const diffText = wordDiff > 0 ? `+${wordDiff} chars` : `${wordDiff} chars`;
            prompt.versions.unshift({ id: uuid(), timestamp: now(), body: prompt.body, diff: diffText });
        }
        prompt.title = title || "Untitled"; prompt.body = body; prompt.notes = notes; prompt.updatedAt = now();
        prompt.intent = intent;
        
        // Preserve new fields if they exist
        if (prompt.isPinned === undefined) prompt.isPinned = false;
        
        await db.put('prompts', prompt);
        this.state.prompts.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
        this.state.dirty = false;
        this.renderList(); this.renderVersions(); this.updateStatus();
        if (!silent) showToast("Saved");
    },

    markDirty() { this.state.dirty = true; document.getElementById('last-saved').innerText = "Unsaved Changes"; this.handleAutoSave(); },
    handleAutoSave() { clearTimeout(this.autoSaveTimeout); this.autoSaveTimeout = setTimeout(() => { if(this.state.dirty) this.saveCurrentPrompt(true); }, 5000); },

    handleBodyInput(markDirty = true) {
        if (markDirty) this.markDirty();
        const text = document.getElementById('editor-body').value;
        document.getElementById('word-count').innerText = `${text.trim() ? text.trim().split(/\s+/).length : 0} words`;
        const vars = [...new Set([...text.matchAll(/{{\s*([^}]+)\s*}}/g)].map(m => m[1]))];
        document.getElementById('detected-vars').innerHTML = vars.map(v => `<div class="variable-preview">{{${v}}}</div>`).join('');
        this.renderSuggestions(text); 
    },

    switchMetaTab(tabName) {
        // Reset Tabs
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.meta-tab-content').forEach(c => c.classList.remove('active'));
        
        // Find Active Button
        const tabs = ['overview', 'behavior', 'history', 'actions'];
        const idx = tabs.indexOf(tabName);
        if(idx > -1) document.querySelectorAll('.tab-btn')[idx].classList.add('active');
        
        // Show Content
        const content = document.getElementById(`tab-${tabName}`);
        if(content) content.classList.add('active');
        
        this.state.activeMetaTab = tabName;
    },

    // --- Helpers ---
    async confirm(msg, title="Confirmation", danger=false, okLabel=null) {
        const d = document.getElementById('dialog-confirm');
        document.getElementById('confirm-title').innerText = title;
        document.getElementById('confirm-msg').innerHTML = msg; // Changed to innerHTML to support diff view
        const btnOk = document.getElementById('btn-confirm-ok');
        btnOk.className = danger ? 'btn btn-danger' : 'btn btn-primary';
        btnOk.innerText = okLabel || (danger ? 'Delete' : 'Confirm');
        return new Promise(resolve => {
            const cleanup = () => { d.onclose = null; btnOk.onclick = null; };
            btnOk.onclick = () => { d.returnValue = 'yes'; d.close(); };
            document.getElementById('btn-confirm-cancel').onclick = () => { d.returnValue = 'cancel'; d.close(); };
            d.onclose = () => { resolve(d.returnValue === 'yes'); };
            d.showModal();
        });
    },
    async confirmTagAction(msg, title, actionLabel) {
        const d = document.getElementById('dialog-tag-confirm');
        document.getElementById('tag-confirm-title').innerText = title;
        document.getElementById('tag-confirm-msg').innerText = msg;
        const btnProceed = document.getElementById('btn-tag-confirm-proceed');
        btnProceed.innerText = actionLabel;
        
        return new Promise(resolve => {
            const cleanup = () => { d.onclose = null; btnProceed.onclick = null; };
            btnProceed.onclick = () => { d.returnValue = 'yes'; d.close(); };
            d.onclose = () => { cleanup(); resolve(d.returnValue === 'yes'); };
            d.showModal();
        });
    },
    async prompt(msg, value="", title="Input") {
        const d = document.getElementById('dialog-input');
        document.getElementById('input-title').innerText = title;
        document.getElementById('input-label').innerText = msg;
        const input = document.getElementById('input-field');
        input.value = value;
        return new Promise(resolve => {
            const cleanup = () => { d.onclose = null; document.getElementById('btn-input-ok').onclick = null; };
            document.getElementById('btn-input-ok').onclick = () => { d.returnValue = 'ok'; d.close(); };
            document.getElementById('btn-input-cancel').onclick = () => { d.returnValue = 'cancel'; d.close(); };
            d.onclose = () => { resolve(d.returnValue === 'ok' ? input.value : null); };
            d.showModal(); input.focus(); input.select();
        });
    },
    async promptUnsaved() {
        const d = document.getElementById('dialog-unsaved');
        return new Promise(resolve => {
            const cleanup = () => { d.onclose = null; document.getElementById('btn-unsaved-save').onclick = null; };
            document.getElementById('btn-unsaved-cancel').onclick = () => { d.returnValue = 'cancel'; d.close(); };
            document.getElementById('btn-unsaved-discard').onclick = () => { d.returnValue = 'discard'; d.close(); };
            document.getElementById('btn-unsaved-save').onclick = () => { d.returnValue = 'save'; d.close(); };
            d.onclose = () => { resolve(d.returnValue || 'cancel'); };
            d.showModal();
        });
    },

    // --- Smart Tag Prompt ---
    async promptTag(msg, value="", title="Input", sourceTag="") {
        const d = document.getElementById('dialog-tag-selector');
        document.getElementById('tag-selector-title').innerText = title;
        document.getElementById('tag-selector-label').innerText = msg;
        const input = document.getElementById('tag-selector-input');
        const dropdown = document.getElementById('tag-selector-dropdown');
        const hint = document.getElementById('tag-selector-hint');
        const btnOk = document.getElementById('btn-tag-selector-ok');
        
        input.value = value;
        btnOk.innerText = title.includes("Rename") ? "Rename" : "Merge";
        btnOk.disabled = true; 
        
        const tags = this.getAllTags();
        let selectedIndex = -1;

        return new Promise(resolve => {
            const cleanup = () => { d.onclose = null; btnOk.onclick = null; };
            
            const validate = () => {
                const val = input.value.trim();
                const lowerVal = val.toLowerCase();
                const lowerSource = sourceTag.toLowerCase();
                let isValid = true;
                let message = "";
                let isNew = true;

                if (!val) { isValid = false; }
                else if (lowerVal === lowerSource) { isValid = false; message = "Target cannot be same as source"; }
                else if (val.includes(',')) { isValid = false; message = "Tags cannot contain commas"; }
                
                if (isValid) {
                    const match = tags.find(t => t.name.toLowerCase() === lowerVal);
                    if (match) { 
                        isNew = false; 
                        message = `<span style="color:var(--success)">Existing tag</span> (${match.count} uses)`; 
                    } else {
                        message = `<span style="color:var(--accent)">New tag will be created</span>`;
                    }
                } else if (!message && !val) {
                    message = "Please enter a tag name";
                } else {
                    message = `<span style="color:var(--danger)">${message}</span>`;
                }

                hint.innerHTML = message;
                btnOk.disabled = !isValid;
            };

            const renderDropdown = (filter) => {
                const lowerFilter = filter.toLowerCase();
                const matches = tags.filter(t => t.name.toLowerCase().includes(lowerFilter) && t.name.toLowerCase() !== sourceTag.toLowerCase());
                
                if (matches.length === 0 || !filter) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                dropdown.innerHTML = matches.map((t, i) => `
                    <div class="autocomplete-item ${i === selectedIndex ? 'selected' : ''}" data-val="${t.name}">
                        <span>${t.name}</span>
                        <span class="count">${t.count}</span>
                    </div>
                `).join('');
                dropdown.style.display = 'block';
                
                // Click handlers
                dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                    item.onclick = () => {
                        input.value = item.dataset.val;
                        dropdown.style.display = 'none';
                        validate();
                        input.focus();
                    };
                });
            };

            input.oninput = () => {
                validate();
                selectedIndex = -1;
                renderDropdown(input.value);
            };

            input.onkeydown = (e) => {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                if (dropdown.style.display === 'block' && items.length > 0) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        selectedIndex = (selectedIndex + 1) % items.length;
                        renderDropdown(input.value);
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        selectedIndex = (selectedIndex - 1 + items.length) % items.length;
                        renderDropdown(input.value);
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (selectedIndex >= 0) {
                            input.value = items[selectedIndex].dataset.val;
                            dropdown.style.display = 'none';
                            validate();
                        } else if (!btnOk.disabled) {
                            d.returnValue = 'ok'; d.close();
                        }
                    } else if (e.key === 'Escape') {
                        dropdown.style.display = 'none';
                    }
                } else if (e.key === 'Enter' && !btnOk.disabled) {
                    d.returnValue = 'ok'; d.close();
                }
            };
            
            // Close dropdown on blur (delayed to allow click)
            input.onblur = () => { setTimeout(() => { dropdown.style.display = 'none'; }, 200); };

            btnOk.onclick = () => { d.returnValue = 'ok'; d.close(); };
            document.getElementById('btn-tag-selector-cancel').onclick = () => { d.returnValue = 'cancel'; d.close(); };
            
            d.onclose = () => { cleanup(); resolve(d.returnValue === 'ok' ? input.value.trim() : null); };
            
            // Prefill best guess if merging
            if(sourceTag && title.includes("Merge")) {
                const norm = sourceTag.toLowerCase().replace(/\s+/g, '');
                const guess = tags.find(t => t.name.toLowerCase().replace(/\s+/g, '') === norm && t.name !== sourceTag);
                if(guess) input.value = guess.name;
            }

            d.showModal();
            validate();
            input.focus();
            if(input.value) input.select();
        });
    },

    getAllTags() {
        const counts = {};
        this.state.prompts.forEach(p => {
            (p.tags || []).forEach(t => counts[t] = (counts[t] || 0) + 1);
        });
        return Object.keys(counts).map(k => ({ name: k, count: counts[k] }))
            .sort((a, b) => b.count - a.count || a.name.localeCompare(b.name));
    },

    // --- Sidebar Logic ---
    toggleCollapse(animate = true) {
        const sb = document.getElementById('sidebar');
        if (animate) sb.style.transition = 'transform 0.3s ease, width 0.3s ease'; // Note: grid column width transition is not handled by this, only the element width if it wasn't grid.
        else sb.style.transition = 'none';
        
        this.state.collapsed = !this.state.collapsed;
        
        if (this.state.collapsed) {
            sb.classList.add('collapsed');
            document.documentElement.style.setProperty('--sidebar-width', '60px');
        } else {
            sb.classList.remove('collapsed');
            document.documentElement.style.setProperty('--sidebar-width', `${this.state.sidebarWidth}px`);
        }
        
        localStorage.setItem('sidebarCollapsed', this.state.collapsed);
    },
    
    toggleMetaPanel() {
        if (window.innerWidth <= 1024) {
            document.getElementById('meta-panel').classList.toggle('active');
        } else {
            const appEl = document.getElementById('app');
            appEl.classList.toggle('meta-collapsed');
            
            // Fix: Ensure display is reset to flex if it was hidden by dashboard logic
            if (!appEl.classList.contains('meta-collapsed')) {
                document.getElementById('meta-panel').style.display = 'flex';
            }
        }
    },

    toggleDashboard() {
        const editor = document.getElementById('editor-panel');
        const dash = document.getElementById('dashboard-panel');
        const meta = document.getElementById('meta-panel');
        const appEl = document.getElementById('app');
        
        if(this.state.view === 'editor') {
            // Store previous state: is the sidebar currently visible?
            // "meta-collapsed" class present means it's closed.
            this.state.wasMetaOpen = !appEl.classList.contains('meta-collapsed');

            this.state.view = 'dashboard';
            editor.style.display = 'none';
            meta.style.display = 'none';
            dash.style.display = 'flex';
            
            // Force collapse the sidebar column so dashboard uses the space
            if (this.state.wasMetaOpen) {
                appEl.classList.add('meta-collapsed');
            }

            this.renderDashboard();
        } else {
            this.state.view = 'editor';
            dash.style.display = 'none';
            editor.style.display = 'flex';
            
            // Restore previous state
            if (this.state.wasMetaOpen) {
                // If it was open, remove collapse class and ensure element is visible
                appEl.classList.remove('meta-collapsed');
                meta.style.display = 'flex';
            } else {
                // If it was closed, ensure it stays collapsed and hidden
                if (!appEl.classList.contains('meta-collapsed')) {
                    appEl.classList.add('meta-collapsed');
                }
                meta.style.display = 'none';
            }
        }
    },

    renderDashboard() {
        // Greetings
        const hour = new Date().getHours();
        let greeting = "Hello";
        if (hour < 12) greeting = "Good Morning";
        else if (hour < 18) greeting = "Good Afternoon";
        else greeting = "Good Evening";
        document.getElementById('dashboard-welcome').innerText = greeting;
        document.getElementById('dashboard-date').innerText = new Date().toLocaleDateString(undefined, {weekday: 'long', month: 'long', day: 'numeric'});

        // Analytics
        const prompts = this.state.prompts;
        document.getElementById('stat-total').innerText = prompts.length;
        
        const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
        const usedWeek = prompts.filter(p => new Date(p.lastUsedAt).getTime() > weekAgo).length;
        document.getElementById('stat-used-week').innerText = usedWeek;
        
        const neverUsed = prompts.filter(p => !p.lastUsedAt).length;
        document.getElementById('stat-never-used').innerText = neverUsed;
        
        const mostUsed = [...prompts].sort((a,b) => (b.useCount || 0) - (a.useCount || 0))[0];
        document.getElementById('stat-most-used').innerText = mostUsed ? (mostUsed.useCount || 0) : '-';
        
        // Quick Access (Pinned)
        const pinned = prompts.filter(p => p.isPinned);
        const qaSection = document.getElementById('quick-access-section');
        const qaList = document.getElementById('quick-access-list');
        
        if (pinned.length > 0) {
            qaSection.style.display = 'block';
            qaList.innerHTML = pinned.map(p => `
                <div class="qa-card" onclick="app.selectPrompt('${p.id}')">
                    <div class="qa-title">${p.title || 'Untitled'}</div>
                    <div class="qa-actions">
                        <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); app.state.activePromptId='${p.id}'; app.triggerCopy();">Copy</button>
                        <button class="btn btn-run btn-sm" onclick="event.stopPropagation(); app.state.activePromptId='${p.id}'; app.runPrompt();">Run</button>
                    </div>
                </div>
            `).join('');
        } else {
            qaSection.style.display = 'none';
        }

        // Recent Diffs
        const recentEdits = [...prompts]
            .filter(p => p.versions && p.versions.length > 0)
            .sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt))
            .slice(0, 5);
            
        const diffContainer = document.getElementById('dashboard-diffs');
        if(recentEdits.length === 0) {
            diffContainer.innerHTML = '<div style="color:var(--text-tertiary); text-align:center;">No recent history</div>';
            return;
        }
        
        diffContainer.innerHTML = recentEdits.map(p => {
            const v = p.versions[0];
            const diffHtml = this.calculateDiff(v.body, p.body);
            return `
            <div class="diff-container">
                <div class="diff-header">
                    <div class="diff-title">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                        ${p.title || 'Untitled'}
                    </div>
                    <span class="diff-time">${this.timeAgo(p.updatedAt)} ago</span>
                </div>
                <div class="diff-content">${diffHtml}</div>
            </div>`;
        }).join('');
    },

    calculateDiff(oldText, newText) {
        const oldLines = (oldText || '').split('\n');
        const newLines = (newText || '').split('\n');
        let html = '';
        
        // Very basic line diff
        newLines.forEach(line => {
            const safeLine = this.escapeHtml(line);
            if(!oldLines.includes(line)) html += `<div class="diff-line diff-add">+ ${safeLine}</div>`;
            else html += `<div class="diff-line" style="opacity:0.5">${safeLine}</div>`;
        });
        
        // Find removed
        oldLines.forEach(line => {
            const safeLine = this.escapeHtml(line);
            if(!newLines.includes(line)) html += `<div class="diff-line diff-rem">- ${safeLine}</div>`;
        });
        
        return html || '<div style="opacity:0.5">No visible text changes</div>';
    },

    // --- Quick Filters ---
    toggleFilter(type) {
        this.state.filters[type] = !this.state.filters[type];
        
        // Update UI
        document.querySelectorAll(`.filter-chip[data-filter="${type}"]`).forEach(el => {
            if (this.state.filters[type]) el.classList.add('active');
            else el.classList.remove('active');
        });
        
        this.renderList();
    },

    // --- New Feature Methods ---

    togglePin(e, id) {
        e.stopPropagation();
        const p = this.state.prompts.find(x => x.id === id);
        if(p) {
            p.isPinned = !p.isPinned;
            db.put('prompts', p);
            this.renderList();
        }
    },
    
    updateIntent(val) {
        const p = this.getActivePrompt();
        if(p) {
            p.intent = val;
            this.saveCurrentPrompt(true);
        }
    },
    
    updateRunTarget(val) {
        const p = this.getActivePrompt();
        if(p) {
            p.runTarget = val;
            this.saveCurrentPrompt(true);
            document.getElementById('run-target-input').value = val.startsWith('http') ? val : '';
        }
    },
    
    saveRunTargetCustom(val) {
        const p = this.getActivePrompt();
        if(p) {
            p.runTarget = val;
            this.saveCurrentPrompt(true);
            document.getElementById('run-target-select').value = "";
        }
    },
    
    // Helper to restore Copy buttons in variable dialog
    resetVarButtons() {
        const footer = document.querySelector('#dialog-vars .dialog-footer');
        footer.innerHTML = `<button class="btn btn-secondary" onclick="document.getElementById('dialog-vars').close()" style="width: auto;">Cancel</button>
                            <button class="btn btn-primary" onclick="app.finalizeCopy()" style="width: auto;">Copy</button>`;
    },

    runPrompt() {
        const p = this.getActivePrompt(); if(!p) return;
        const target = p.runTarget;
        
        if(!target) {
            showToast("Please select a Run Target first", "error");
            // Switch to Behavior tab if not active
            this.switchMetaTab('behavior');
            setTimeout(() => document.getElementById('run-target-select').focus(), 100);
            return;
        }
        
        const vars = [...new Set([...p.body.matchAll(/{{\s*([^}]+)\s*}}/g)].map(m => m[1]))];
        if(vars.length > 0) {
            // Need to fill vars first
            document.getElementById('vars-form-body').innerHTML = vars.map(v => {
                const val = (p.variableDefaults && p.variableDefaults[v]) || '';
                return `<div class="form-group"><label>${v}</label><input type="text" class="form-input var-input" data-var="${v}" value="${val}" placeholder="Value for ${v}"></div>`;
            }).join('');
            
            // Temporary override for the dialog button using the new helper
            const footer = document.querySelector('#dialog-vars .dialog-footer');
            footer.innerHTML = `<button class="btn btn-secondary" onclick="document.getElementById('dialog-vars').close(); app.resetVarButtons();" style="width: auto;">Cancel</button>
                                <button class="btn btn-primary" onclick="app.finalizeRun()" style="width: auto;">Run</button>`;
            
            document.getElementById('dialog-vars').showModal();
            document.querySelector('.var-input')?.focus();
        } else {
            this.executeRun(p.body);
        }
    },
    
    finalizeRun() {
        const p = this.getActivePrompt();
        let text = p.body;
        const newDefaults = p.variableDefaults || {};
        const escapeRegExp = (s) => String(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        
        document.querySelectorAll('.var-input').forEach(i => {
            const v = i.getAttribute('data-var');
            const val = i.value;
            text = text.replace(new RegExp(`{{\\s*${escapeRegExp(v)}\\s*}}`, 'g'), val);
            newDefaults[v] = val;
        });
        
        // Save defaults
        p.variableDefaults = newDefaults;
        db.put('prompts', p); // Async save
        
        document.getElementById('dialog-vars').close();
        
        // Restore dialog button for Copy using helper
        this.resetVarButtons();
                            
        this.executeRun(text);
    },

    finalizeCopy() {
        const p = this.getActivePrompt();
        if (!p) return;

        // Use the text captured when Copy was pressed (so user copies what they intended)
        let text = this.state.pendingCopyText ?? (document.getElementById('editor-body').value || '');

        const newDefaults = p.variableDefaults || {};

        // Escape helper for safe RegExp construction
        const escapeRegExp = (s) => String(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

        document.querySelectorAll('.var-input').forEach(i => {
            const v = i.getAttribute('data-var');
            const val = i.value;

            if (!v) return;
            text = text.replace(new RegExp(`{{\\s*${escapeRegExp(v)}\\s*}}`, 'g'), val);

            // Save defaults for next time
            newDefaults[v] = val;
        });

        // Persist defaults (no need to mark dirty / overwrite body)
        p.variableDefaults = newDefaults;
        db.put('prompts', p); // async save is fine

        // Attempt copy
        const ok = this.copyToClipboard(text);
        if (ok) {
            showToast("Copied");
            document.getElementById('dialog-vars').close();
            this.resetVarButtons(); // restore footer to Copy mode
        } else {
            showToast("Copy Failed", "error");
        }
    },
    
    executeRun(text) {
        const p = this.getActivePrompt();
        if (!p || !p.runTarget) return;

        const target = String(p.runTarget || '').trim();

        // Replace all occurrences of {{prompt}} if present
        const enc = encodeURIComponent(text ?? '');
        const url = target.includes('{{prompt}}')
            ? target.split('{{prompt}}').join(enc)
            : target;

        // Copy prompt so "Run" works even when a provider doesnâ€™t support URL-prefill
        const copied = this.copyToClipboard(text, { trackUsage: false });

        // Open destination
        const w = window.open(url, '_blank', 'noopener,noreferrer');

        // Feedback
        if (!w) {
            showToast(copied ? "Copied (popup blocked)" : "Popup blocked", "error");
        } else {
            showToast(copied ? "Opened & copied (paste in new tab)" : "Opened");
        }

        // Count as "used" once
        this.markUsed(p);
    },
    updateTags(val) {
        const p = this.getActivePrompt(); if(!p) return;
        p.tags = val.split(',').map(t => t.trim()).filter(t => t);
        this.saveCurrentPrompt(true); this.renderTags(); this.renderSuggestions(p.body);
    },
    
    addTag(tag) {
        const p = this.getActivePrompt(); if(!p) return;
        if(!p.tags) p.tags = [];
        if(!p.tags.includes(tag)) {
            p.tags.push(tag);
            this.saveCurrentPrompt(true);
            this.renderTags();
            this.renderSuggestions(p.body);
        }
    },

    renderSuggestions(text) {
        const p = this.getActivePrompt(); if(!p) return;
        const suggestions = new Set(); // Was missing
        const lowerText = (p.title + ' ' + text).toLowerCase(); // Was missing
        
        Object.keys(KEYWORD_MAP).forEach(key => { // Was missing
            if (lowerText.includes(key)) {
                const tag = KEYWORD_MAP[key];
                if (!p.tags || !p.tags.includes(tag)) {
                    suggestions.add(tag);
                }
            }
        });
        
        const container = document.getElementById('tag-suggestions');
        if (suggestions.size > 0) {
            container.innerHTML = Array.from(suggestions).slice(0, 3).map(t => 
                `<div class="suggestion-chip" onclick="app.addTag('${t}')">+ ${t}</div>`
            ).join('');
            container.style.display = 'flex';
        } else {
            container.style.display = 'none';
        }
    },
    
    markUsed(p) {
        if(!p) return;
        p.lastUsedAt = now();
        p.useCount = (p.useCount || 0) + 1; // Increment use count
        db.put('prompts', p);
        // Update stats if this is the active prompt
        if (this.state.activePromptId === p.id) {
            const usageEl = document.getElementById('usage-stats');
            if (usageEl) usageEl.innerHTML = `Used ${p.useCount}Ã— &middot; Last used just now`;
        }
        if(this.state.filters.used) this.renderList();
    },

    // --- Feature 1: Auto-Filter Helper ---
    quickSearch(query) {
        document.getElementById('search-input').value = query;
        this.handleSearch(query);
    },

    // --- Advanced Search Logic ---
    parseSearchQuery(query) {
        const ops = { text: [], tag: [], pack: [], notes: [], intent: [], hasVars: false, created: [], updated: [] };
        const regex = /([a-z]+):(?:"([^"]+)"|([^\s]+))|([^\s]+)/gi;
        let match;
        
        while ((match = regex.exec(query)) !== null) {
            const key = match[1] ? match[1].toLowerCase() : null;
            const val = match[2] || match[3] || match[4];
            
            if (key === 'tag') ops.tag.push(val.toLowerCase());
            else if (key === 'pack') ops.pack.push(val.toLowerCase());
            else if (key === 'notes') ops.notes.push(val.toLowerCase());
            else if (key === 'intent') ops.intent.push(val.toLowerCase());
            else if (key === 'has' && val.toLowerCase() === 'vars') ops.hasVars = true;
            else if (key === 'created' || key === 'updated') {
                const op = val.match(/^([<>=]+)(.+)/);
                if (op) ops[key].push({ op: op[1], date: new Date(op[2]).getTime() });
            } else if (!key) {
                ops.text.push(val.toLowerCase());
            }
        }
        return ops;
    },

    matchesSearch(p, ops) {
        // Quick Filters Check
        if (this.state.filters.untagged && p.tags && p.tags.length > 0) return false;
        if (this.state.filters.hasVars && !/{{\s*[^}]+\s*}}/.test(p.body)) return false;
        if (this.state.filters.recent) {
            const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            if (new Date(p.updatedAt).getTime() < sevenDaysAgo) return false;
        }
        // Used filter is a sort, but we can also filter out never used items? No, standard is sort.
        // Let's filter out never used items if the user asks for "Used" filter, to make it useful.
        if (this.state.filters.used && !p.lastUsedAt) return false;

        // Text Match
        if (ops.text.length > 0) {
            // Include tags in search
            const fullText = (p.title + ' ' + p.body + ' ' + (p.notes||'') + ' ' + (p.tags||[]).join(' ')).toLowerCase();
            if (!ops.text.every(term => fullText.includes(term))) return false;
        }
        // Tag Match
        if (ops.tag.length > 0) {
            const pTags = (p.tags || []).map(t => t.toLowerCase());
            if (ops.tag.includes('none')) { if (pTags.length > 0) return false; } 
            else if (!ops.tag.every(t => pTags.some(pt => pt.includes(t)))) return false;
        }
        // Intent Match
        if (ops.intent.length > 0) {
            if (!p.intent) return false;
            if (!ops.intent.includes(p.intent.toLowerCase())) return false;
        }
        // Pack Match
        if (ops.pack.length > 0) {
            const myPacks = this.state.packs.filter(pk => pk.promptIds.includes(p.id)).map(pk => pk.name.toLowerCase());
            if (!ops.pack.every(name => myPacks.some(mp => mp.includes(name)))) return false;
        }
        // Notes Match
        if (ops.notes.length > 0) {
            const n = (p.notes || '').toLowerCase();
            if (!ops.notes.every(term => n.includes(term))) return false;
        }
        // Vars Match
        if (ops.hasVars && !/{{\s*[^}]+\s*}}/.test(p.body)) return false;
        
        // Date Match
        const checkDate = (ts, filters) => {
            const d = new Date(ts).getTime();
            return filters.every(f => {
                if (isNaN(f.date)) return true;
                if (f.op === '>') return d > f.date;
                if (f.op === '>=') return d >= f.date;
                if (f.op === '<') return d < f.date;
                if (f.op === '<=') return d <= f.date;
                if (f.op === '=') return Math.abs(d - f.date) < 86400000;
                return true;
            });
        };
        if (ops.created.length > 0 && !checkDate(p.createdAt, ops.created)) return false;
        if (ops.updated.length > 0 && !checkDate(p.updatedAt, ops.updated)) return false;

        return true;
    },

    handleSearch(query) {
        this.state.searchQuery = query;
        this.renderList();
        document.getElementById('search-clear').style.display = query ? 'block' : 'none';
    },
    clearSearch() {
        document.getElementById('search-input').value = '';
        this.handleSearch('');
    },
    filterUntagged() {
        document.getElementById('dialog-tag-manager').close();
        document.getElementById('search-input').value = 'tag:none';
        this.handleSearch('tag:none');
    },

    // --- Tag Manager ---
    openTagManager() {
        const tagCounts = {};
        let untagged = 0;
        this.state.prompts.forEach(p => {
            if (!p.tags || p.tags.length === 0) untagged++;
            else p.tags.forEach(t => tagCounts[t] = (tagCounts[t] || 0) + 1);
        });
        
        document.getElementById('untagged-count').innerText = untagged;
        
        const list = document.getElementById('tag-manager-list');
        list.innerHTML = Object.keys(tagCounts).sort().map(tag => `
            <div class="tag-row">
                <div class="tag-info"><span class="tag-badge">${tag}</span><span class="tag-count">${tagCounts[tag]} prompts</span></div>
                <div class="tag-actions">
                    <button class="btn btn-secondary btn-sm" onclick="app.renameTag('${tag}')">Rename</button>
                    <button class="btn btn-secondary btn-sm" onclick="app.mergeTag('${tag}')">Merge</button>
                </div>
            </div>
        `).join('') || '<div style="text-align:center; color:var(--text-tertiary); padding:20px;">No tags found.</div>';
        
        document.getElementById('dialog-tag-manager').showModal();
    },

    async renameTag(oldTag) {
        const newTag = await this.promptTag(`Rename "${oldTag}" to:`, oldTag, "Rename Tag", oldTag);
        if (!newTag || newTag.toLowerCase() === oldTag.toLowerCase()) return; 
        
        if (!(await this.confirmTagAction("This will update all prompts using this tag. Proceed?", "Confirm Rename", "Rename"))) return;
        
        await this.bulkUpdateTag(oldTag, newTag);
    },

    async mergeTag(sourceTag) {
        const targetTag = await this.promptTag(`Merge "${sourceTag}" into:`, "", "Merge Tag", sourceTag);
        if (!targetTag || targetTag.toLowerCase() === sourceTag.toLowerCase()) return;
        
        if (!(await this.confirmTagAction(`Merge all prompts from "${sourceTag}" into "${targetTag}"?`, "Confirm Merge", "Merge"))) return;
        
        await this.bulkUpdateTag(sourceTag, targetTag);
    },

    async bulkUpdateTag(oldTag, newTag) {
        let count = 0;
        const lowerOld = oldTag.toLowerCase();
        const lowerNew = newTag.toLowerCase();
        
        for (const p of this.state.prompts) {
            if (p.tags && p.tags.some(t => t.toLowerCase() === lowerOld)) {
                let newTags = p.tags.filter(t => t.toLowerCase() !== lowerOld);
                if (!newTags.some(t => t.toLowerCase() === lowerNew)) {
                    newTags.push(newTag);
                }
                
                p.tags = newTags;
                p.updatedAt = now();
                await db.put('prompts', p);
                count++;
            }
        }
        await this.loadData();
        this.openTagManager(); // Refresh UI
        this.renderList(); // Refresh Main List
        if (this.state.activePromptId) this.renderTags(); // Refresh Active View
        showToast(`Updated ${count} prompts`);
    },

    // --- Packs ---
    async createPack() {
        const name = document.getElementById('new-pack-name').value;
        if (!name) return;
        const currentPrompt = this.getActivePrompt();
        const initialIds = currentPrompt ? [currentPrompt.id] : [];
        const pack = { id: uuid(), name: name, promptIds: initialIds };
        await db.put('packs', pack); this.state.packs.push(pack);
        document.getElementById('dialog-pack').close(); document.getElementById('new-pack-name').value = '';
        this.renderPacks(); showToast("Pack Created");
    },
    async deletePack(id) {
        if(!(await this.confirm("Delete this pack?", "Delete Pack", true))) return;
        await db.delete('packs', id); this.state.packs = this.state.packs.filter(p => p.id !== id);
        this.renderPacks(); this.openManagePacks();
    },
    async renamePack(id) {
        const pack = this.state.packs.find(p => p.id === id);
        const name = await this.prompt("New Pack Name:", pack.name, "Rename Pack");
        if(name) { pack.name = name; await db.put('packs', pack); this.renderPacks(); this.openManagePacks(); }
    },
    async togglePackInclusion(packId, isChecked) {
        const currentPrompt = this.getActivePrompt(); if(!currentPrompt) return;
        const pack = this.state.packs.find(p => p.id === packId); if (!pack) return;
        if (isChecked && !pack.promptIds.includes(currentPrompt.id)) { pack.promptIds.push(currentPrompt.id); showToast("Added to pack"); }
        else if (!isChecked) { pack.promptIds = pack.promptIds.filter(id => id !== currentPrompt.id); showToast("Removed from pack"); }
        await db.put('packs', pack); this.renderPacks();
    },
    openManagePacks() {
        const container = document.getElementById('manage-packs-list');
        container.innerHTML = this.state.packs.map(p => `
            <div class="manage-pack-item"><span style="font-weight:600">${p.name}</span><div class="pack-actions"><button class="v-btn" onclick="app.previewPack('${p.id}')">View</button><button class="v-btn" onclick="app.renamePack('${p.id}')">Rename</button><button class="v-btn danger" onclick="app.deletePack('${p.id}')">Delete</button></div></div>
        `).join('') || '<div style="color:var(--text-tertiary); text-align:center;">No packs created</div>';
        document.getElementById('dialog-manage-packs').showModal();
    },
    previewPack(id) {
        const pack = this.state.packs.find(p => p.id === id); if (!pack) return;
        const prompts = pack.promptIds.map(pid => this.state.prompts.find(x => x.id === pid)).filter(x => x);
        document.getElementById('preview-pack-title').innerText = pack.name;
        document.getElementById('preview-pack-content').innerHTML = `
            <div style="font-size:12px; color:var(--text-secondary); margin-bottom:12px;">${prompts.length} Prompts</div>
            <ul style="padding-left:20px; font-size:13px; color:var(--text-primary);">${prompts.map(p => `<li class="pack-link" onclick="app.selectPrompt('${p.id}'); document.getElementById('dialog-pack-preview').close();">${p.title}</li>`).join('')}</ul>
        `;
        document.getElementById('btn-export-pack-md').onclick = () => this.exportPackMarkdown(pack);
        document.getElementById('btn-export-pack-pvb').onclick = () => this.exportPackBundle(pack);
        document.getElementById('dialog-manage-packs').close();
        document.getElementById('dialog-pack-preview').showModal();
    },

    openPackExportPicker(format) {
        document.getElementById('dialog-settings').close();
        
        const container = document.getElementById('pack-picker-list');
        document.getElementById('pack-picker-title').innerText = `Export to .${format}`;
        
        if (this.state.packs.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 32px 16px; color: var(--text-secondary);">
                    <div style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;">ðŸ“¦</div>
                    <div style="font-weight: 500; margin-bottom: 4px;">No Packs Found</div>
                    <div style="font-size: 12px; color: var(--text-tertiary);">Create a pack first to export it.</div>
                </div>
            `;
        } else {
            container.innerHTML = this.state.packs.map(p => `
                <div class="pack-picker-item" onclick="app.triggerPackExport('${p.id}', '${format}')">
                    <span style="font-weight:600">${p.name}</span>
                    <div class="pack-actions">
                        <button class="v-btn">Select</button>
                    </div>
                </div>
            `).join('');
        }
        
        document.getElementById('dialog-pack-picker').showModal();
    },
    triggerPackExport(id, format) {
        const pack = this.state.packs.find(p => p.id === id);
        if (!pack) return;
        
        document.getElementById('dialog-pack-picker').close();

        if (format === 'md') {
            this.exportPackMarkdown(pack);
        } else if (format === 'pvb') {
            // Open setup dialog
            document.getElementById('export-bundle-pack-id').value = pack.id;
            document.getElementById('export-bundle-name').value = pack.name;
            document.getElementById('export-bundle-ver').value = "1.0.0";
            document.getElementById('export-bundle-desc').value = "";
            document.getElementById('export-bundle-author').value = "";
            document.getElementById('export-bundle-img').value = "";
            document.getElementById('dialog-export-bundle').showModal();
        }
    },
    
    confirmBundleExport() {
        const id = document.getElementById('export-bundle-pack-id').value;
        const pack = this.state.packs.find(p => p.id === id);
        if (!pack) return;

        const meta = {
            title: document.getElementById('export-bundle-name').value || pack.name,
            version: document.getElementById('export-bundle-ver').value || "1.0.0",
            description: document.getElementById('export-bundle-desc').value || "",
            author: document.getElementById('export-bundle-author').value || "",
            image: document.getElementById('export-bundle-img').value || ""
        };

        this.exportPackBundle(pack, meta);
        document.getElementById('dialog-export-bundle').close();
    },

    // --- Import/Export ---
    exportVault() { const b = new Blob([JSON.stringify({prompts: this.state.prompts, packs: this.state.packs}, null, 2)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `prompt-vault.json`; a.click(); },
    exportLibraryCSV() { const c = IO.promptsToCSV(this.state.prompts); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([c], {type: 'text/csv'})); a.download = 'library.csv'; a.click(); },
    exportPackMarkdown(p) { const pr = p.promptIds.map(pid => this.state.prompts.find(x => x.id === pid)).filter(x => x); const m = IO.packToMD(p, pr, this.APP_VERSION); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([m], {type: 'text/markdown'})); a.download = `${p.name}.md`; a.click(); },
    exportPackBundle(p, meta = {}) { 
        const pr = p.promptIds.map(pid => this.state.prompts.find(x => x.id === pid)).filter(x => x); 
        const b = IO.createBundle(p, pr, this.APP_VERSION, meta); 
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(new Blob([JSON.stringify(b, null, 2)], {type: 'application/json'})); 
        a.download = `${(meta.title || p.name).replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pvb`; 
        a.click(); 
    },
    async handleFileSelect(input) {
        const file = input.files[0]; if(!file) return;
        const ext = file.name.split('.').pop().toLowerCase();
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const text = e.target.result;
                const plan = await ImportManager.analyze(text, ext);
                document.getElementById('import-stats').innerHTML = `
                    <div class="import-stat-group"><div class="import-stat-item"><span class="stat-badge stat-new">New Prompts</span> <span>${plan.newPrompts.length}</span></div><div class="import-stat-item"><span class="stat-badge stat-new">New Packs</span> <span>${plan.newPacks.length}</span></div><div class="import-stat-item"><span class="stat-badge stat-update">Updates</span> <span>${plan.updates.length}</span></div><div class="import-stat-item"><span class="stat-badge stat-conflict">Conflicts</span> <span>${plan.conflicts.length}</span></div></div>
                `;
                document.getElementById('import-details-list').innerHTML = [...plan.newPrompts.map(p=>`<div>+ ${p.title}</div>`), ...plan.updates.map(u=>`<div style="color:var(--accent)">~ ${u.current.title}</div>`), ...plan.conflicts.map(c=>`<div style="color:var(--danger)">! ${c.current.title}</div>`)].join('');
                document.getElementById('import-conflicts-section').style.display = (plan.updates.length>0 || plan.conflicts.length>0) ? 'block' : 'none';
                document.getElementById('dialog-import-preview').showModal();
            } catch(err) { showToast("Import Failed", "error"); console.error(err); }
            input.value = '';
        }; reader.readAsText(file);
    },
    async executeImport() {
        const strats = { update: document.getElementById('import-strategy-update').value, conflict: document.getElementById('import-strategy-conflict').value };
        await ImportManager.execute(strats); await this.loadData(); this.renderList();
        document.getElementById('dialog-import-preview').close(); document.getElementById('dialog-settings').close(); showToast("Import Complete");
    },

    // --- Versioning ---
    async restoreVersion(idx) {
        const p = this.getActivePrompt();
        const v = p.versions[idx];
        const currentBody = document.getElementById('editor-body').value;
        
        // Generate a preview of changes (Current -> Old Version)
        const diffHtml = this.calculateDiff(currentBody, v.body);
        
        const msg = `
            <div style="margin-bottom:12px; font-size:13px; color:var(--text-secondary);">
                Current content will be overwritten. A backup snapshot will be created.
            </div>
            <div class="diff-container" style="max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px;">
                <div class="diff-content" style="font-size: 12px;">${diffHtml}</div>
            </div>
        `;

        if (!(await this.confirm(msg, "Restore Version"))) return;
        
        if (currentBody !== v.body) p.versions.unshift({ id: uuid(), timestamp: now(), body: currentBody, diff: 'Pre-restore snapshot' });
        p.body = v.body; p.updatedAt = now(); document.getElementById('editor-body').value = p.body;
        this.saveCurrentPrompt(); 
    },
    copyVersion(idx) { this.copyToClipboard(this.getActivePrompt().versions[idx].body) ? showToast("Version Copied") : showToast("Copy Failed", "error"); },
    async deleteVersion(idx) { if(!(await this.confirm("Delete snapshot?", "Delete Version", true))) return; this.getActivePrompt().versions.splice(idx, 1); this.saveCurrentPrompt(true); this.renderVersions(); },

    // --- Render ---
    timeAgo(date) {
        const seconds = Math.floor((new Date() - new Date(date)) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + "y";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + "mo";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + "d";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + "h";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + "m";
        return "now";
    },

    renderList() {
        const el = document.getElementById('prompt-list'); el.innerHTML = '';
        const ops = this.parseSearchQuery(this.state.searchQuery || '');
        const items = this.state.prompts.filter(p => this.matchesSearch(p, ops));
        
        // Sorting Logic
        items.sort((a, b) => {
            // If 'Used' filter is active, sort by lastUsedAt
            if (this.state.filters.used) {
                return new Date(b.lastUsedAt || 0) - new Date(a.lastUsedAt || 0);
            }
            // Default: Pinned > Unpinned
            if (!!a.isPinned !== !!b.isPinned) return a.isPinned ? -1 : 1;
            // Then Recent
            return new Date(b.updatedAt) - new Date(a.updatedAt);
        });

        if (items.length === 0) { el.innerHTML = `<div style="padding:20px; text-align:center; color:var(--text-tertiary); font-size:13px;">No prompts found</div>`; return; }
        
        items.forEach(p => {
            const d = document.createElement('div'); 
            d.className = `prompt-item ${p.id === this.state.activePromptId ? 'active' : ''} ${p.isPinned ? 'pinned' : ''}`;
            d.onclick = () => this.selectPrompt(p.id);
            
            // Feature 1 & 3: Pack Chips & Clickable Tags
            const tags = (p.tags || []).filter(t => t && t.trim() !== '');
            
            // Generate clickable Tag HTML
            let tagHTML = '';
            if (tags.length > 0) {
                tagHTML += `<span class="tag-chip" onclick="event.stopPropagation(); app.quickSearch('tag:${tags[0]}')">${tags[0]}</span>`;
                if (tags.length > 1) {
                    tagHTML += tags.length > 2 
                        ? `<span class="tag-chip more">+${tags.length-1}</span>` 
                        : `<span class="tag-chip" onclick="event.stopPropagation(); app.quickSearch('tag:${tags[1]}')">${tags[1]}</span>`;
                }
            }

            // Generate clickable Pack Chips
            const myPacks = this.state.packs.filter(pk => pk.promptIds.includes(p.id));
            let packHTML = myPacks.slice(0, 2).map(pk => 
                `<span class="pack-chip" onclick="event.stopPropagation(); app.quickSearch('pack:&quot;${pk.name}&quot;')">${pk.name}</span>`
            ).join('');
            if (myPacks.length > 2) packHTML += `<span class="pack-chip" style="border:none; background:transparent; color:var(--text-tertiary);">+${myPacks.length-2}</span>`;

            const hasVars = /{{\s*[^}]+\s*}}/.test(p.body);
            const varBadge = hasVars ? `<span class="var-badge" title="Has variables">{var}</span>` : '';
            const time = this.timeAgo(p.updatedAt);
            
            // Pin Icon (conditionally styled in CSS)
            const pinIcon = `<div class="pin-btn" onclick="app.togglePin(event, '${p.id}')" title="Pin Prompt">
                <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M16 12V4h1V2H7v2h1v8l-2 2v2h5v6l1 1 1-1v-6h5v-2l-2-2z"/></svg>
            </div>`;

            d.innerHTML = `
                <div class="prompt-title"><span>${p.title || 'Untitled'}</span> ${pinIcon}</div>
                <div class="prompt-preview">${p.body}</div>
                <div class="prompt-meta">
                    <span class="meta-badges">${packHTML}${tagHTML}${varBadge}</span>
                    <span class="meta-time">${time}</span>
                </div>`;
            el.appendChild(d);
        });
    },
    renderEditor() {
        const p = this.getActivePrompt();
        const disabled = !p;
        document.getElementById('editor-title').disabled = disabled;
        document.getElementById('editor-body').disabled = disabled;
        document.getElementById('notes-input').disabled = disabled;
        document.getElementById('intent-select').disabled = disabled;
        document.getElementById('tags-input').disabled = disabled;
        
        if (!p) { 
            document.getElementById('editor-title').value=''; 
            document.getElementById('editor-body').value=''; 
            document.getElementById('notes-input').value=''; 
            document.getElementById('intent-select').value='';
            document.getElementById('run-target-select').value='';
            document.getElementById('run-target-input').value='';
            document.getElementById('usage-stats').innerHTML='';
            return; 
        }
        
        document.getElementById('editor-title').value = p.title;
        document.getElementById('editor-body').value = p.body;
        document.getElementById('notes-input').value = p.notes || '';
        document.getElementById('intent-select').value = p.intent || '';
        
        // Feature 2: Usage Stats
        const usageEl = document.getElementById('usage-stats');
        if (p.useCount > 0) {
            usageEl.innerHTML = `Used ${p.useCount}Ã— &middot; Last used ${this.timeAgo(p.lastUsedAt)} ago`;
        } else {
            usageEl.innerHTML = `Usage: Never used`;
        }

        // Run Target Logic
        const target = p.runTarget || '';
        const select = document.getElementById('run-target-select');
        const input = document.getElementById('run-target-input');
        
        // Update Preview
        let targetName = "Custom";
        if (!target) {
            targetName = "None";
        } else if (target.includes("chatgpt.com") || target.includes("openai.com")) {
            targetName = "ChatGPT";
        } else if (target.includes("gemini.google.com")) {
            targetName = "Gemini";
        } else if (target.includes("perplexity.ai")) {
            targetName = "Perplexity";
        } else if (target.includes("claude.ai")) {
            targetName = "Claude";
        } else if (target.includes("copilot.microsoft.com")) {
            targetName = "Copilot";
        }
        
        document.getElementById('preview-run-target').innerText = targetName;

        // Define the list of standard presets
        const presets = [
            // New (open pages)
            "https://chatgpt.com/",
            "https://chat.openai.com/",
            "https://gemini.google.com/app",
            "https://claude.ai/new",
            "https://copilot.microsoft.com/",
            // Templates (may prefill on some services)
            "https://chatgpt.com/?q={{prompt}}",
            "https://chat.openai.com/?q={{prompt}}",
            "https://gemini.google.com/app?q={{prompt}}",
            "https://www.perplexity.ai/search?q={{prompt}}",
            "https://claude.ai/new?q={{prompt}}",
            "https://copilot.microsoft.com/?q={{prompt}}"
        ];

        if (presets.includes(target)) {
            select.value = target;
            input.value = '';
        } else {
            select.value = "";
            input.value = target;
        }
        
        // Intent Preview (Feature 1: Clickable Intent)
        const intentEl = document.getElementById('preview-intent');
        intentEl.innerText = p.intent || "None";
        if (p.intent) {
            intentEl.className = "meta-value-preview clickable-label";
            intentEl.onclick = (e) => { e.stopPropagation(); app.quickSearch(`intent:${p.intent}`); };
        } else {
            intentEl.className = "meta-value-preview";
            intentEl.onclick = null;
        }
        
        this.handleBodyInput(false); this.renderTags(); this.renderPacks(); this.renderVersions(); this.updateStatus();
    },
    renderPacks() {
        const p = this.getActivePrompt(); if(!p) return;
        const packs = this.state.packs;
        
        // Feature 1: Clickable Pack Names in list
        document.getElementById('packs-list').innerHTML = packs.map(pack => `
            <label class="checkbox-item">
                <input type="checkbox" ${pack.promptIds.includes(p.id) ? 'checked' : ''} onchange="app.togglePackInclusion('${pack.id}', this.checked)"> 
                <span class="clickable-label" onclick="event.preventDefault(); event.stopPropagation(); app.quickSearch('pack:&quot;${pack.name}&quot;')">${pack.name}</span>
            </label>
        `).join('');
        
        // Update Pack Preview count
        const count = packs.filter(pack => pack.promptIds.includes(p.id)).length;
        document.getElementById('preview-packs').innerText = count > 0 ? `${count} packs` : "None";
    },
    renderVersions() {
        const p = this.getActivePrompt(); const list = document.getElementById('versions-list');
        if (!p || !p.versions || p.versions.length === 0) { list.innerHTML = '<div style="color:var(--text-tertiary);font-size:13px;font-style:italic;">No history yet</div>'; return; }
        
        list.innerHTML = p.versions.map((v, i) => `
            <div class="version-item" onclick="app.viewVersion(${i})">
                <div class="version-header">
                    <span class="version-date">${new Date(v.timestamp).toLocaleDateString()} ${new Date(v.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span> 
                    <span class="version-diff">${v.diff || 'Update'}</span>
                </div>
                <div style="font-size:11px; opacity:0.8; margin-top:2px;">${this.escapeHtml(v.body.substring(0, 60))}${v.body.length > 60 ? '...' : ''}</div>
                <div class="version-actions">
                    <button class="v-btn" onclick="event.stopPropagation(); app.restoreVersion(${i})">Restore</button>
                    <button class="v-btn" onclick="event.stopPropagation(); app.copyVersion(${i})">Copy</button>
                    <button class="v-btn danger" onclick="event.stopPropagation(); app.deleteVersion(${i})">Del</button>
                </div>
            </div>`).join('');
    },
    renderTags() {
        const p = this.getActivePrompt(); if(!p) return;
        document.getElementById('tags-input').value = (p.tags||[]).join(', ');
        // Feature 1: Clickable Tags in Meta Panel
        document.getElementById('active-tags').innerHTML = (p.tags||[]).map(t => `<span class="tag-badge" onclick="app.quickSearch('tag:${t}')">${t}</span>`).join('');
    },
    updateStatus() { const p = this.getActivePrompt(); if(p) document.getElementById('last-saved').innerText = `Last saved: ${new Date(p.updatedAt).toLocaleTimeString()}`; },

    // --- Version Viewing (NEW) ---
    viewVersion(idx) {
        const p = this.getActivePrompt();
        if (!p || !p.versions[idx]) return;
        const v = p.versions[idx];
        
        // Use textContent to safely render the prompt body including newlines
        document.getElementById('version-view-content').textContent = v.body;
        
        // Bind buttons
        document.getElementById('btn-view-copy').onclick = () => {
            this.copyToClipboard(v.body);
            showToast("Version Copied");
            document.getElementById('dialog-version-view').close();
        };
        
        document.getElementById('btn-view-restore').onclick = () => {
            document.getElementById('dialog-version-view').close();
            this.restoreVersion(idx); // Triggers standard restore confirmation
        };
        
        document.getElementById('dialog-version-view').showModal();
    },

    // --- Misc ---
    openDeletePromptDialog() { if(this.state.activePromptId) document.getElementById('dialog-delete-prompt').showModal(); },
    async confirmDeletePrompt() {
        await db.delete('prompts', this.state.activePromptId);
        this.state.prompts = this.state.prompts.filter(p => p.id !== this.state.activePromptId);
        this.state.packs.forEach(pk => { if(pk.promptIds.includes(this.state.activePromptId)) { pk.promptIds = pk.promptIds.filter(x => x!==this.state.activePromptId); db.put('packs', pk); } });
        document.getElementById('dialog-delete-prompt').close();
        this.state.activePromptId = null; this.renderList();
        if(this.state.prompts.length>0) this.selectPrompt(this.state.prompts[0].id); else this.renderEditor();
        showToast("Prompt Deleted");
    },
    copyToClipboard(text, opts = { trackUsage: true }) {
    if (!text) return false;

    const textArea = document.createElement("textarea");
    textArea.value = text;

    // Keep it invisible but focusable
    textArea.setAttribute("readonly", "");
    textArea.style.position = "fixed";
    textArea.style.left = "-9999px";
    textArea.style.top = "0";
    textArea.style.opacity = "0";

    // âœ… IMPORTANT: if a modal dialog is open, append inside it (focus trap safe)
    const openDialog = document.querySelector("dialog[open]");
    const mount = openDialog || document.body;

    mount.appendChild(textArea);

    // Focus + select
    textArea.focus();
    textArea.select();
    textArea.setSelectionRange(0, textArea.value.length);

    let successful = false;
    try {
        successful = document.execCommand("copy");
    } catch (err) {
        console.error("Copy failed", err);
        successful = false;
    }

    // Cleanup
    mount.removeChild(textArea);

    // Track usage only on success
    if (successful && (opts?.trackUsage !== false)) this.markUsed(this.getActivePrompt());
    return successful;
},

    triggerCopy() {
    const text = document.getElementById('editor-body').value || '';
    const regex = /{{\s*([^}]+)\s*}}/g;

    // Build unique var list (array)
    const vars = [...new Set([...text.matchAll(regex)].map(m => m[1]))];

    // No variables -> copy immediately
    if (vars.length === 0) {
        return this.copyToClipboard(text)
            ? showToast("Copied")
            : showToast("Copy Failed", "error");
    }

    // Variables exist -> show the vars dialog
    const p = this.getActivePrompt();

    // Store the text weâ€™re copying so finalizeCopy uses exactly what user saw
    this.state.pendingCopyText = text;

    document.getElementById('vars-form-body').innerHTML = vars.map(v => {
        const val = (p && p.variableDefaults && p.variableDefaults[v]) || '';
        return `<div class="form-group">
                    <label>${v}</label>
                    <input type="text" class="form-input var-input" data-var="${v}" value="${val}" placeholder="Value for ${v}">
                </div>`;
    }).join('');

    // Ensure the dialog footer buttons are the Copy ones
    this.resetVarButtons();

    // Open dialog + focus first field
    document.getElementById('dialog-vars').showModal();
    document.querySelector('.var-input')?.focus();
}
,

    escapeHtml(text) {
        if (!text) return text;
        return text.replace(/[&<>"']/g, function(m) {
            switch (m) {
                case '&': return '&amp;';
                case '<': return '&lt;';
                case '>': return '&gt;';
                case '"': return '&quot;';
                case "'": return '&#039;';
                default: return m;
            }
        });
    },

    // --- Misc Actions (Restored) ---
    async duplicateCurrentPrompt() {
        const p = this.getActivePrompt(); if (!p) return;
        const newPrompt = JSON.parse(JSON.stringify(p)); newPrompt.id = uuid(); newPrompt.title = `${newPrompt.title} (Copy)`; newPrompt.createdAt = now(); newPrompt.updatedAt = now(); newPrompt.versions = [];
        // Reset state for copy
        newPrompt.isPinned = false; newPrompt.lastUsedAt = null;
        await db.put('prompts', newPrompt); this.state.prompts.unshift(newPrompt); this.selectPrompt(newPrompt.id); showToast("Prompt Duplicated");
    },
    downloadCurrentPrompt() {
        const p = this.getActivePrompt(); if (!p) return;
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([p.body], {type: 'text/plain'})); a.download = `${p.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.txt`; a.click();
    },
    openNukeDialog() { document.getElementById('nuke-confirm-input').value = ''; document.getElementById('dialog-nuke').showModal(); },
    async confirmNuke() {
        if (document.getElementById('nuke-confirm-input').value !== 'DELETE') return showToast("Type DELETE", "error");
        await db.clear('prompts'); 
        await db.clear('packs'); 
        await db.clear('marketplace'); 
        location.reload();
    },

    async clearCache() {
        if ('caches' in window) {
            const keys = await caches.keys();
            await Promise.all(keys.map(key => caches.delete(key)));
        }
        if ('serviceWorker' in navigator) {
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map(r => r.unregister()));
        }
        showToast("Cache Cleared. Reloading...");
        setTimeout(() => location.reload(), 1000);
    },
    toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); },
    toggleSection(id) {
        const el = document.getElementById(id);
        if(el) {
            el.classList.toggle('collapsed');
            this.state.sectionState[id] = !el.classList.contains('collapsed');
            localStorage.setItem('metaSectionState', JSON.stringify(this.state.sectionState));
        }
    }
};
window.addEventListener('DOMContentLoaded', () => app.init());
</script>
</body>
</html>