<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pomodoro+</title>
  <link rel="icon" href="icon.png" type="image/png">
  <style>

:root{
  --bg:#c0c0c0;
  --panel:#d7d7d7;
  --panel2:#efefef;
  --borderDark:#7a7a7a;
  --borderLight:#ffffff;
  --text:#111;
  --accent:#0b57d0;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --sans: "MS Sans Serif", Tahoma, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}
*{box-sizing:border-box;}
html,body{height:100%;}
body{
  margin:0;
  font-family:var(--sans);
  background:var(--bg);
  color:var(--text);
}
.bevel{
  border:1px solid var(--borderDark);
  box-shadow: inset 1px 1px 0 var(--borderLight), inset -1px -1px 0 #9a9a9a;
  background:var(--panel);
}
.sunken{
  border:1px solid var(--borderDark);
  box-shadow: inset -1px -1px 0 var(--borderLight), inset 1px 1px 0 #9a9a9a;
  background:var(--panel2);
}
.app{height:100%; display:flex; flex-direction:column; gap:6px; padding:6px; min-height:0;}
.header{display:flex; align-items:center; justify-content:space-between; padding:6px 8px;}
.header h1{margin:0; font-size:14px; font-weight:700;}
.header .subtitle{font-size:12px; opacity:.85;}
.content{flex:1; padding:8px; min-height:0; overflow:auto;}
.row{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
.col{display:flex; flex-direction:column; gap:6px;}
.grid{display:grid; gap:8px;}
.btn{
  padding:4px 10px;
  background:var(--panel);
  border:1px solid var(--borderDark);
  box-shadow: inset 1px 1px 0 var(--borderLight), inset -1px -1px 0 #9a9a9a;
  cursor:pointer;
  font-size:12px;
}
.btn:active{box-shadow: inset -1px -1px 0 var(--borderLight), inset 1px 1px 0 #9a9a9a;}
.btn.primary{background: #dbe8ff;}
.btn.danger{background: #ffe0e0;}
input,select,textarea{
  font-family:var(--sans);
  font-size:12px;
}
input[type="text"], input[type="number"], input[type="date"], select, textarea{
  width:100%;
  padding:4px 6px;
}
textarea{min-height:120px; resize:vertical;}
.status{padding:4px 8px; font-size:12px; display:flex; justify-content:space-between; gap:10px;}
.badge{font-size:11px; padding:2px 6px; border-radius:3px; background:#000; color:#fff;}
hr{border:none; border-top:1px solid #b4b4b4; margin:8px 0;}
.small{font-size:11px; opacity:.85;}
.kbd{font-family:var(--mono); font-size:11px; padding:1px 4px; background:#000; color:#fff; border-radius:3px;}


  </style>
</head>
<body>
  <div class="app">
    <div class="bevel header">
      <div>
        <h1>Pomodoro+</h1>
        <div class="subtitle">Focus timer with work/break cycles and local stats.</div>
      </div>
      <div class="row">
        <span class="badge">LOCAL</span>
      </div>
    </div>
    <div class="bevel content">
      <div class="grid" style="grid-template-columns: 1fr 280px; align-items:start;">
  <div class="col" style="min-width:300px;">
    <div class="sunken" style="padding:12px;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div>
          <div class="small">Mode</div>
          <div id="modeLabel" style="font-size:14px; font-weight:700;">Work</div>
        </div>
        <div style="text-align:right;">
          <div class="small">Cycle</div>
          <div id="cycleLabel" style="font-size:12px;">1</div>
        </div>
      </div>
      <div id="time" style="font-family:var(--mono); font-size:56px; line-height:1; text-align:center; margin:16px 0 10px;">25:00</div>
      <div class="sunken" style="height:16px; padding:2px;">
        <div id="bar" style="height:100%; width:0%; background:var(--accent);"></div>
      </div>
      <div class="row" style="justify-content:center; margin-top:12px;">
        <button class="btn primary" id="startBtn">Start</button>
        <button class="btn" id="pauseBtn" disabled>Pause</button>
        <button class="btn" id="resetBtn">Reset</button>
        <button class="btn" id="skipBtn">Skip</button>
      </div>
    </div>

    <div class="sunken" style="padding:10px; margin-top:8px;">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="small">Today</div>
          <div><b id="todayWork">0</b> min focus</div>
        </div>
        <div>
          <div class="small">All-time</div>
          <div><b id="allWork">0</b> min focus</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col">
    <div class="sunken" style="padding:10px;">
      <div style="font-weight:700; margin-bottom:6px;">Settings</div>
      <div class="grid" style="grid-template-columns: 1fr 1fr;">
        <label class="small">Work (min)
          <input type="number" id="workMin" min="1" max="180" />
        </label>
        <label class="small">Break (min)
          <input type="number" id="breakMin" min="1" max="60" />
        </label>
        <label class="small">Long break (min)
          <input type="number" id="longMin" min="1" max="90" />
        </label>
        <label class="small">Long every (cycles)
          <input type="number" id="longEvery" min="2" max="12" />
        </label>
      </div>

      <div class="row" style="margin-top:8px;">
        <label class="row small" style="gap:6px;"><input type="checkbox" id="autoNext" />Auto-start next</label>
        <label class="row small" style="gap:6px;"><input type="checkbox" id="soundOn" />Sound</label>
      </div>

      <hr/>
      <div class="row">
        <button class="btn" id="saveBtn">Save settings</button>
        <button class="btn danger" id="clearStatsBtn">Clear stats</button>
      </div>
      <div class="small" style="margin-top:8px;">
        Tip: <span class="kbd">Space</span> start/pause, <span class="kbd">R</span> reset.
      </div>
    </div>
  </div>
</div>
    </div>
    <div class="bevel status" id="status">
      <span id="statusLeft">Ready.</span>
      <span id="statusRight" class="small"></span>
    </div>
  </div>

<script>
const $ = (s)=>document.querySelector(s);
const statusLeft = $("#statusLeft");
const statusRight = $("#statusRight");

const KEY = "pomodoro_v1";
const todayKey = ()=>"pomodoro_day_"+new Date().toISOString().slice(0,10);

const defaultState = {
  settings: { workMin:25, breakMin:5, longMin:15, longEvery:4, autoNext:false, soundOn:true },
  stats: { allWorkMin:0, todayWorkMinByDay:{} }
};

function load(){
  try{ return Object.assign({}, defaultState, JSON.parse(localStorage.getItem(KEY)||"{}")); }
  catch{ return structuredClone(defaultState); }
}
function save(data){ localStorage.setItem(KEY, JSON.stringify(data)); }

let data = load();
let mode = "work"; // work | break | long
let cycle = 1;
let running = false;
let startTs = null;       // performance.now at start
let remaining = data.settings.workMin*60; // seconds
let totalForMode = remaining;

function fmt(sec){
  sec = Math.max(0, Math.floor(sec));
  const m = String(Math.floor(sec/60)).padStart(2,"0");
  const s = String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}

function beep(){
  if(!data.settings.soundOn) return;
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type="square";
    o.frequency.value = 880;
    g.gain.value = 0.02;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 140);
  }catch{}
}

function setMode(next){
  mode = next;
  if(mode==="work"){ remaining = data.settings.workMin*60; }
  if(mode==="break"){ remaining = data.settings.breakMin*60; }
  if(mode==="long"){ remaining = data.settings.longMin*60; }
  totalForMode = remaining;
  startTs = null;
  updateUI();
}

function nextMode(){
  if(mode==="work"){
    // credit focus minutes (rounded down)
    const focused = Math.floor((data.settings.workMin*60 - remaining)/60);
    if(focused>0){
      data.stats.allWorkMin += focused;
      const k = todayKey();
      data.stats.todayWorkMinByDay[k] = (data.stats.todayWorkMinByDay[k]||0) + focused;
      save(data);
    }
    beep();
    if(cycle % data.settings.longEvery === 0) setMode("long");
    else setMode("break");
  }else{
    beep();
    if(mode==="long") cycle++;
    else cycle++;
    setMode("work");
  }
  if(data.settings.autoNext) start();
  else stop();
  refreshStats();
}

function start(){
  if(running) return;
  running = true;
  startTs = performance.now();
  $("#startBtn").disabled = true;
  $("#pauseBtn").disabled = false;
  statusLeft.textContent = "Running…";
}
function stop(){
  running = false;
  $("#startBtn").disabled = false;
  $("#pauseBtn").disabled = true;
  statusLeft.textContent = "Paused.";
}
function reset(){
  stop();
  cycle = 1;
  setMode("work");
  statusLeft.textContent = "Reset.";
}
function skip(){
  stop();
  remaining = 0;
  updateUI();
  nextMode();
  statusLeft.textContent = "Skipped.";
}

function tick(){
  if(running){
    const now = performance.now();
    const elapsed = (now - startTs)/1000;
    const newRemain = totalForMode - elapsed;
    remaining = newRemain;
    if(remaining <= 0){
      remaining = 0;
      updateUI();
      nextMode();
      startTs = performance.now();
    }else{
      updateUI();
    }
  }
  const d = new Date();
  statusRight.textContent = d.toLocaleString();
  requestAnimationFrame(tick);
}

function updateUI(){
  $("#time").textContent = fmt(remaining);
  $("#modeLabel").textContent = mode==="work" ? "Work" : (mode==="break" ? "Break" : "Long Break");
  $("#cycleLabel").textContent = String(cycle);
  const pct = totalForMode ? (1 - remaining/totalForMode)*100 : 0;
  $("#bar").style.width = Math.max(0, Math.min(100, pct)) + "%";
  document.title = $("#modeLabel").textContent + " • " + $("#time").textContent;
}

function refreshStats(){
  $("#todayWork").textContent = String(data.stats.todayWorkMinByDay[todayKey()]||0);
  $("#allWork").textContent = String(data.stats.allWorkMin||0);
}

function loadSettingsUI(){
  $("#workMin").value = data.settings.workMin;
  $("#breakMin").value = data.settings.breakMin;
  $("#longMin").value = data.settings.longMin;
  $("#longEvery").value = data.settings.longEvery;
  $("#autoNext").checked = !!data.settings.autoNext;
  $("#soundOn").checked = !!data.settings.soundOn;
}

$("#startBtn").addEventListener("click", start);
$("#pauseBtn").addEventListener("click", stop);
$("#resetBtn").addEventListener("click", reset);
$("#skipBtn").addEventListener("click", skip);

$("#saveBtn").addEventListener("click", ()=>{
  data.settings.workMin = Math.max(1, Math.min(180, Number($("#workMin").value)||25));
  data.settings.breakMin = Math.max(1, Math.min(60, Number($("#breakMin").value)||5));
  data.settings.longMin = Math.max(1, Math.min(90, Number($("#longMin").value)||15));
  data.settings.longEvery = Math.max(2, Math.min(12, Number($("#longEvery").value)||4));
  data.settings.autoNext = $("#autoNext").checked;
  data.settings.soundOn = $("#soundOn").checked;
  save(data);
  setMode(mode); // refresh remaining based on settings for current mode
  statusLeft.textContent = "Settings saved.";
});

$("#clearStatsBtn").addEventListener("click", ()=>{
  if(!confirm("Clear focus stats?")) return;
  data.stats = { allWorkMin:0, todayWorkMinByDay:{} };
  save(data);
  refreshStats();
  statusLeft.textContent = "Stats cleared.";
});

window.addEventListener("keydown", (e)=>{
  if(e.target && ["INPUT","TEXTAREA","SELECT"].includes(e.target.tagName)) return;
  if(e.code==="Space"){ e.preventDefault(); running ? stop() : start(); }
  if(e.key.toLowerCase()==="r"){ reset(); }
});

loadSettingsUI();
setMode("work");
refreshStats();
requestAnimationFrame(tick);
</script>
</body>
</html>