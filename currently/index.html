
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Primary Meta Tags -->
<title>Currently – Fast, Local-First RSS Reader</title>
<meta name="title" content="Currently – Fast, Local-First RSS Reader" />
<meta name="description" content="Save articles for later, filter unread stories, and search headlines instantly. Feeds cache locally for speed and refresh quietly on your schedule." />

<!-- Favicon configuration -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Cdefs%3E%3ClinearGradient%20id%3D%22grad%22%20x1%3D%220%25%22%20y1%3D%220%25%22%20x2%3D%22100%25%22%20y2%3D%22100%25%22%3E%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23c1e9ec%22%20%2F%3E%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23ffffff%22%20%2F%3E%3C%2FlinearGradient%3E%3C%2Fdefs%3E%3Crect%20width%3D%22100%22%20height%3D%22100%22%20rx%3D%2225%22%20fill%3D%22url(%23grad)%22%2F%3E%3Ctext%20x%3D%2250%22%20y%3D%2252%22%20font-family%3D%22system-ui%2C%20-apple-system%2C%20sans-serif%22%20font-size%3D%2282%22%20text-anchor%3D%22middle%22%20dominant-baseline%3D%22middle%22%20fill%3D%22%23ffffff%22%3E%F0%9F%93%96%3C%2Ftext%3E%3C%2Fsvg%3E">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="manifest" href="/site.webmanifest">

<!-- Open Graph -->
<meta property="og:type" content="website" />
<meta property="og:url" content="https://stefone.com/currently/" />
<meta property="og:title" content="Currently – Fast, Local-First RSS Reader" />
<meta property="og:description" content="Save articles for later, filter unread stories, and search headlines instantly. Feeds cache locally for speed and refresh quietly on your schedule." />
<meta property="og:image" content="https://stefone.com/assets/thumbs/currently.png" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:image:alt" content="Currently – Fast, Local-First RSS Reader preview" />

<!-- Twitter / X -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Currently – Fast, Local-First RSS Reader" />
<meta name="twitter:description" content="Save articles for later, filter unread stories, and search headlines instantly. Feeds cache locally for speed and refresh quietly on your schedule." />
<meta name="twitter:image" content="https://stefone.com/assets/thumbs/currently.png" />

<!-- Optional -->
<meta name="theme-color" content="#c1e9ec">

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            400: '#818cf8',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            900: '#312e81',
                        }
                    }
                }
            }
        }
    </script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Line clamping */
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-4 { display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-6 { display: -webkit-box; -webkit-line-clamp: 6; -webkit-box-orient: vertical; overflow: hidden; }

        /* Smooth animations */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(10px); }
        .slide-down { animation: slideDown 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; transform: translateY(-100%); opacity: 0; }
        
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { to { transform: translateY(0); opacity: 1; } }

        /* Wizard Animations */
        .wizard-step { display: none; opacity: 0; pointer-events: none; }
        .wizard-step.active-step { display: flex; opacity: 1; pointer-events: auto; animation: floatUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes floatUp { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .interest-card { border-width: 2px; border-color: transparent; }
        .interest-card.selected { border-color: #6366f1; background-color: rgba(99, 102, 241, 0.05); }
        .dark .interest-card.selected { background-color: rgba(99, 102, 241, 0.15); }
        
        .pref-card { border-width: 2px; border-color: transparent; transition: all 0.2s; }
        .pref-card.selected { border-color: #6366f1; background-color: rgba(99, 102, 241, 0.05); }
        .dark .pref-card.selected { background-color: rgba(99, 102, 241, 0.15); }

        /* Drag and drop cue */
        .drag-over-feed { border-top: 2px solid #6366f1; }
        .drag-over-folder { background-color: rgba(99, 102, 241, 0.1); border-radius: 0.5rem; }
        
        /* Glass effect */
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .dark .glass { background: rgba(30, 41, 59, 0.85); border-color: rgba(255,255,255,0.05); }

        /* Custom Theme Overrides */
        /* OLED Theme - True Black Restyled */
        html.theme-oled body { background-color: #000000 !important; color: #e5e5e5 !important; }
        html.theme-oled .bg-slate-950, html.theme-oled .dark\:bg-slate-950,
        html.theme-oled .bg-slate-900, html.theme-oled .dark\:bg-slate-900,
        html.theme-oled .dark\:bg-slate-900\/50, html.theme-oled .dark\:bg-slate-900\/40, 
        html.theme-oled .dark\:bg-slate-900\/80, html.theme-oled .dark\:bg-slate-800\/40 { 
            background-color: #000000 !important; 
        }
        
        /* Subtle interactive surfaces */
        html.theme-oled .bg-slate-800, html.theme-oled .dark\:bg-slate-800 { background-color: #0a0a0a !important; }
        html.theme-oled .dark\:hover\:bg-slate-800:hover { background-color: #141414 !important; }
        
        /* Ultra-subtle borders to separate pure black elements */
        html.theme-oled .border-slate-800, html.theme-oled .dark\:border-slate-800,
        html.theme-oled .dark\:border-slate-800\/50, html.theme-oled .dark\:border-slate-800\/60 { 
            border-color: #1a1a1a !important; 
        }
        html.theme-oled .border-slate-700, html.theme-oled .dark\:border-slate-700 { border-color: #262626 !important; }
        
        /* Modals and floating elements */
        html.theme-oled #articleModalContent, html.theme-oled #settingsModalContent,
        html.theme-oled #addFeedModalContent, html.theme-oled #addFolderModalContent,
        html.theme-oled #confirmModalContent {
            background-color: #000000 !important;
            border-color: #262626 !important;
            box-shadow: 0 25px 50px -12px rgba(255, 255, 255, 0.05);
        }

        /* Top Nav Glass */
        html.theme-oled .glass, html.theme-oled header.glass {
            background: rgba(0, 0, 0, 0.85) !important;
            border-bottom-color: #1a1a1a !important;
        }

        /* Adjust brand highlights to be dimmer on black */
        html.theme-oled .dark\:bg-brand-900\/20, html.theme-oled .dark\:bg-brand-900\/30,
        html.theme-oled .dark\:bg-brand-900\/40, html.theme-oled .dark\:bg-brand-900\/50 {
            background-color: rgba(99, 102, 241, 0.08) !important;
        }
        
        /* Sepia Theme */
        html.theme-sepia body { background-color: #f4ecd8 !important; color: #433422 !important; }
        html.theme-sepia .bg-white, html.theme-sepia .bg-slate-50, html.theme-sepia .dark\:bg-slate-900 { background-color: #fff8e7 !important; }
        html.theme-sepia .bg-slate-100, html.theme-sepia .dark\:bg-slate-800 { background-color: #eaddc5 !important; }
        html.theme-sepia .border-slate-200, html.theme-sepia .border-slate-100, html.theme-sepia .dark\:border-slate-800 { border-color: #d6c6a9 !important; }
        html.theme-sepia .border-slate-200\/50, html.theme-sepia .border-slate-100\/50 { border-color: rgba(214, 198, 169, 0.5) !important; }
        html.theme-sepia .text-slate-800, html.theme-sepia .text-slate-900, html.theme-sepia .dark\:text-white { color: #2c2216 !important; }
        html.theme-sepia .text-slate-600, html.theme-sepia .text-slate-500, html.theme-sepia .dark\:text-slate-400 { color: #5c4b37 !important; }
        html.theme-sepia .text-slate-400 { color: #8a735a !important; }

        /* Reader Mode specific transitions */
        .reader-mode-transition { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Article Modal Full Content Formatting */
        #articleModalDescription { word-wrap: break-word; overflow-wrap: break-word; }
        #articleModalDescription p, #articleModalDescription ul, #articleModalDescription ol { margin-bottom: 1.25em; }
        #articleModalDescription img, #articleModalDescription video, #articleModalDescription audio { max-width: 100%; height: auto; border-radius: 0.75rem; margin: 1.5em auto; display: block; }
        #articleModalDescription a { color: #4f46e5; text-decoration: underline; text-underline-offset: 2px; transition: color 0.2s; }
        #articleModalDescription a:hover { color: #4338ca; }
        .dark #articleModalDescription a { color: #818cf8; }
        .dark #articleModalDescription a:hover { color: #a5b4fc; }
        #articleModalDescription h1, #articleModalDescription h2, #articleModalDescription h3, #articleModalDescription h4, #articleModalDescription h5, #articleModalDescription h6 { font-weight: 700; margin-top: 1.5em; margin-bottom: 0.75em; line-height: 1.3; color: inherit; }
        #articleModalDescription h1 { font-size: 1.75em; }
        #articleModalDescription h2 { font-size: 1.5em; }
        #articleModalDescription h3 { font-size: 1.25em; }
        #articleModalDescription ul { list-style-type: disc; padding-left: 1.5em; }
        #articleModalDescription ol { list-style-type: decimal; padding-left: 1.5em; }
        #articleModalDescription li { margin-bottom: 0.5em; }
        #articleModalDescription blockquote { border-left: 4px solid #e2e8f0; padding-left: 1.25em; font-style: italic; color: #64748b; margin: 1.5em 0; }
        .dark #articleModalDescription blockquote { border-left-color: #334155; color: #94a3b8; }
        #articleModalDescription pre { background: #f8fafc; border-radius: 0.5rem; padding: 1.25em; overflow-x: auto; margin: 1.5em 0; border: 1px solid #e2e8f0; font-family: monospace; font-size: 0.9em; }
        .dark #articleModalDescription pre { background: #0f172a; border-color: #1e293b; }
        #articleModalDescription code { background: #f1f5f9; padding: 0.2em 0.4em; border-radius: 0.25rem; font-family: monospace; font-size: 0.9em; }
        .dark #articleModalDescription code { background: #1e293b; }
        #articleModalDescription pre code { background: transparent; padding: 0; }
        #articleModalDescription figcaption { text-align: center; font-size: 0.875em; color: #64748b; margin-top: 0.75em; }
        .dark #articleModalDescription figcaption { color: #94a3b8; }
    </style>
    <!-- Prevent dark mode flash -->
    <script>
        const initTheme = localStorage.getItem('currently_theme') || 'auto';
        const isDark = initTheme === 'dark' || initTheme === 'oled' || (initTheme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
        if (isDark) document.documentElement.classList.add('dark');
        if (initTheme === 'oled') document.documentElement.classList.add('theme-oled');
        if (initTheme === 'sepia') document.documentElement.classList.add('theme-sepia');
    </script>
</head>
<body class="bg-[#f8fafc] dark:bg-[#0f172a] text-slate-800 dark:text-slate-100 h-screen flex overflow-hidden transition-colors duration-300 antialiased relative">

    <!-- Mobile Menu Overlay -->
    <div id="mobileOverlay" class="fixed inset-0 bg-slate-900/40 dark:bg-black/60 backdrop-blur-sm z-30 hidden md:hidden transition-opacity" onclick="toggleMobileMenu()"></div>

    <!-- Notification Banner -->
    <div id="notificationBanner" class="absolute top-0 inset-x-0 z-50 bg-brand-600 dark:bg-brand-500 text-white shadow-lg hidden slide-down cursor-pointer hover:bg-brand-700 dark:hover:bg-brand-600 transition-colors" onclick="reloadWithNewStories()">
        <div class="max-w-screen-xl mx-auto px-6 py-3 flex items-center justify-center gap-3">
            <i data-lucide="bell-ring" class="w-4 h-4 animate-pulse"></i>
            <span id="notificationText" class="text-sm font-semibold tracking-wide">New stories available. Click to refresh.</span>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="bg-white dark:bg-slate-900 w-72 h-full border-r border-slate-200/60 dark:border-slate-800 flex flex-col fixed md:relative z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out shadow-2xl md:shadow-none">
        
        <!-- Header / Branding -->
        <div class="p-6 pb-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-900/50">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-br from-brand-500 to-purple-600 text-white p-2.5 rounded-2xl shadow-lg shadow-brand-500/20">
                    <i data-lucide="zap" class="w-5 h-5"></i>
                </div>
                <h1 class="text-2xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-slate-800 to-slate-600 dark:from-white dark:to-slate-400">Currently</h1>
            </div>
            <button class="md:hidden absolute top-6 right-6 text-slate-400 hover:text-slate-800 dark:hover:text-white bg-slate-100 dark:bg-slate-800 p-2 rounded-full" onclick="toggleMobileMenu()">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>

        <!-- Static Views Section -->
        <div class="px-4 py-4 border-b border-slate-100 dark:border-slate-800 space-y-1">
            <button onclick="selectAllFeeds()" id="allFeedsBtn" class="w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition-all duration-200 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 font-medium group">
                <i data-lucide="layers" class="w-4 h-4 text-brand-500 group-hover:scale-110 transition-transform"></i>
                <span class="text-sm">All Feeds Digest</span>
            </button>
            <button onclick="selectSavedArticles()" id="savedArticlesBtn" class="w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition-all duration-200 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 font-medium group">
                <i data-lucide="bookmark" class="w-4 h-4 text-brand-500 group-hover:scale-110 transition-transform"></i>
                <span class="text-sm">Saved for Later</span>
                <span id="savedBadge" class="ml-auto bg-brand-100 dark:bg-brand-900/50 text-brand-600 dark:text-brand-300 text-[10px] font-bold px-2 py-0.5 rounded-full hidden">0</span>
            </button>
        </div>

        <!-- Feeds & Folders List -->
        <div class="flex-1 overflow-y-auto p-4 pt-4">
            <div class="flex items-center justify-between mb-3 px-2 py-1.5 -mx-2 rounded-lg border border-transparent transition-colors"
                 ondragover="handleDragOver(event, this, 'unassigned')"
                 ondragleave="handleDragLeave(event, this, 'unassigned')"
                 ondrop="handleDrop(event, null, 'unassigned', this)"
                 title="Drop feeds here to remove them from folders">
                <h2 class="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest pointer-events-none">My Sources</h2>
                <button onclick="openAddFolderModal()" class="text-slate-400 hover:text-brand-500 dark:hover:text-brand-400 transition-colors pointer-events-auto" title="Create Folder">
                    <i data-lucide="folder-plus" class="w-3.5 h-3.5 pointer-events-none"></i>
                </button>
            </div>
            <ul id="feedList" class="space-y-0.5">
                <!-- Folders and Feeds injected here -->
            </ul>
        </div>

        <!-- Add Feed Button & Settings -->
        <div class="p-4 border-t border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-900/50 flex gap-2">
            <button onclick="openAddFeedModal()" class="flex-1 flex justify-center items-center gap-2 bg-slate-800 dark:bg-brand-600 text-white hover:bg-slate-700 dark:hover:bg-brand-500 py-3 rounded-2xl font-semibold text-sm transition-all shadow-md hover:shadow-lg active:scale-95">
                <i data-lucide="plus" class="w-4 h-4"></i>
                Add Feed
            </button>
            <button onclick="openSettingsModal()" class="px-4 flex items-center justify-center bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 hover:text-slate-800 dark:hover:text-white rounded-2xl transition-colors shadow-sm active:scale-95" title="Settings">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 h-full flex flex-col relative w-full overflow-hidden bg-slate-50 dark:bg-slate-950">
        <!-- Top Navigation -->
        <header class="glass border-b border-slate-200/50 dark:border-slate-800/50 px-6 py-4 flex flex-col sm:flex-row items-start sm:items-center justify-between sticky top-0 z-20 gap-4 sm:gap-0 mt-0">
            <div class="flex items-center gap-4 w-full sm:w-auto mt-2 sm:mt-0">
                <button class="md:hidden text-slate-500 hover:text-slate-800 dark:hover:text-slate-200 p-2 -ml-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800" onclick="toggleMobileMenu()">
                    <i data-lucide="menu"></i>
                </button>
                <div class="truncate">
                    <h2 id="currentFeedTitle" class="text-2xl font-extrabold text-slate-800 dark:text-white truncate tracking-tight">Select a view</h2>
                    <p id="currentFeedMeta" class="text-sm text-slate-500 dark:text-slate-400 truncate font-medium mt-0.5">Waiting for selection...</p>
                </div>
            </div>

            <div class="flex items-center gap-3 w-full sm:w-auto ml-auto">
                <!-- Search Bar -->
                <div class="relative flex-1 sm:w-64 group">
                    <i data-lucide="search" class="w-4 h-4 absolute left-3.5 top-1/2 transform -translate-y-1/2 text-slate-400 group-focus-within:text-brand-500 transition-colors"></i>
                    <input type="text" id="searchInput" oninput="handleSearch(this.value)" placeholder="Search stories..." class="w-full pl-10 pr-4 py-2.5 bg-slate-100/80 dark:bg-slate-800/80 border border-transparent focus:bg-white dark:focus:bg-slate-800 rounded-2xl text-sm focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none text-slate-700 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500 transition-all shadow-sm">
                </div>

                <!-- TV Mode -->
                <button onclick="startDisplayMode()" class="p-2.5 text-slate-500 hover:text-brand-600 dark:text-slate-400 dark:hover:text-brand-400 transition-colors rounded-2xl bg-slate-100/80 dark:bg-slate-800/80 hover:bg-brand-50 dark:hover:bg-brand-900/30 shrink-0 shadow-sm" title="Presentation TV Mode">
                    <i data-lucide="tv" class="w-5 h-5"></i>
                </button>

                <!-- Dark Mode Toggle -->
                <button onclick="toggleDarkMode()" class="p-2.5 text-slate-500 hover:text-brand-600 dark:text-slate-400 dark:hover:text-brand-400 transition-colors rounded-2xl bg-slate-100/80 dark:bg-slate-800/80 hover:bg-brand-50 dark:hover:bg-brand-900/30 shrink-0 shadow-sm" title="Toggle Theme">
                    <i data-lucide="moon" id="themeIcon" class="w-5 h-5"></i>
                </button>

                <!-- Refresh -->
                <button onclick="refreshCurrentFeed()" class="p-2.5 text-slate-500 hover:text-brand-600 dark:text-slate-400 dark:hover:text-brand-400 transition-colors rounded-2xl bg-slate-100/80 dark:bg-slate-800/80 hover:bg-brand-50 dark:hover:bg-brand-900/30 shrink-0 shadow-sm group" title="Force Refresh">
                    <i data-lucide="refresh-cw" id="refreshIcon" class="w-5 h-5 group-active:rotate-180 transition-transform duration-500"></i>
                </button>
            </div>
        </header>

        <!-- Sub Controls Bar -->
        <div id="controlsBar" class="bg-white/40 dark:bg-slate-900/40 backdrop-blur-sm border-b border-slate-200/50 dark:border-slate-800/50 px-6 py-2.5 flex flex-wrap items-center justify-between gap-3 z-10 hidden">
            <div class="flex items-center gap-2">
                <select id="sortSelect" onchange="handleSortFilter()" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 text-xs font-semibold rounded-xl focus:ring-brand-500 focus:border-brand-500 block px-3 py-1.5 outline-none shadow-sm cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                    <option value="newest">Latest First</option>
                    <option value="oldest">Oldest First</option>
                </select>
                <select id="filterSelect" onchange="handleSortFilter()" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 text-xs font-semibold rounded-xl focus:ring-brand-500 focus:border-brand-500 block px-3 py-1.5 outline-none shadow-sm cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                    <option value="all">All Stories</option>
                    <option value="unread">Unread</option>
                    <option value="images">With Media</option>
                </select>
            </div>
            <button onclick="markAllAsRead()" class="text-xs font-semibold text-slate-500 hover:text-brand-600 dark:text-slate-400 dark:hover:text-brand-400 flex items-center gap-1.5 transition-colors px-2 py-1 rounded-lg hover:bg-brand-50 dark:hover:bg-brand-900/20">
                <i data-lucide="check-check" class="w-4 h-4"></i>
                Mark all read
            </button>
        </div>

        <!-- Articles Area -->
        <div id="articlesContainer" class="flex-1 overflow-y-auto p-6 md:p-8 scroll-smooth relative">
            <!-- Loading State -->
            <div id="loadingState" class="hidden absolute inset-0 flex flex-col items-center justify-center text-slate-400 dark:text-slate-500 bg-slate-50/80 dark:bg-slate-950/80 backdrop-blur-sm z-10">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-xl flex flex-col items-center border border-slate-100 dark:border-slate-700">
                    <i data-lucide="loader-2" class="w-10 h-10 animate-spin text-brand-500 mb-4"></i>
                    <p class="font-semibold text-slate-700 dark:text-slate-300">Curating stories...</p>
                </div>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden h-full flex flex-col items-center justify-center text-center max-w-md mx-auto">
                <div class="bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-900/30 text-red-500 p-6 rounded-full mb-6 shadow-sm">
                    <i data-lucide="wifi-off" class="w-12 h-12"></i>
                </div>
                <h3 class="text-2xl font-bold text-slate-800 dark:text-white mb-3 tracking-tight">Feed Unavailable</h3>
                <p id="errorMessage" class="text-slate-600 dark:text-slate-400 leading-relaxed">We couldn't reach this RSS feed. The URL might be offline or blocking external access.</p>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden h-full flex flex-col items-center justify-center text-center max-w-md mx-auto">
                <div class="bg-slate-100 dark:bg-slate-800/50 p-6 rounded-full mb-6 shadow-inner">
                    <i data-lucide="layout-grid" class="w-12 h-12 text-slate-400 dark:text-slate-500"></i>
                </div>
                <h3 id="emptyStateTitle" class="text-2xl font-bold text-slate-800 dark:text-white mb-3 tracking-tight">Welcome to Currently</h3>
                <p id="emptyStateMsg" class="text-slate-500 dark:text-slate-400 leading-relaxed">Select a news source from the sidebar to dive into the latest stories, or view your All Feeds digest.</p>
            </div>

            <!-- Grid -->
            <div id="articlesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 xl:gap-8 pb-12 max-w-[1600px] mx-auto">
                <!-- Article Cards injected here -->
            </div>
        </div>
    </main>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-slate-900/40 dark:bg-black/60 backdrop-blur-sm z-[70] flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl w-full max-w-sm p-8 transform scale-95 transition-transform duration-300 border border-slate-100 dark:border-slate-800" id="confirmModalContent">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-white tracking-tight mb-3" id="confirmModalTitle">Confirm Action</h3>
            <p class="text-sm text-slate-600 dark:text-slate-400 mb-8 leading-relaxed" id="confirmModalText">Are you sure you want to proceed?</p>
            <div class="flex gap-3">
                <button type="button" onclick="closeConfirmModal()" class="flex-1 px-4 py-3.5 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-2xl font-semibold transition-colors">Cancel</button>
                <button type="button" id="confirmModalBtn" class="flex-1 px-4 py-3.5 bg-red-600 text-white hover:bg-red-700 rounded-2xl font-semibold shadow-lg shadow-red-500/30 transition-all active:scale-95">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Add Feed Modal -->
    <div id="addFeedModal" class="fixed inset-0 bg-slate-900/40 dark:bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl w-full max-w-md p-8 transform scale-95 transition-transform duration-300 border border-slate-100 dark:border-slate-800" id="addFeedModalContent">
            <div class="flex items-center justify-between mb-8">
                <h3 class="text-2xl font-bold text-slate-800 dark:text-white tracking-tight">Add Source</h3>
                <button onclick="closeAddFeedModal()" class="text-slate-400 hover:text-slate-700 dark:hover:text-white p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors bg-slate-50 dark:bg-slate-800/50">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <form id="addFeedForm" onsubmit="handleAddFeed(event)">
                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Display Name</label>
                        <input type="text" id="feedNameInput" required placeholder="e.g., The Verge" class="w-full px-4 py-3.5 bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 text-slate-800 dark:text-white rounded-2xl focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all shadow-inner font-medium">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">RSS Endpoint URL</label>
                        <input type="text" id="feedUrlInput" required placeholder="example.com/rss.xml" class="w-full px-4 py-3.5 bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 text-slate-800 dark:text-white rounded-2xl focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all shadow-inner font-medium">
                    </div>
                    <div id="folderSelectContainer" class="hidden">
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Folder</label>
                        <select id="feedFolderInput" class="w-full px-4 py-3.5 bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 text-slate-800 dark:text-white rounded-2xl focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all shadow-inner font-medium appearance-none">
                            <option value="">None</option>
                            <!-- Folders injected here -->
                        </select>
                    </div>
                </div>
                <div class="mt-10 flex gap-3">
                    <button type="button" onclick="closeAddFeedModal()" class="flex-1 px-4 py-3.5 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-2xl font-semibold transition-colors">Cancel</button>
                    <button type="submit" class="flex-1 px-4 py-3.5 bg-brand-600 text-white hover:bg-brand-700 rounded-2xl font-semibold shadow-lg shadow-brand-500/30 transition-all active:scale-95">Add Source</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Folder Modal -->
    <div id="addFolderModal" class="fixed inset-0 bg-slate-900/40 dark:bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl w-full max-w-sm p-8 transform scale-95 transition-transform duration-300 border border-slate-100 dark:border-slate-800" id="addFolderModalContent">
            <div class="flex items-center justify-between mb-8">
                <h3 class="text-2xl font-bold text-slate-800 dark:text-white tracking-tight">New Folder</h3>
                <button onclick="closeAddFolderModal()" class="text-slate-400 hover:text-slate-700 dark:hover:text-white p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors bg-slate-50 dark:bg-slate-800/50">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="addFolderForm" onsubmit="handleAddFolder(event)">
                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Folder Name</label>
                        <input type="text" id="folderNameInput" required placeholder="e.g., Technology" class="w-full px-4 py-3.5 bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 text-slate-800 dark:text-white rounded-2xl focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all shadow-inner font-medium">
                    </div>
                </div>
                <div class="mt-10 flex gap-3">
                    <button type="button" onclick="closeAddFolderModal()" class="flex-1 px-4 py-3.5 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-2xl font-semibold transition-colors">Cancel</button>
                    <button type="submit" class="flex-1 px-4 py-3.5 bg-brand-600 text-white hover:bg-brand-700 rounded-2xl font-semibold shadow-lg shadow-brand-500/30 transition-all active:scale-95">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-slate-900/40 dark:bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl w-full max-w-md p-8 transform scale-95 transition-transform duration-300 border border-slate-100 dark:border-slate-800" id="settingsModalContent">
            <div class="flex items-center justify-between mb-8">
                <h3 class="text-2xl font-bold text-slate-800 dark:text-white tracking-tight">Preferences</h3>
                <button onclick="closeSettingsModal()" class="text-slate-400 hover:text-slate-700 dark:hover:text-white p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors bg-slate-50 dark:bg-slate-800/50">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <form id="settingsForm" onsubmit="handleSaveSettings(event)">
                <div class="space-y-5 max-h-[60vh] overflow-y-auto px-1 pr-3 -mr-2 pb-2">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Color Theme</label>
                        <select id="themeInput" class="w-full px-4 py-3.5 bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 text-slate-800 dark:text-white rounded-2xl focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all shadow-inner font-medium">
                            <option value="auto">System Auto</option>
                            <option value="light">Light Mode</option>
                            <option value="dark">Dark Mode (Slate)</option>
                            <option value="oled">OLED Dark (True Black)</option>
                            <option value="sepia">Sepia (Warm Reading)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Display Density</label>
                        <select id="densityInput" class="w-full px-4 py-3.5 bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 text-slate-800 dark:text-white rounded-2xl focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all shadow-inner font-medium">
                            <option value="comfortable">Comfortable Grid</option>
                            <option value="compact">Compact Grid</option>
                            <option value="list">List View</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Background Refresh (minutes)</label>
                        <input type="number" id="refreshIntervalInput" min="1" max="1440" required class="w-full px-4 py-3.5 bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 text-slate-800 dark:text-white rounded-2xl focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all shadow-inner font-medium">
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-2.5 leading-relaxed">Feeds load instantly from memory and update silently in the background if they exceed this age.</p>
                    </div>
                    <div class="pt-5 border-t border-slate-100 dark:border-slate-800/50">
                        <h4 class="text-sm font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2"><i data-lucide="tv" class="w-4 h-4 text-brand-500"></i> TV Presentation Mode</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-semibold text-slate-600 dark:text-slate-400 mb-2">Visual Layout</label>
                                <select id="tvLayoutInput" class="w-full px-4 py-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white rounded-xl focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all text-sm font-medium">
                                    <option value="split">Split Screen (Image Left, Text Right)</option>
                                    <option value="immersive">Immersive (Fullscreen Image + Text Overlay)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-slate-600 dark:text-slate-400 mb-2">QR Code Sharing</label>
                                <select id="tvQrCodeInput" class="w-full px-4 py-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white rounded-xl focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all text-sm font-medium">
                                    <option value="show">Show "Scan to Read" QR Code</option>
                                    <option value="hide">Hide QR Code</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-slate-600 dark:text-slate-400 mb-2">Slide Duration (seconds)</label>
                                <input type="number" id="cycleSpeedInput" min="3" max="60" required class="w-full px-4 py-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white rounded-xl focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all text-sm font-medium">
                            </div>
                        </div>
                    </div>
                    
                    <div class="pt-5 border-t border-slate-100 dark:border-slate-800/50 space-y-4">
                        <div class="flex justify-between items-center bg-slate-50 dark:bg-slate-950 p-4 rounded-2xl border border-slate-100 dark:border-slate-800/50">
                            <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Cached Data</span>
                            <button type="button" onclick="clearCache()" class="px-4 py-2 bg-white dark:bg-slate-800 border border-red-200 dark:border-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl text-xs font-bold transition-colors shadow-sm">Clear Cache</button>
                        </div>
                        <div class="flex justify-between items-center bg-slate-50 dark:bg-slate-950 p-4 rounded-2xl border border-slate-100 dark:border-slate-800/50">
                            <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Reading History</span>
                            <button type="button" onclick="clearReadHistory()" class="px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl text-xs font-bold transition-colors shadow-sm">Reset History</button>
                        </div>
                        <div class="flex justify-between items-center bg-slate-50 dark:bg-slate-950 p-4 rounded-2xl border border-slate-100 dark:border-slate-800/50">
                            <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Data Backup</span>
                            <div class="flex gap-2">
                                <button type="button" onclick="exportBackup()" class="px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl text-xs font-bold transition-colors shadow-sm" title="Export to JSON">Export</button>
                                <button type="button" onclick="triggerImport()" class="px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl text-xs font-bold transition-colors shadow-sm" title="Import from JSON">Import</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex gap-3 pt-4 border-t border-slate-100 dark:border-slate-800/50">
                    <button type="button" onclick="closeSettingsModal()" class="flex-1 px-4 py-3.5 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-2xl font-semibold transition-colors">Cancel</button>
                    <button type="submit" class="flex-1 px-4 py-3.5 bg-brand-600 text-white hover:bg-brand-700 rounded-2xl font-semibold shadow-lg shadow-brand-500/30 transition-all active:scale-95">Save Changes</button>
                </div>
            </form>
            <input type="file" id="importFileInput" accept=".json" class="hidden" onchange="handleImportData(event)">
        </div>
    </div>

    <!-- Article Preview Modal -->
    <div id="articleModal" class="fixed inset-0 bg-slate-900/60 dark:bg-black/80 backdrop-blur-md z-[60] flex items-center justify-center hidden opacity-0 transition-opacity duration-300 p-4 md:p-6">
        <div class="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl w-full max-w-4xl max-h-[95vh] flex flex-col transform scale-95 transition-transform duration-300 border border-slate-200/50 dark:border-slate-700/50 overflow-hidden reader-mode-transition" id="articleModalContent">
            
            <!-- Header with Close Button -->
            <div class="flex items-center justify-between p-4 md:px-8 md:py-5 border-b border-slate-100 dark:border-slate-800/60 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md z-10 reader-mode-transition" id="articleModalHeader">
                <div class="flex items-center gap-3">
                    <span id="articleModalDate" class="text-xs font-bold uppercase tracking-wider text-brand-600 dark:text-brand-400"></span>
                </div>
                <div class="flex items-center gap-2">
                    <!-- Nav Controls -->
                    <div class="flex items-center gap-1 mr-2 border-r border-slate-200 dark:border-slate-700 pr-3">
                        <button id="articleModalPrevBtn" onclick="navigateArticle(-1)" class="text-slate-400 hover:text-brand-500 dark:hover:text-brand-400 disabled:opacity-30 disabled:cursor-not-allowed p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" title="Previous Story">
                            <i data-lucide="chevron-left" class="w-5 h-5 pointer-events-none"></i>
                        </button>
                        <button id="articleModalNextBtn" onclick="navigateArticle(1)" class="text-slate-400 hover:text-brand-500 dark:hover:text-brand-400 disabled:opacity-30 disabled:cursor-not-allowed p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" title="Next Story">
                            <i data-lucide="chevron-right" class="w-5 h-5 pointer-events-none"></i>
                        </button>
                    </div>
                    <!-- Settings & Close Controls -->
                    <button onclick="toggleReaderMode()" id="readerModeBtn" class="text-slate-400 hover:text-brand-500 dark:text-slate-500 dark:hover:text-brand-400 p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors bg-slate-50 dark:bg-slate-800/50" title="Toggle Distraction-Free Reader Mode">
                        <i data-lucide="book-open" class="w-5 h-5"></i>
                    </button>
                    <button id="articleModalSaveBtn" onclick="toggleSaveCurrentArticle()" class="text-slate-400 hover:text-brand-500 dark:text-slate-500 dark:hover:text-brand-400 p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors bg-slate-50 dark:bg-slate-800/50" title="Save for later">
                        <i data-lucide="bookmark" id="articleModalSaveIcon" class="w-5 h-5"></i>
                    </button>
                    <button onclick="closeArticleModal()" class="text-slate-400 hover:text-slate-700 dark:text-slate-500 dark:hover:text-white p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors bg-slate-50 dark:bg-slate-800/50" title="Close">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            
            <!-- Scrollable Content -->
            <div id="articleScrollArea" class="overflow-y-auto p-6 md:p-10 flex-1 bg-slate-50/30 dark:bg-slate-900 reader-mode-transition">
                <div id="articleInnerContainer" class="reader-mode-transition">
                    <h2 id="articleModalTitle" class="text-3xl md:text-4xl font-extrabold text-slate-900 dark:text-white mb-8 leading-[1.15] tracking-tight reader-mode-transition"></h2>
                    
                    <div id="articleModalImageContainer" class="mb-10 rounded-3xl overflow-hidden bg-slate-100 dark:bg-slate-800 shadow-lg hidden reader-mode-transition">
                        <img id="articleModalImage" src="" alt="Article Image" class="w-full h-auto max-h-[500px] object-cover">
                    </div>
                    
                    <div id="articleModalDescription" class="text-lg md:text-xl text-slate-700 dark:text-slate-300 leading-relaxed whitespace-pre-line font-medium reader-mode-transition">
                        <!-- Full description goes here -->
                    </div>
                </div>
            </div>
            
            <!-- Footer Action -->
            <div class="p-6 md:p-8 border-t border-slate-100 dark:border-slate-800/60 shrink-0 bg-white dark:bg-slate-900 flex justify-end reader-mode-transition" id="articleModalFooter">
                <a id="articleModalLink" href="#" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 px-8 py-4 bg-brand-600 text-white hover:bg-brand-700 rounded-2xl font-bold shadow-xl shadow-brand-500/20 transition-all group active:scale-95">
                    Read Full Story on Source
                    <i data-lucide="arrow-right" class="w-5 h-5 group-hover:translate-x-1 transition-transform"></i>
                </a>
            </div>
        </div>
    </div>
    
    <!-- TV Presentation Mode Overlay -->
    <div id="displayModeOverlay" class="fixed inset-0 bg-black z-[200] flex flex-col hidden opacity-0 transition-opacity duration-500 text-white" ontouchstart="handleTvTouchStart(event)" ontouchend="handleTvTouchEnd(event)">
        <!-- Overlay Header -->
        <div class="p-6 md:p-8 flex justify-end items-center absolute top-0 w-full z-20 bg-gradient-to-b from-black/80 via-black/40 to-transparent pointer-events-none">
            <button onclick="stopDisplayMode()" class="opacity-30 hover:opacity-100 bg-white/10 hover:bg-white/20 p-3 rounded-full backdrop-blur-md transition-all duration-300 pointer-events-auto" title="Exit Presentation">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        
        <!-- Presentation Content -->
        <div class="flex-1 flex items-center justify-center relative overflow-hidden" id="displayModeContent">
            <!-- Blurred Background Artwork -->
            <div id="displayModeBg" class="absolute inset-0 bg-cover bg-center blur-3xl opacity-30 scale-110"></div>
            <!-- Main Content Grid -->
            <div id="displayModeInnerGrid" class="relative z-10 max-w-7xl mx-auto px-8 w-full flex flex-col md:flex-row gap-12 lg:gap-20 items-center h-full">
                <div id="displayModeImgWrapper" class="w-full md:w-1/2 rounded-[2rem] overflow-hidden shadow-2xl hidden transform transition-all duration-700">
                    <img id="displayModeImg" src="" class="w-full h-auto max-h-[70vh] object-cover">
                </div>
                <div id="displayModeTextContainer" class="w-full md:w-1/2 flex flex-col justify-center z-20">
                    <span id="displayModeDate" class="text-brand-400 font-bold uppercase tracking-widest text-sm mb-4"></span>
                    <h2 id="displayModeTitle" class="text-4xl md:text-5xl lg:text-6xl font-extrabold leading-tight tracking-tight mb-6 line-clamp-4"></h2>
                    <p id="displayModeDesc" class="text-xl md:text-2xl text-slate-300 leading-relaxed line-clamp-6 opacity-90"></p>
                </div>
            </div>
        </div>

        <!-- TV QR Code Overlay -->
        <div id="displayModeQr" class="absolute bottom-10 right-10 bg-white/95 backdrop-blur-md p-3.5 rounded-[1.25rem] shadow-2xl z-30 flex items-center gap-4 hidden transition-opacity duration-500 border border-white/20">
            <img id="displayModeQrImg" src="" class="w-16 h-16 rounded-xl border border-slate-200">
            <div class="text-slate-800 text-[13px] font-extrabold w-24 leading-snug">Scan to read on your phone</div>
        </div>
        
        <!-- Bottom Timeline / Progress Indicator -->
        <div class="h-1.5 w-full bg-white/10 z-20 relative">
            <div id="displayModeProgress" class="h-full bg-gradient-to-r from-brand-500 to-purple-500 w-0 transition-all ease-linear shadow-[0_0_10px_rgba(99,102,241,0.5)]"></div>
        </div>
    </div>

    <!-- Onboarding Setup Wizard Overlay -->
    <div id="wizardOverlay" class="fixed inset-0 z-[100] bg-[#f8fafc] dark:bg-[#0f172a] overflow-hidden flex flex-col hidden transition-opacity duration-700 opacity-0">
        <!-- Decorative Ambient Blobs -->
        <div class="absolute top-[-20%] left-[-10%] w-[50%] h-[50%] bg-brand-500/10 rounded-full blur-[120px] pointer-events-none"></div>
        <div class="absolute bottom-[-20%] right-[-10%] w-[50%] h-[50%] bg-purple-500/10 rounded-full blur-[120px] pointer-events-none"></div>
        
        <!-- Header -->
        <header class="px-6 md:px-12 py-6 flex justify-between items-center relative z-10 shrink-0">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-br from-brand-500 to-purple-600 text-white p-2 rounded-xl shadow-lg shadow-brand-500/20">
                    <i data-lucide="zap" class="w-5 h-5"></i>
                </div>
                <span class="text-2xl font-extrabold tracking-tight text-slate-800 dark:text-white">Currently</span>
            </div>
            <div class="flex gap-2.5" id="wizardProgress"></div>
            <button onclick="skipWizard()" class="text-sm font-semibold text-slate-500 hover:text-slate-800 dark:hover:text-white transition-colors bg-slate-100 dark:bg-slate-800 px-4 py-2 rounded-full">Skip Setup</button>
        </header>

        <!-- Dynamic Steps Container -->
        <div class="flex-1 overflow-y-auto flex relative z-10 p-6 w-full" id="wizardStepsContainer">
            
            <!-- Step 1: Welcome -->
            <div class="wizard-step flex-col max-w-3xl mx-auto w-full text-center m-auto" data-step="1">
                <h1 class="bg-gradient-to-br from-brand-600 to-purple-600 dark:from-brand-400 dark:to-purple-400 text-transparent bg-clip-text text-5xl md:text-7xl font-extrabold mb-6 tracking-tighter leading-tight">Curate your world.</h1>
                <p class="text-lg md:text-xl text-slate-600 dark:text-slate-400 mb-12 max-w-xl mx-auto leading-relaxed">Experience a fast, local-first RSS reader. Build a personalized feed bundle tailored exactly to your region and interests.</p>
                <div class="flex justify-center">
                    <button onclick="wizardNext()" class="flex items-center gap-2 px-10 py-5 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-full font-bold text-lg hover:bg-brand-600 dark:hover:bg-brand-400 hover:text-white shadow-2xl hover:-translate-y-1 hover:shadow-brand-500/30 transition-all duration-300">
                        Start Customizing <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Location -->
            <div class="wizard-step flex-col max-w-4xl mx-auto w-full text-center m-auto" data-step="2">
                <h2 class="text-3xl md:text-4xl font-extrabold text-slate-800 dark:text-white mb-4 tracking-tight">Where are you based?</h2>
                <p class="text-slate-500 dark:text-slate-400 mb-10 text-lg">We use this to suggest relevant top headlines and local news.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5 w-full max-w-3xl mx-auto">
                    <button onclick="wizardSetLocation('US')" class="loc-btn flex flex-col items-center p-6 bg-white dark:bg-slate-900 rounded-3xl border-2 border-slate-100 dark:border-slate-800 shadow-sm hover:shadow-md transition-all group" data-loc="US">
                        <span class="text-4xl mb-4 group-hover:scale-110 transition-transform">🇺🇸</span>
                        <span class="font-bold text-slate-800 dark:text-white">United States</span>
                    </button>
                    <button onclick="wizardSetLocation('UK')" class="loc-btn flex flex-col items-center p-6 bg-white dark:bg-slate-900 rounded-3xl border-2 border-slate-100 dark:border-slate-800 shadow-sm hover:shadow-md transition-all group" data-loc="UK">
                        <span class="text-4xl mb-4 group-hover:scale-110 transition-transform">🇬🇧</span>
                        <span class="font-bold text-slate-800 dark:text-white">United Kingdom</span>
                    </button>
                    <button onclick="wizardSetLocation('Global')" class="loc-btn flex flex-col items-center p-6 bg-white dark:bg-slate-900 rounded-3xl border-2 border-slate-100 dark:border-slate-800 shadow-sm hover:shadow-md transition-all group" data-loc="Global">
                        <span class="text-4xl mb-4 group-hover:scale-110 transition-transform">🌍</span>
                        <span class="font-bold text-slate-800 dark:text-white">Global / Other</span>
                    </button>
                </div>
                
                <div class="mt-8 text-center">
                    <button onclick="wizardAutoDetectLocation()" id="btnDetectLoc" class="inline-flex items-center justify-center gap-2 text-brand-600 dark:text-brand-400 hover:text-brand-700 font-semibold px-6 py-3 bg-brand-50 dark:bg-brand-900/20 rounded-full transition-colors">
                       <i data-lucide="crosshair" class="w-4 h-4"></i> Auto-detect from browser
                    </button>
                </div>
            </div>

            <!-- Step 3: Interests -->
            <div class="wizard-step flex-col max-w-5xl mx-auto w-full text-center m-auto py-10" data-step="3">
                <h2 class="text-3xl md:text-4xl font-extrabold text-slate-800 dark:text-white mb-4 tracking-tight">Pick your passions.</h2>
                <p class="text-slate-500 dark:text-slate-400 mb-10 text-lg">Select the topics you want to follow. We'll curate the best sources.</p>
                
                <div id="wizardInterestsGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 w-full">
                    <!-- Dynamic Grid -->
                </div>
            </div>

            <!-- Step 4: Personalization -->
            <div class="wizard-step flex-col max-w-4xl mx-auto w-full text-center m-auto" data-step="4">
                <h2 class="text-3xl md:text-4xl font-extrabold text-slate-800 dark:text-white mb-4 tracking-tight">Make it yours.</h2>
                <p class="text-slate-500 dark:text-slate-400 mb-10 text-lg">Fine-tune how you want to experience Currently.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-3xl mx-auto text-left">
                    <!-- Theme -->
                    <div class="space-y-4">
                        <h3 class="font-bold text-slate-700 dark:text-slate-300 ml-1">Color Theme</h3>
                        <div class="grid grid-cols-3 gap-3">
                            <button onclick="wizardSetPref('theme', 'light')" class="pref-theme-btn flex flex-col items-center justify-center p-4 bg-white dark:bg-slate-900 rounded-2xl border-2 border-slate-100 dark:border-slate-800 hover:border-brand-300" data-val="light">
                                <i data-lucide="sun" class="w-6 h-6 mb-2 text-amber-500"></i><span class="text-xs sm:text-sm font-semibold">Light</span>
                            </button>
                            <button onclick="wizardSetPref('theme', 'dark')" class="pref-theme-btn flex flex-col items-center justify-center p-4 bg-white dark:bg-slate-900 rounded-2xl border-2 border-slate-100 dark:border-slate-800 hover:border-brand-300" data-val="dark">
                                <i data-lucide="moon" class="w-6 h-6 mb-2 text-indigo-400"></i><span class="text-xs sm:text-sm font-semibold">Dark</span>
                            </button>
                            <button onclick="wizardSetPref('theme', 'auto')" class="pref-theme-btn flex flex-col items-center justify-center p-4 bg-white dark:bg-slate-900 rounded-2xl border-2 border-slate-100 dark:border-slate-800 hover:border-brand-300" data-val="auto">
                                <i data-lucide="monitor" class="w-6 h-6 mb-2 text-slate-500"></i><span class="text-xs sm:text-sm font-semibold">Auto</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Density -->
                    <div class="space-y-4">
                        <h3 class="font-bold text-slate-700 dark:text-slate-300 ml-1">Card Layout</h3>
                        <div class="grid grid-cols-3 gap-3">
                            <button onclick="wizardSetPref('density', 'comfortable')" class="pref-density-btn flex flex-col items-center justify-center p-4 bg-white dark:bg-slate-900 rounded-2xl border-2 border-slate-100 dark:border-slate-800 hover:border-brand-300" data-val="comfortable">
                                <i data-lucide="layout-grid" class="w-6 h-6 mb-2 text-slate-500"></i><span class="text-xs sm:text-sm font-semibold text-center leading-tight mt-1">Comfort Grid</span>
                            </button>
                            <button onclick="wizardSetPref('density', 'compact')" class="pref-density-btn flex flex-col items-center justify-center p-4 bg-white dark:bg-slate-900 rounded-2xl border-2 border-slate-100 dark:border-slate-800 hover:border-brand-300" data-val="compact">
                                <i data-lucide="grid-3x3" class="w-6 h-6 mb-2 text-slate-500"></i><span class="text-xs sm:text-sm font-semibold text-center leading-tight mt-1">Compact Grid</span>
                            </button>
                            <button onclick="wizardSetPref('density', 'list')" class="pref-density-btn flex flex-col items-center justify-center p-4 bg-white dark:bg-slate-900 rounded-2xl border-2 border-slate-100 dark:border-slate-800 hover:border-brand-300" data-val="list">
                                <i data-lucide="list" class="w-6 h-6 mb-2 text-slate-500"></i><span class="text-xs sm:text-sm font-semibold text-center leading-tight mt-1">List View</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 5: Review & Curate -->
            <div class="wizard-step flex-col max-w-3xl mx-auto w-full m-auto" data-step="5">
                <div class="text-center mb-8">
                    <h2 class="text-3xl md:text-4xl font-extrabold text-slate-800 dark:text-white mb-3 tracking-tight">Your Curated Setup</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-lg">We've assembled the perfect feed bundle for you. Tweak it if you like.</p>
                </div>
                
                <div id="wizardReviewList" class="bg-white/50 dark:bg-slate-900/50 backdrop-blur-md rounded-3xl shadow-xl border border-slate-200/60 dark:border-slate-800 p-6 max-h-[55vh] overflow-y-auto w-full">
                    <!-- Presets injected here -->
                </div>
            </div>

        </div>

        <!-- Wizard Footer Controls -->
        <footer class="px-6 md:px-12 py-6 border-t border-slate-200/50 dark:border-slate-800/50 flex justify-between items-center relative z-10 bg-white/70 dark:bg-slate-900/70 backdrop-blur-xl shrink-0 hidden" id="wizardFooter">
            <button onclick="wizardPrev()" id="wizardBtnPrev" class="px-6 py-3.5 text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full font-bold transition-all">Back</button>
            <button onclick="wizardNext()" id="wizardBtnNext" class="px-8 py-3.5 bg-brand-600 text-white rounded-full font-bold shadow-lg shadow-brand-500/30 hover:bg-brand-700 transition-all hover:-translate-y-0.5 active:scale-95">Continue</button>
        </footer>
    </div>


    <!-- Data & Script Layer -->
    <script>
        // --- Security & Parsing Utilities ---
        function sanitizeHTML(html) {
            if (!html) return '';
            const doc = new DOMParser().parseFromString(html, 'text/html');
            // Remove dangerous tags entirely
            const dangerousTags = ['script', 'style', 'iframe', 'object', 'embed', 'applet', 'meta', 'base', 'link', 'form', 'input', 'button', 'textarea', 'select'];
            dangerousTags.forEach(tag => {
                const elements = doc.querySelectorAll(tag);
                elements.forEach(el => el.remove());
            });
            
            // Remove dangerous attributes
            const allElements = doc.querySelectorAll('*');
            allElements.forEach(el => {
                Array.from(el.attributes).forEach(attr => {
                    const name = attr.name.toLowerCase();
                    if (name.startsWith('on')) {
                        el.removeAttribute(name);
                    } else if ((name === 'href' || name === 'src' || name === 'data') && attr.value.toLowerCase().trim().startsWith('javascript:')) {
                        el.removeAttribute(name);
                    }
                });
            });
            return doc.body.innerHTML;
        }

        // --- Core Application Data ---
        const DEFAULT_FEEDS = [
            { id: '1', name: 'Sky News', url: 'https://feeds.skynews.com/feeds/rss/home.xml', icon: 'globe' },
            { id: '2', name: 'BBC World', url: 'http://feeds.bbci.co.uk/news/world/rss.xml', icon: 'globe-2' },
            { id: '3', name: 'TechCrunch', url: 'https://techcrunch.com/feed/', icon: 'cpu' },
            { id: '4', name: 'The Verge', url: 'https://www.theverge.com/rss/index.xml', icon: 'smartphone' }
        ];

        // --- Wizard Curation Data Engine ---
        const INTEREST_DEFS = [
            { id: 'world', label: 'World News', icon: 'globe-2' },
            { id: 'tech', label: 'Technology', icon: 'cpu' },
            { id: 'startups', label: 'Startups', icon: 'rocket' },
            { id: 'finance', label: 'Finance', icon: 'trending-up' },
            { id: 'crypto', label: 'Crypto', icon: 'bitcoin' },
            { id: 'ai', label: 'AI & Data', icon: 'brain' },
            { id: 'design', label: 'Design', icon: 'palette' },
            { id: 'gaming', label: 'Gaming', icon: 'gamepad-2' },
            { id: 'sports', label: 'Sports', icon: 'trophy' },
            { id: 'politics', label: 'Politics', icon: 'landmark' },
            { id: 'health', label: 'Health', icon: 'heart-pulse' },
            { id: 'science', label: 'Science', icon: 'flask-conical' },
            { id: 'culture', label: 'Culture', icon: 'coffee' }
        ];

        const WIZARD_FEEDS = {
            US: [
                { name: 'NYT Top Stories', url: 'https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml', icon: 'newspaper' },
                { name: 'NPR News', url: 'https://feeds.npr.org/1001/rss.xml', icon: 'mic' }
            ],
            UK: [
                { name: 'BBC News UK', url: 'http://feeds.bbci.co.uk/news/uk/rss.xml', icon: 'newspaper' },
                { name: 'Sky News', url: 'https://feeds.skynews.com/feeds/rss/home.xml', icon: 'globe' }
            ],
            Global: [
                { name: 'BBC World', url: 'http://feeds.bbci.co.uk/news/world/rss.xml', icon: 'globe-2' },
                { name: 'Al Jazeera', url: 'https://www.aljazeera.com/xml/rss/all.xml', icon: 'globe' }
            ],
            world: [
                { name: 'Reuters World', url: 'https://omny.fm/shows/reuters-world-news/playlists/podcast.rss', icon: 'globe-2' },
                { name: 'CNN Top Stories', url: 'http://rss.cnn.com/rss/edition.rss', icon: 'radio' }
            ],
            tech: [
                { name: 'The Verge', url: 'https://www.theverge.com/rss/index.xml', icon: 'smartphone' },
                { name: 'TechCrunch', url: 'https://techcrunch.com/feed/', icon: 'cpu' },
                { name: 'Wired', url: 'https://www.wired.com/feed/rss', icon: 'zap' }
            ],
            startups: [
                { name: 'Hacker News', url: 'https://hnrss.org/frontpage', icon: 'terminal' },
                { name: 'Sifted', url: 'https://sifted.eu/feed/', icon: 'rocket' }
            ],
            finance: [
                { name: 'Financial Times', url: 'https://www.ft.com/?format=rss', icon: 'trending-up' },
                { name: 'WSJ Markets', url: 'https://feeds.a.dj.com/rss/RSSMarketsMain.xml', icon: 'pie-chart' }
            ],
            crypto: [
                { name: 'CoinDesk', url: 'https://www.coindesk.com/arc/outboundfeeds/rss/', icon: 'bitcoin' },
                { name: 'CoinTelegraph', url: 'https://cointelegraph.com/rss', icon: 'coins' }
            ],
            ai: [
                { name: 'MIT Tech Review AI', url: 'https://www.technologyreview.com/topic/artificial-intelligence/feed', icon: 'bot' },
                { name: 'KDnuggets', url: 'https://www.kdnuggets.com/feed', icon: 'brain' }
            ],
            design: [
                { name: 'Smashing Magazine', url: 'https://www.smashingmagazine.com/feed/', icon: 'pen-tool' },
                { name: 'Awwwards', url: 'https://www.awwwards.com/blog/feed/', icon: 'palette' }
            ],
            gaming: [
                { name: 'Polygon', url: 'https://www.polygon.com/rss/index.xml', icon: 'gamepad-2' },
                { name: 'IGN', url: 'https://feeds.ign.com/ign/news', icon: 'monitor' }
            ],
            sports: [
                { name: 'ESPN Top', url: 'https://www.espn.com/espn/rss/news', icon: 'trophy' },
                { name: 'Sky Sports', url: 'https://www.skysports.com/rss/12040', icon: 'medal' }
            ],
            politics: [
                { name: 'Politico', url: 'https://rss.politico.com/politics-news.xml', icon: 'landmark' },
                { name: 'Axios', url: 'https://api.axios.com/feed/', icon: 'gavel' }
            ],
            health: [
                { name: 'Healthline', url: 'https://www.healthline.com/rss', icon: 'heart-pulse' },
                { name: 'WHO News', url: 'https://www.who.int/rss-feeds/news-english.xml', icon: 'activity' }
            ],
            science: [
                { name: 'Nature', url: 'https://www.nature.com/nature.rss', icon: 'flask-conical' },
                { name: 'Science Daily', url: 'https://www.sciencedaily.com/rss/top/science.xml', icon: 'microscope' }
            ],
            culture: [
                { name: 'The New Yorker', url: 'https://www.newyorker.com/feed/everything', icon: 'coffee' },
                { name: 'Vice', url: 'https://www.vice.com/en/rss', icon: 'music' }
            ]
        };

        // --- Core State Variables ---
        let feeds = [];
        let folders = []; 
        let feedUnreadBadge = {}; 
        
        let activeFeedId = null;
        let feedCache = {}; 
        let appSettings = { refreshInterval: 15, cycleSpeed: 10, theme: 'auto', density: 'comfortable', tvLayout: 'split', tvQrCode: 'show' }; 
        
        let currentRawArticles = []; 
        let displayedArticles = []; 
        let savedArticles = []; 
        let readArticles = new Set(); 
        
        let pendingNewStoriesCount = 0;
        let isReaderMode = false;
        
        let searchQuery = '';
        let currentSort = 'newest';
        let currentFilter = 'all';

        // --- Wizard State ---
        let wizardState = {
            step: 1,
            location: 'Global',
            interests: new Set(),
            prefs: { theme: 'auto', density: 'comfortable', refresh: 15 },
            proposed: { folders: [], feeds: [] }
        };

        // --- DOM Elements ---
        const feedListEl = document.getElementById('feedList');
        const articlesGridEl = document.getElementById('articlesGrid');
        const currentFeedTitleEl = document.getElementById('currentFeedTitle');
        const currentFeedMetaEl = document.getElementById('currentFeedMeta');
        
        const loadingStateEl = document.getElementById('loadingState');
        const errorStateEl = document.getElementById('errorState');
        const emptyStateEl = document.getElementById('emptyState');
        const errorMessageEl = document.getElementById('errorMessage');
        const controlsBar = document.getElementById('controlsBar');
        const notificationBanner = document.getElementById('notificationBanner');
        
        const wizardOverlay = document.getElementById('wizardOverlay');
        const addFeedModal = document.getElementById('addFeedModal');
        const addFolderModal = document.getElementById('addFolderModal');
        const settingsModal = document.getElementById('settingsModal');
        const articleModal = document.getElementById('articleModal');

        const sidebar = document.getElementById('sidebar');
        const mobileOverlay = document.getElementById('mobileOverlay');
        let openedArticleIndex = null; 

        // --- Initialization ---
        function init() {
            lucide.createIcons();
            
            const storedSettings = localStorage.getItem('currently_settings');
            if (storedSettings) appSettings = { ...appSettings, ...JSON.parse(storedSettings) };
            
            applyTheme(appSettings.theme);

            const storedCache = localStorage.getItem('currently_cache');
            if (storedCache) { try { feedCache = JSON.parse(storedCache); } catch(e) { feedCache = {}; } }
            
            const storedSaved = localStorage.getItem('currently_saved');
            if (storedSaved) { try { savedArticles = JSON.parse(storedSaved); } catch(e) { savedArticles = []; } }
            
            const storedRead = localStorage.getItem('currently_read');
            if (storedRead) { try { readArticles = new Set(JSON.parse(storedRead)); } catch(e) { readArticles = new Set(); } }

            const storedFolders = localStorage.getItem('currently_folders');
            if(storedFolders) { try { folders = JSON.parse(storedFolders); } catch(e) {} }

            const storedBadges = localStorage.getItem('currently_badges');
            if(storedBadges) { try { feedUnreadBadge = JSON.parse(storedBadges); } catch(e) { feedUnreadBadge = {};} }

            const storedFeeds = localStorage.getItem('currently_feeds');
            if (storedFeeds) {
                try { feeds = JSON.parse(storedFeeds); } catch(e) { feeds = []; }
            }
            
            const onboarded = localStorage.getItem('currently_onboarded');
            
            if (!onboarded || feeds.length === 0) {
                launchWizard();
            } else {
                updateSavedBadge();
                renderFeedList();
                if (feeds.length > 0) selectAllFeeds();
                else showState('empty');
            }
            
            // Add global escape key listener to close presentation mode
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !document.getElementById('displayModeOverlay').classList.contains('hidden')) {
                    stopDisplayMode();
                }
            });
        }

        // --- Wizard Logic ---
        function launchWizard(isReset = false) {
            if(isReset) {
                closeSettingsModal();
                openConfirmModal('Restart Setup', 'This will replace your current feeds and folders with a fresh curated list. Continue?', 'Restart', () => {
                    startWizardEngine();
                });
            } else {
                startWizardEngine();
            }
        }

        function startWizardEngine() {
            wizardState = {
                step: 1, location: 'Global', interests: new Set(),
                prefs: { theme: appSettings.theme || 'auto', density: appSettings.density || 'comfortable', refresh: appSettings.refreshInterval || 15 },
                proposed: { folders: [], feeds: [] }
            };
            buildWizardInterestsGrid();
            wizardSetLocation(wizardState.location);
            wizardSetPref('theme', wizardState.prefs.theme);
            wizardSetPref('density', wizardState.prefs.density);
            
            renderWizardStep();
            wizardOverlay.classList.remove('hidden');
            setTimeout(() => wizardOverlay.classList.remove('opacity-0'), 10);
        }

        function renderWizardStep() {
            document.querySelectorAll('.wizard-step').forEach(el => {
                if(parseInt(el.dataset.step) === wizardState.step) el.classList.add('active-step');
                else el.classList.remove('active-step');
            });
            
            document.getElementById('wizardProgress').innerHTML = Array.from({length: 5}).map((_, i) => `
                <div class="w-2.5 h-2.5 rounded-full transition-all duration-300 ${i + 1 === wizardState.step ? 'bg-brand-500 scale-125' : (i + 1 < wizardState.step ? 'bg-brand-300 dark:bg-brand-700' : 'bg-slate-200 dark:bg-slate-800')}"></div>
            `).join('');
            
            const footer = document.getElementById('wizardFooter');
            if(wizardState.step === 1) {
                footer.classList.add('hidden');
            } else {
                footer.classList.remove('hidden');
                document.getElementById('wizardBtnPrev').style.visibility = wizardState.step > 1 ? 'visible' : 'hidden';
                document.getElementById('wizardBtnNext').textContent = wizardState.step === 5 ? 'Launch Currently' : 'Continue';
            }
        }

        function wizardNext() {
            if(wizardState.step === 4) generateWizardPresets();
            if(wizardState.step < 5) {
                wizardState.step++;
                renderWizardStep();
            } else completeWizard();
        }

        function wizardPrev() {
            if(wizardState.step > 1) {
                wizardState.step--;
                renderWizardStep();
            }
        }

        function wizardSetLocation(loc) {
            wizardState.location = loc;
            document.querySelectorAll('.loc-btn').forEach(btn => {
                if(btn.dataset.loc === loc) {
                    btn.classList.add('border-brand-500', 'bg-brand-50', 'dark:bg-brand-900/20');
                    btn.classList.remove('border-slate-100', 'dark:border-slate-800', 'bg-white', 'dark:bg-slate-900');
                } else {
                    btn.classList.remove('border-brand-500', 'bg-brand-50', 'dark:bg-brand-900/20');
                    btn.classList.add('border-slate-100', 'dark:border-slate-800', 'bg-white', 'dark:bg-slate-900');
                }
            });
        }

        function wizardAutoDetectLocation() {
            const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
            let guess = 'Global';
            if (tz.includes('Europe/London') || tz.includes('Europe/Belfast')) guess = 'UK';
            else if (tz.includes('America/')) guess = 'US';
            
            wizardSetLocation(guess);
            const btn = document.getElementById('btnDetectLoc');
            const oldHtml = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="check" class="w-4 h-4 text-green-500"></i> Detected ${guess}`;
            lucide.createIcons();
            setTimeout(() => { btn.innerHTML = oldHtml; lucide.createIcons(); }, 2000);
        }

        function buildWizardInterestsGrid() {
            const grid = document.getElementById('wizardInterestsGrid');
            grid.innerHTML = INTEREST_DEFS.map(def => `
                <button onclick="toggleWizardInterest('${def.id}')" id="int_card_${def.id}" class="interest-card flex flex-col items-center justify-center p-5 bg-white dark:bg-slate-900 rounded-3xl border shadow-sm hover:shadow-md transition-all group">
                    <div class="w-12 h-12 rounded-full bg-slate-50 dark:bg-slate-800 flex items-center justify-center mb-3 group-hover:bg-brand-50 dark:group-hover:bg-brand-900/30 transition-colors">
                        <i data-lucide="${def.icon}" class="w-6 h-6 text-slate-500 dark:text-slate-400 group-hover:text-brand-500 transition-colors"></i>
                    </div>
                    <span class="font-bold text-sm text-slate-700 dark:text-slate-300 group-hover:text-brand-600 dark:group-hover:text-brand-400">${def.label}</span>
                </button>
            `).join('');
            lucide.createIcons();
        }

        function toggleWizardInterest(id) {
            if(wizardState.interests.has(id)) wizardState.interests.delete(id);
            else wizardState.interests.add(id);
            
            const card = document.getElementById(`int_card_${id}`);
            if(wizardState.interests.has(id)) card.classList.add('selected');
            else card.classList.remove('selected');
        }

        function wizardSetPref(key, val) {
            wizardState.prefs[key] = val;
            document.querySelectorAll(`.pref-${key}-btn`).forEach(btn => {
                if(btn.dataset.val === val) {
                    btn.classList.add('border-brand-500', 'bg-brand-50', 'dark:bg-brand-900/20');
                    btn.classList.remove('border-slate-100', 'dark:border-slate-800', 'bg-white', 'dark:bg-slate-900');
                } else {
                    btn.classList.remove('border-brand-500', 'bg-brand-50', 'dark:bg-brand-900/20');
                    btn.classList.add('border-slate-100', 'dark:border-slate-800', 'bg-white', 'dark:bg-slate-900');
                }
            });
            if(key === 'theme') applyTheme(val); // Real-time preview
        }

        function generateWizardPresets() {
            let fIdCounter = 1; let feedIdCounter = 1;
            wizardState.proposed = { folders: [], feeds: [] };
            
            // Location Folder
            let localFolderId = `folder_${fIdCounter++}`;
            wizardState.proposed.folders.push({ id: localFolderId, name: 'Top Headlines', expanded: true });
            if(WIZARD_FEEDS[wizardState.location]) {
                WIZARD_FEEDS[wizardState.location].forEach(f => {
                    wizardState.proposed.feeds.push({ ...f, id: `wf_${feedIdCounter++}`, folderId: localFolderId, selected: true });
                });
            }

            // Interests Folders
            wizardState.interests.forEach(interest => {
                const def = INTEREST_DEFS.find(d => d.id === interest);
                if(def && WIZARD_FEEDS[interest]) {
                    let fId = `folder_${fIdCounter++}`;
                    wizardState.proposed.folders.push({ id: fId, name: def.label, expanded: true });
                    WIZARD_FEEDS[interest].forEach(f => {
                        wizardState.proposed.feeds.push({ ...f, id: `wf_${feedIdCounter++}`, folderId: fId, selected: true });
                    });
                }
            });

            renderWizardReview();
        }

        function renderWizardReview() {
            const list = document.getElementById('wizardReviewList');
            list.innerHTML = '';
            
            if (wizardState.proposed.folders.length === 0) {
                list.innerHTML = `<div class="text-center p-8 text-slate-500">You haven't selected any specific interests, but we'll still set you up with basic defaults!</div>`;
                return;
            }

            wizardState.proposed.folders.forEach(folder => {
                const folderFeeds = wizardState.proposed.feeds.filter(f => f.folderId === folder.id);
                if(folderFeeds.length === 0) return;
                
                let html = `
                    <div class="mb-6 last:mb-0 bg-slate-50 dark:bg-slate-800/40 rounded-2xl p-5 border border-slate-100 dark:border-slate-800">
                        <h4 class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <i data-lucide="folder" class="w-4 h-4 text-brand-500"></i> ${folder.name}
                        </h4>
                        <div class="space-y-2.5">
                `;
                
                folderFeeds.forEach(feed => {
                    html += `
                        <label class="flex items-center justify-between p-3.5 bg-white dark:bg-slate-900 rounded-xl cursor-pointer hover:shadow-md border border-slate-100 dark:border-slate-700 transition-all group">
                            <div class="flex items-center gap-3">
                                <i data-lucide="${feed.icon}" class="w-4 h-4 text-slate-400 group-hover:text-brand-500 transition-colors"></i>
                                <span class="font-semibold text-slate-800 dark:text-slate-200 text-sm">${feed.name}</span>
                            </div>
                            <input type="checkbox" checked onchange="toggleWizardFeed('${feed.id}', this.checked)" class="w-5 h-5 rounded border-slate-300 text-brand-600 focus:ring-brand-500 bg-slate-100 dark:bg-slate-800 dark:border-slate-700 accent-brand-500 cursor-pointer">
                        </label>
                    `;
                });
                html += `</div></div>`;
                list.innerHTML += html;
            });
            lucide.createIcons();
        }

        function toggleWizardFeed(id, isChecked) {
            const feed = wizardState.proposed.feeds.find(f => f.id === id);
            if(feed) feed.selected = isChecked;
        }

        function completeWizard() {
            const selectedFeeds = wizardState.proposed.feeds.filter(f => f.selected).map(f => { delete f.selected; return f; });
            
            if (selectedFeeds.length > 0) {
                feeds = selectedFeeds;
                const activeFolderIds = new Set(feeds.map(f => f.folderId));
                folders = wizardState.proposed.folders.filter(f => activeFolderIds.has(f.id));
            } else {
                feeds = [...DEFAULT_FEEDS];
                folders = [];
            }
            
            appSettings.theme = wizardState.prefs.theme;
            appSettings.density = wizardState.prefs.density;
            appSettings.refreshInterval = wizardState.prefs.refresh;
            
            saveFeeds();
            saveFolders();
            localStorage.setItem('currently_settings', JSON.stringify(appSettings));
            localStorage.setItem('currently_onboarded', 'true');
            
            applyTheme();
            
            wizardOverlay.classList.add('opacity-0');
            setTimeout(() => {
                wizardOverlay.classList.add('hidden');
                renderFeedList();
                selectAllFeeds();
            }, 700);
        }

        function skipWizard() {
            feeds = [...DEFAULT_FEEDS];
            saveFeeds();
            localStorage.setItem('currently_onboarded', 'true');
            wizardOverlay.classList.add('opacity-0');
            setTimeout(() => {
                wizardOverlay.classList.add('hidden');
                renderFeedList();
                selectAllFeeds();
            }, 700);
        }

        // --- Core Application Logic ---
        function applyTheme(themeVal) {
            if(!themeVal) themeVal = appSettings.theme || 'auto';
            const htmlClasses = document.documentElement.classList;
            
            // Remove all custom themes and the default dark class first
            htmlClasses.remove('dark', 'theme-oled', 'theme-sepia');
            
            // Determine if the base mode is dark
            const isDarkModeBase = themeVal === 'dark' || themeVal === 'oled' || (themeVal === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
            
            if (themeVal === 'sepia') {
                htmlClasses.add('theme-sepia');
            } else if (isDarkModeBase) {
                htmlClasses.add('dark');
                if (themeVal === 'oled') {
                    htmlClasses.add('theme-oled');
                }
            }
            
            updateThemeIcon();
        }

        function toggleDarkMode() {
            const currentTheme = appSettings.theme || 'auto';
            if (currentTheme === 'sepia' || currentTheme === 'light' || (!document.documentElement.classList.contains('dark') && currentTheme === 'auto')) {
                appSettings.theme = 'dark';
            } else {
                appSettings.theme = 'light';
            }
            localStorage.setItem('currently_settings', JSON.stringify(appSettings));
            applyTheme();
        }

        function updateThemeIcon() {
            const isDark = document.documentElement.classList.contains('dark');
            const isSepia = document.documentElement.classList.contains('theme-sepia');
            const iconEl = document.getElementById('themeIcon');
            if(iconEl) {
                if (isSepia) iconEl.setAttribute('data-lucide', 'coffee');
                else iconEl.setAttribute('data-lucide', isDark ? 'sun' : 'moon');
                lucide.createIcons({ root: iconEl.parentNode });
            }
        }

        function saveFeeds() { localStorage.setItem('currently_feeds', JSON.stringify(feeds)); }
        function saveFolders() { localStorage.setItem('currently_folders', JSON.stringify(folders)); }
        function saveBadges() { localStorage.setItem('currently_badges', JSON.stringify(feedUnreadBadge)); }

        // --- Modal Utility ---
        function openConfirmModal(title, text, actionText, actionCallback) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalText').textContent = text;
            const btn = document.getElementById('confirmModalBtn');
            btn.textContent = actionText;
            btn.onclick = () => { closeConfirmModal(); actionCallback(); };
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                document.getElementById('confirmModalContent').classList.remove('scale-95');
            }, 10);
        }

        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            modal.classList.add('opacity-0');
            document.getElementById('confirmModalContent').classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        // --- Folders & Sidebar ---
        function renderFeedList() {
            feedListEl.innerHTML = '';
            const grouped = { unassigned: [] };
            folders.forEach(f => grouped[f.id] = { ...f, feeds: [] });
            feeds.forEach(f => {
                if(f.folderId && grouped[f.folderId]) grouped[f.folderId].feeds.push(f);
                else grouped.unassigned.push(f);
            });

            const createFeedItem = (feed) => {
                const isActive = feed.id === activeFeedId;
                const unreadCount = feedUnreadBadge[feed.id] || 0;
                const li = document.createElement('li');
                li.className = `group flex items-center justify-between px-3 py-2.5 rounded-xl cursor-pointer transition-all duration-200 ${isActive ? 'bg-brand-50 dark:bg-brand-900/40 text-brand-700 dark:text-brand-400 font-semibold' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100/80 dark:hover:bg-slate-800/80 hover:text-slate-900 dark:hover:text-slate-200 font-medium'}`;
                li.draggable = true;
                li.ondragstart = (e) => handleDragStart(e, feed.id, 'feed');
                li.ondragover = (e) => handleDragOver(e, li, 'feed');
                li.ondragleave = (e) => handleDragLeave(e, li, 'feed');
                li.ondrop = (e) => handleDrop(e, feed.id, 'feed', li);
                
                li.innerHTML = `
                    <div class="flex items-center gap-2.5 overflow-hidden flex-1" onclick="selectFeed('${feed.id}')">
                        <i data-lucide="grip-vertical" class="w-3.5 h-3.5 text-slate-300 dark:text-slate-600 cursor-grab hover:text-slate-500 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0"></i>
                        <i data-lucide="${feed.icon || 'rss'}" class="w-4 h-4 flex-shrink-0 ${isActive ? 'text-brand-500' : 'text-slate-400 dark:text-slate-500 group-hover:text-slate-600 dark:group-hover:text-slate-300'}"></i>
                        <span class="truncate text-[13px] select-none">${feed.name}</span>
                        ${unreadCount > 0 ? `<span class="ml-auto bg-brand-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full">${unreadCount}</span>` : ''}
                    </div>
                `;

                const btn = document.createElement('button');
                btn.className = "text-slate-300 dark:text-slate-600 hover:text-red-500 dark:hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity p-1.5 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/30 ml-1";
                btn.title = "Remove Source";
                btn.onclick = (e) => removeFeed(e, feed.id);
                btn.innerHTML = `<i data-lucide="trash-2" class="w-3.5 h-3.5 pointer-events-none"></i>`;

                li.appendChild(btn);
                return li;
            };

            grouped.unassigned.forEach(feed => feedListEl.appendChild(createFeedItem(feed)));

            folders.forEach(folder => {
                const g = grouped[folder.id];
                const folderWrapper = document.createElement('div');
                folderWrapper.className = "mt-2";
                
                // Allow selecting the folder itself vs. expanding/collapsing
                const isFolderActive = activeFeedId === folder.id;
                const fHead = document.createElement('div');
                fHead.className = `flex items-center justify-between px-2 py-1.5 cursor-pointer transition-colors group rounded-xl ${isFolderActive ? 'bg-brand-50 dark:bg-brand-900/40 text-brand-700 dark:text-brand-400 font-semibold shadow-sm border border-brand-100 dark:border-brand-800/50' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-100/50 dark:hover:bg-slate-800/50 hover:text-slate-800 dark:hover:text-slate-200 border border-transparent'}`;
                fHead.ondragover = (e) => handleDragOver(e, fHead, 'folder');
                fHead.ondragleave = (e) => handleDragLeave(e, fHead, 'folder');
                fHead.ondrop = (e) => { handleDrop(e, folder.id, 'folder', fHead); e.stopPropagation(); };
                fHead.onclick = () => selectFolder(folder.id); // Clicking the header area selects the folder aggregate view

                const fLeft = document.createElement('div');
                fLeft.className = "flex items-center gap-1 flex-1 select-none overflow-hidden";

                const chevronBtn = document.createElement('button');
                chevronBtn.className = "p-1 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-colors text-slate-400 dark:text-slate-500 flex-shrink-0";
                chevronBtn.onclick = (e) => { e.stopPropagation(); toggleFolder(folder.id); }; // Explicitly target chevron for collapse/expand
                chevronBtn.innerHTML = `<i data-lucide="chevron-${folder.expanded ? 'down' : 'right'}" class="w-3.5 h-3.5 transition-transform duration-200"></i>`;
                fLeft.appendChild(chevronBtn);

                const fTitleText = document.createElement('span');
                fTitleText.className = `text-[11px] font-bold uppercase tracking-wider truncate pr-2 ${isFolderActive ? 'text-brand-700 dark:text-brand-400' : ''}`;
                fTitleText.textContent = folder.name;
                fLeft.appendChild(fTitleText);

                fHead.appendChild(fLeft);

                const fDelBtn = document.createElement('button');
                fDelBtn.className = "opacity-0 group-hover:opacity-100 hover:text-red-500 dark:hover:text-red-400 transition-opacity p-1.5 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/30 flex-shrink-0";
                fDelBtn.title = "Delete Folder";
                fDelBtn.onclick = (e) => { e.stopPropagation(); removeFolder(e, folder.id); };
                fDelBtn.innerHTML = `<i data-lucide="trash-2" class="w-3.5 h-3.5 pointer-events-none"></i>`;
                fHead.appendChild(fDelBtn);

                folderWrapper.appendChild(fHead);

                if (folder.expanded) {
                    const fList = document.createElement('ul');
                    fList.className = "space-y-0.5 ml-2 border-l border-slate-100 dark:border-slate-800/60 pl-2 mt-1";
                    g.feeds.forEach(feed => fList.appendChild(createFeedItem(feed)));
                    
                    if(g.feeds.length === 0) {
                        const empty = document.createElement('div');
                        empty.className = "text-[11px] text-slate-400 dark:text-slate-500 italic px-4 py-3 mt-1 select-none rounded-xl transition-colors border-2 border-dashed border-transparent hover:border-slate-200 dark:hover:border-slate-700";
                        empty.textContent = "Drop feeds here";
                        empty.ondragover = (e) => handleDragOver(e, empty, 'folder');
                        empty.ondragleave = (e) => handleDragLeave(e, empty, 'folder');
                        empty.ondrop = (e) => { handleDrop(e, folder.id, 'folder', empty); e.stopPropagation(); };
                        fList.appendChild(empty);
                    }
                    folderWrapper.appendChild(fList);
                }
                feedListEl.appendChild(folderWrapper);
            });
            lucide.createIcons();
            
            // Buttons state
            const activeClasses = ['bg-brand-50', 'dark:bg-brand-900/30', 'text-brand-700', 'dark:text-brand-400', 'font-semibold'];
            const inactiveClasses = ['text-slate-600', 'dark:text-slate-300', 'font-medium'];
            const savedBtn = document.getElementById('savedArticlesBtn');
            const allBtn = document.getElementById('allFeedsBtn');
            
            savedBtn.classList.remove(...activeClasses, ...inactiveClasses);
            allBtn.classList.remove(...activeClasses, ...inactiveClasses);

            if(activeFeedId === '__saved__') { savedBtn.classList.add(...activeClasses); allBtn.classList.add(...inactiveClasses); } 
            else if (activeFeedId === '__all__') { allBtn.classList.add(...activeClasses); savedBtn.classList.add(...inactiveClasses); } 
            else { savedBtn.classList.add(...inactiveClasses); allBtn.classList.add(...inactiveClasses); }
        }

        function toggleFolder(id) {
            const f = folders.find(f => f.id === id);
            if(f) { f.expanded = !f.expanded; saveFolders(); renderFeedList(); }
        }

        // --- Drag and Drop ---
        let draggedFeedId = null; let draggedType = null;

        function handleDragStart(e, id, type) { draggedFeedId = id; draggedType = type; e.dataTransfer.effectAllowed = 'move'; setTimeout(() => e.target.classList.add('opacity-50'), 0); }
        function handleDragOver(e, el, type) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; if(type === 'feed') el.classList.add('border-t-2', 'border-brand-500'); else if(type === 'folder' || type === 'unassigned') el.classList.add('bg-brand-50', 'dark:bg-brand-900/20', 'rounded-lg'); }
        function handleDragLeave(e, el, type) { if(type === 'feed') el.classList.remove('border-t-2', 'border-brand-500'); else if(type === 'folder' || type === 'unassigned') el.classList.remove('bg-brand-50', 'dark:bg-brand-900/20', 'rounded-lg'); }
        function handleDrop(e, targetId, type, el) {
            e.preventDefault(); handleDragLeave(e, el, type);
            if(draggedFeedId && draggedType === 'feed') {
                const draggedIndex = feeds.findIndex(f => f.id === draggedFeedId);
                if (draggedIndex === -1) return;
                const feed = feeds[draggedIndex];
                if (type === 'unassigned') { delete feed.folderId; feeds.splice(draggedIndex, 1); feeds.unshift(feed); } 
                else if (type === 'folder') { feed.folderId = targetId; const folder = folders.find(f => f.id === targetId); if(folder) folder.expanded = true; feeds.splice(draggedIndex, 1); feeds.push(feed); } 
                else if (type === 'feed' && draggedFeedId !== targetId) {
                    const targetFeed = feeds.find(f => f.id === targetId);
                    if (targetFeed) {
                        if (targetFeed.folderId) feed.folderId = targetFeed.folderId; else delete feed.folderId;
                        feeds.splice(draggedIndex, 1);
                        const toIndex = feeds.findIndex(f => f.id === targetId);
                        feeds.splice(toIndex, 0, feed);
                    }
                }
                saveFeeds(); saveFolders(); renderFeedList();
            }
            draggedFeedId = null; draggedType = null;
        }

        // --- Feed Navigation ---
        async function selectFeed(id) {
            activeFeedId = id; resetFilters(); hideNotificationBanner();
            if(feedUnreadBadge[id]) { feedUnreadBadge[id] = 0; saveBadges(); }
            const feed = feeds.find(f => f.id === id);
            if (!feed) return;
            renderFeedList(); 
            if(window.innerWidth < 768) toggleMobileMenu(false);

            currentFeedTitleEl.textContent = feed.name;
            const cachedData = feedCache[id];
            const isExpired = !cachedData || (Date.now() - cachedData.timestamp > appSettings.refreshInterval * 60000);

            if (cachedData) {
                currentRawArticles = cachedData.articles;
                updateView(); showState('content');
                if (isExpired) {
                    currentFeedMetaEl.innerHTML = '<i data-lucide="refresh-cw" class="w-3.5 h-3.5 inline animate-spin mr-1.5 text-brand-500"></i> Updating silently...';
                    lucide.createIcons();
                    await fetchAndRenderArticles(feed, true);
                } else {
                    const minsAgo = Math.floor((Date.now() - cachedData.timestamp) / 60000);
                    currentFeedMetaEl.textContent = minsAgo === 0 ? 'Freshly updated' : `Updated ${minsAgo} min${minsAgo === 1 ? '' : 's'} ago`;
                }
            } else {
                currentFeedMetaEl.textContent = 'Pulling latest stories...';
                await fetchAndRenderArticles(feed, false);
            }
        }

        async function selectAllFeeds() {
            activeFeedId = '__all__'; resetFilters(); hideNotificationBanner(); renderFeedList();
            if(window.innerWidth < 768) toggleMobileMenu(false);

            currentFeedTitleEl.textContent = 'All Feeds Digest';
            currentFeedMetaEl.textContent = 'Compiling your world...';
            
            let allArticles = []; let needsRefresh = [];
            for (let feed of feeds) {
                if(feedCache[feed.id]) {
                    allArticles = allArticles.concat(feedCache[feed.id].articles);
                    if((Date.now() - feedCache[feed.id].timestamp) > appSettings.refreshInterval * 60000) needsRefresh.push(feed);
                } else needsRefresh.push(feed);
            }

            const unique = []; const links = new Set();
            for (let a of allArticles) { if (!links.has(a.link)) { links.add(a.link); unique.push(a); } }

            currentRawArticles = unique;
            if(currentRawArticles.length > 0) {
                updateView(); showState('content');
                currentFeedMetaEl.textContent = `Showing ${unique.length} aggregated stories`;
            } else if (needsRefresh.length > 0) { showState('loading'); } 
            else { showState('empty'); currentFeedMetaEl.textContent = ''; }

            if(needsRefresh.length > 0) {
                if(currentRawArticles.length > 0) {
                    currentFeedMetaEl.innerHTML = '<i data-lucide="refresh-cw" class="w-3.5 h-3.5 inline animate-spin mr-1.5 text-brand-500"></i> Syncing sources...';
                    lucide.createIcons();
                }
                for (let feed of needsRefresh) await fetchAndRenderArticles(feed, true); 
                if(currentRawArticles.length === 0) selectAllFeeds();
                else currentFeedMetaEl.textContent = `Monitoring ${feeds.length} sources`;
            }
        }

        // Fetch and combine articles for all sources grouped within a specific folder
        async function selectFolder(folderId) {
            activeFeedId = folderId; resetFilters(); hideNotificationBanner(); renderFeedList();
            if(window.innerWidth < 768) toggleMobileMenu(false);

            const folder = folders.find(f => f.id === folderId);
            if(!folder) return;

            currentFeedTitleEl.textContent = folder.name;
            const folderFeeds = feeds.filter(f => f.folderId === folderId);

            if(folderFeeds.length === 0) {
                currentFeedMetaEl.textContent = 'Empty folder';
                document.getElementById('emptyStateTitle').textContent = 'Folder is Empty';
                document.getElementById('emptyStateMsg').textContent = 'Drag and drop sources from the sidebar into this folder.';
                showState('empty');
                return;
            }

            currentFeedMetaEl.textContent = 'Aggregating folder...';

            let allArticles = []; let needsRefresh = [];
            for (let feed of folderFeeds) {
                if(feedCache[feed.id]) {
                    allArticles = allArticles.concat(feedCache[feed.id].articles);
                    if((Date.now() - feedCache[feed.id].timestamp) > appSettings.refreshInterval * 60000) needsRefresh.push(feed);
                } else needsRefresh.push(feed);
            }

            const unique = []; const links = new Set();
            for (let a of allArticles) { if (!links.has(a.link)) { links.add(a.link); unique.push(a); } }

            currentRawArticles = unique;
            if(currentRawArticles.length > 0) {
                updateView(); showState('content');
                currentFeedMetaEl.textContent = `Showing ${unique.length} stories from ${folderFeeds.length} source${folderFeeds.length===1?'':'s'}`;
            } else if (needsRefresh.length > 0) { showState('loading'); } 
            else { showState('empty'); currentFeedMetaEl.textContent = ''; }

            if(needsRefresh.length > 0) {
                if(currentRawArticles.length > 0) {
                    currentFeedMetaEl.innerHTML = '<i data-lucide="refresh-cw" class="w-3.5 h-3.5 inline animate-spin mr-1.5 text-brand-500"></i> Syncing sources...';
                    lucide.createIcons();
                }
                for (let feed of needsRefresh) await fetchAndRenderArticles(feed, true); 
                if(currentRawArticles.length === 0) selectFolder(folderId);
                else currentFeedMetaEl.textContent = `Monitoring ${folderFeeds.length} source${folderFeeds.length===1?'':'s'}`;
            }
        }

        function refreshCurrentFeed() {
            if(activeFeedId === '__saved__') return; 
            if(activeFeedId === '__all__') { 
                feeds.forEach(f => { if(feedCache[f.id]) feedCache[f.id].timestamp = 0; });
                selectAllFeeds(); return; 
            }
            if(activeFeedId && activeFeedId.startsWith('folder_')) {
                feeds.forEach(f => { if(f.folderId === activeFeedId && feedCache[f.id]) feedCache[f.id].timestamp = 0; });
                selectFolder(activeFeedId); return;
            }
            if(activeFeedId) {
                const feed = feeds.find(f => f.id === activeFeedId);
                if (feed) { currentFeedMetaEl.textContent = 'Refreshing...'; fetchAndRenderArticles(feed, false); }
            }
        }

        async function fetchAndRenderArticles(feed, isBackground = false) {
            if (!isBackground) { showState('loading'); articlesGridEl.innerHTML = ''; }
            const refreshIcon = document.getElementById('refreshIcon'); refreshIcon.classList.add('animate-spin');

            try {
                let rawText = null;
                const proxies = [
                    `https://corsproxy.io/?${encodeURIComponent(feed.url)}`,
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(feed.url)}`,
                    `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(feed.url)}`
                ];

                for (let proxy of proxies) {
                    try {
                        const response = await fetch(proxy);
                        if (response.ok) {
                            const text = await response.text();
                            if (text && (text.includes('<rss') || text.includes('<feed') || text.includes('<?xml'))) {
                                rawText = text;
                                break;
                            }
                        }
                    } catch (e) {
                        console.warn(`Proxy failed: ${proxy}`, e);
                    }
                }

                if (!rawText) throw new Error('All proxies failed or returned invalid feed data.');

                // Clean text before parsing (remove BOM, leading spaces, or garbage before XML start)
                rawText = rawText.trim();
                // Strip invalid XML control characters that often break DOMParser
                rawText = rawText.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/g, '');
                
                const indices = [rawText.indexOf('<rss'), rawText.indexOf('<feed'), rawText.indexOf('<?xml')].filter(i => i >= 0);
                if (indices.length > 0) {
                    const startIdx = Math.min(...indices);
                    rawText = rawText.substring(startIdx);
                }

                let xmlDoc = new DOMParser().parseFromString(rawText, 'text/xml');
                if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                    // Check if items parsed successfully despite the error
                    if (xmlDoc.querySelectorAll('item, entry').length === 0) {
                        // Fallback to more lenient HTML parser for heavily malformed feeds
                        let htmlDoc = new DOMParser().parseFromString(rawText, 'text/html');
                        if (htmlDoc.querySelectorAll('item, entry').length > 0) {
                            xmlDoc = htmlDoc;
                        } else {
                            throw new Error(`Error parsing XML data for feed: ${feed.name}`);
                        }
                    }
                }

                const items = xmlDoc.querySelectorAll('item, entry');
                const articles = Array.from(items).map(item => parseXMLItem(item, feed));
                if (articles.length === 0) throw new Error('No articles found.');
                articles.forEach((a, i) => a.sortValue = Date.parse(a.rawDate) || (Date.now() - i));

                if (isBackground && feedCache[feed.id]) {
                    const oldLinks = new Set(feedCache[feed.id].articles.map(a => a.link));
                    const newStories = articles.filter(a => !oldLinks.has(a.link) && !readArticles.has(a.link));
                    if (newStories.length > 0) {
                        feedUnreadBadge[feed.id] = (feedUnreadBadge[feed.id] || 0) + newStories.length;
                        saveBadges(); renderFeedList();
                        // Support notifications if we are looking at this feed, all feeds, or the parent folder
                        if (activeFeedId === feed.id || activeFeedId === '__all__' || activeFeedId === feed.folderId) {
                            pendingNewStoriesCount += newStories.length;
                            showNotificationBanner();
                        }
                    }
                }

                if(!isBackground) currentRawArticles = articles;
                feedCache[feed.id] = { timestamp: Date.now(), articles: articles };
                localStorage.setItem('currently_cache', JSON.stringify(feedCache));

                if (!isBackground) {
                    const minsAgo = Math.floor((Date.now() - feedCache[feed.id].timestamp) / 60000);
                    currentFeedMetaEl.textContent = minsAgo === 0 ? 'Freshly updated' : `Updated ${minsAgo} min${minsAgo === 1 ? '' : 's'} ago`;
                    updateView(); showState('content');
                }
            } catch (error) {
                console.error('Feed fetch error:', error);
                if (!isBackground) {
                    errorMessageEl.textContent = `Could not load ${feed.name}. Make sure the URL is correct or try again later.`;
                    currentFeedMetaEl.textContent = 'Update failed';
                    showState('error');
                }
            } finally { refreshIcon.classList.remove('animate-spin'); }
        }

        // --- Parsing ---
        function parseXMLItem(item, feedContext) {
            const getText = (s) => { const el = item.querySelector(s); return el ? el.textContent.trim() : ''; };
            const title = getText('title') || 'Untitled Article';
            let link = getText('link');
            if (!link) { const linkEl = item.querySelector('link'); if (linkEl && linkEl.getAttribute('href')) link = linkEl.getAttribute('href'); else link = '#'; }
            const pubDateStr = getText('pubDate') || getText('dc\\:date') || getText('published') || getText('updated') || '';
            const descriptionRaw = getText('description') || getText('summary') || getText('content') || '';
            
            // Extract Full Content 
            let fullContentRaw = '';
            // Safe query for namespaces whether parsed as XML or HTML fallback
            let encodedContent = item.getElementsByTagNameNS ? item.getElementsByTagNameNS('*', 'encoded') : [];
            if (!encodedContent || encodedContent.length === 0) encodedContent = item.querySelectorAll('encoded, content\\:encoded');
            
            const contentTag = item.querySelector('content');
            
            if (encodedContent && encodedContent.length > 0) {
                fullContentRaw = encodedContent[0].textContent;
            } else if (contentTag && !contentTag.getAttribute('url')) { // Avoid grabbing <media:content>
                fullContentRaw = contentTag.textContent || contentTag.innerHTML; 
            } else {
                fullContentRaw = descriptionRaw;
            }
            
            const sanitizedFullContent = sanitizeHTML(fullContentRaw);

            // Clean Description for Card Preview
            const tmp = document.createElement('div'); tmp.innerHTML = descriptionRaw;
            const descriptionText = tmp.textContent || tmp.innerText || 'No description available.';
            let formattedDate = 'Recent';
            if (pubDateStr) { try { const date = new Date(pubDateStr); if (!isNaN(date.getTime())) formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); } catch (e) {} }
            
            let imageUrl = null;
            let mediaContent = item.getElementsByTagNameNS ? item.getElementsByTagNameNS('*', 'content') : [];
            if (!mediaContent || mediaContent.length === 0) mediaContent = item.querySelectorAll('media\\:content');
            
            if (mediaContent.length > 0) { for(let i=0; i<mediaContent.length; i++) { if (mediaContent[i].getAttribute('url')) { imageUrl = mediaContent[i].getAttribute('url'); break; } } }
            if (!imageUrl) { const enclosure = item.querySelector('enclosure[type^="image"]'); if (enclosure) imageUrl = enclosure.getAttribute('url'); }
            if (!imageUrl) { const imgMatch = fullContentRaw.match(/<img[^>]+src="([^">]+)"/); if (imgMatch && imgMatch[1]) imageUrl = imgMatch[1]; }

            return { title, link, description: descriptionText, fullContent: sanitizedFullContent, date: formattedDate, rawDate: pubDateStr, imageUrl, feedId: feedContext.id, feedName: feedContext.name };
        }

        // --- Notifications ---
        function showNotificationBanner() {
            if(pendingNewStoriesCount > 0) {
                document.getElementById('notificationText').textContent = `${pendingNewStoriesCount} new stor${pendingNewStoriesCount>1?'ies':'y'} available. Click to refresh.`;
                notificationBanner.classList.remove('hidden');
            }
        }
        function hideNotificationBanner() { notificationBanner.classList.add('hidden'); pendingNewStoriesCount = 0; }
        function reloadWithNewStories() { 
            hideNotificationBanner(); 
            if(activeFeedId === '__all__') selectAllFeeds(); 
            else if(activeFeedId && activeFeedId.startsWith('folder_')) selectFolder(activeFeedId);
            else if(activeFeedId) selectFeed(activeFeedId); 
        }

        // --- Filters & View ---
        function resetFilters() { document.getElementById('searchInput').value = ''; document.getElementById('sortSelect').value = 'newest'; document.getElementById('filterSelect').value = 'all'; searchQuery = ''; currentSort = 'newest'; currentFilter = 'all'; }
        function handleSearch(val) { searchQuery = val.toLowerCase(); updateView(); }
        function handleSortFilter() { currentSort = document.getElementById('sortSelect').value; currentFilter = document.getElementById('filterSelect').value; updateView(); }

        function updateView() {
            if(!currentRawArticles || currentRawArticles.length === 0) return;
            let filtered = currentRawArticles.filter(article => {
                if(searchQuery && !article.title.toLowerCase().includes(searchQuery) && !article.description.toLowerCase().includes(searchQuery)) return false;
                if(currentFilter === 'unread' && readArticles.has(article.link)) return false;
                if(currentFilter === 'images' && !article.imageUrl) return false;
                return true;
            });
            filtered.sort((a, b) => { const valA = a.sortValue || 0; const valB = b.sortValue || 0; return currentSort === 'newest' ? valB - valA : valA - valB; });
            displayedArticles = filtered; renderArticles(displayedArticles);
            
            if(displayedArticles.length === 0 && currentRawArticles.length > 0) {
                 articlesGridEl.innerHTML = `<div class="col-span-full py-20 text-center text-slate-500 dark:text-slate-400 bg-white dark:bg-slate-800/50 rounded-3xl border border-slate-200/50 dark:border-slate-800 shadow-sm"><i data-lucide="filter-x" class="w-12 h-12 mx-auto mb-4 text-slate-300 dark:text-slate-600"></i><h3 class="text-xl font-bold text-slate-800 dark:text-white mb-2">No matching stories</h3><p>Adjust your search or filters to see more results.</p></div>`;
                 lucide.createIcons();
            }
        }

        function renderArticles(articles) {
            articlesGridEl.innerHTML = ''; controlsBar.classList.remove('hidden');
            
            const density = appSettings.density || 'comfortable';
            const isCompact = density === 'compact';
            const isList = density === 'list';

            articlesGridEl.className = isList 
                ? 'flex flex-col gap-5 pb-12 max-w-4xl mx-auto w-full'
                : (isCompact 
                    ? 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 pb-12 max-w-[1600px] mx-auto'
                    : 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 xl:gap-8 pb-12 max-w-[1600px] mx-auto');

            const orderedDates = [...new Set(articles.map(a => a.date))];
            const groupedArticles = {}; orderedDates.forEach(d => groupedArticles[d] = []);
            articles.forEach((article, index) => groupedArticles[article.date].push({ article, index }));

            // Ensure source badges are shown for All Feeds, Saved, and Folders
            const shouldShowSourceBadge = activeFeedId === '__all__' || activeFeedId === '__saved__' || (activeFeedId && activeFeedId.startsWith('folder_'));

            let delayCounter = 0;
            orderedDates.forEach(dateStr => {
                const header = document.createElement('div');
                header.className = 'col-span-full mt-8 mb-2 first:mt-2 border-b border-slate-200/60 dark:border-slate-800/60 pb-3 fade-in flex items-center gap-3';
                header.style.animationDelay = `${(delayCounter % 20) * 0.04}s`;
                header.innerHTML = `<i data-lucide="calendar" class="w-5 h-5 text-brand-500"></i><h3 class="text-xl font-extrabold text-slate-800 dark:text-white tracking-tight">${dateStr}</h3>`;
                articlesGridEl.appendChild(header); delayCounter++;

                groupedArticles[dateStr].forEach(({ article, index }) => {
                    const isRead = readArticles.has(article.link); const isSaved = savedArticles.some(sa => sa.link === article.link);
                    const card = document.createElement('article');
                    card.className = `bg-white dark:bg-slate-900 rounded-3xl border border-slate-200/60 dark:border-slate-800 overflow-hidden shadow-sm hover:shadow-xl hover:shadow-brand-500/5 dark:hover:shadow-black/50 ${isCompact || isList ? '' : 'hover:-translate-y-1'} transition-all duration-300 flex ${isList ? 'flex-row items-stretch' : 'flex-col'} fade-in cursor-pointer group ${isRead ? 'opacity-70' : ''}`;
                    card.style.animationDelay = `${(delayCounter % 20) * 0.04}s`; card.onclick = () => openArticleModal(index);

                    const imgHeight = isList ? 'w-1/3 md:w-56 shrink-0' : (isCompact ? 'h-36' : 'h-56');
                    const pClass = isCompact ? 'p-4' : 'p-6';
                    const titleClass = isCompact ? 'text-[1.05rem] mb-2 leading-tight line-clamp-2' : (isList ? 'text-[1.2rem] md:text-[1.3rem] mb-2 leading-tight line-clamp-2' : 'text-[1.15rem] leading-tight mb-3 line-clamp-2');
                    const descClass = isCompact ? 'text-xs mb-3 line-clamp-2' : (isList ? 'text-sm mb-4 line-clamp-3 md:line-clamp-4' : 'text-sm mb-5 line-clamp-3');

                    const saveBtnHtml = `<button onclick="toggleSaveArticle(event, ${index})" class="glass p-2 rounded-full text-slate-600 dark:text-slate-300 hover:text-brand-600 dark:hover:text-brand-400 hover:scale-110 transition-all shadow-sm group/btn shrink-0" title="${isSaved ? 'Remove Bookmark' : 'Save for Later'}"><i data-lucide="bookmark" class="w-4 h-4 ${isSaved ? 'fill-brand-500 text-brand-500 group-hover/btn:fill-brand-600 group-hover/btn:text-brand-600' : ''}"></i></button>`;

                    let imageHtml = '';
                    if (article.imageUrl) {
                        imageHtml = `<div class="${imgHeight} overflow-hidden bg-slate-100 dark:bg-slate-800 relative"><div class="absolute inset-0 bg-gradient-to-t from-black/50 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10"></div><img src="${article.imageUrl}" alt="Article Image" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" loading="lazy" onerror="this.style.display='none'"><div class="absolute top-4 right-4 z-20">${saveBtnHtml}</div></div>`;
                    } else {
                        imageHtml = `<div class="${isList ? 'w-3 shrink-0' : 'h-4'} bg-gradient-to-br from-brand-400 to-purple-500 relative"></div>`;
                    }

                    const textSaveBtnHtml = !article.imageUrl ? `<div class="absolute top-4 right-4 z-20">${saveBtnHtml}</div>` : '';

                    card.innerHTML = `${imageHtml}<div class="${pClass} flex flex-col flex-1 relative bg-white dark:bg-slate-900 w-full min-w-0">${textSaveBtnHtml}${shouldShowSourceBadge && article.feedName ? `<span class="inline-block self-start px-2 py-0.5 bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 text-[10px] uppercase font-bold tracking-wider rounded-md mb-3">${article.feedName}</span>` : ''}<h3 class="font-bold pr-10 ${titleClass} ${isRead ? 'text-slate-600 dark:text-slate-400' : 'text-slate-800 dark:text-white'} group-hover:text-brand-600 dark:group-hover:text-brand-400 transition-colors" title="${article.title}">${article.title}</h3><p class="${descClass} pr-2 ${isRead ? 'text-slate-500 dark:text-slate-500' : 'text-slate-600 dark:text-slate-400'} flex-1 leading-relaxed">${article.description}</p><div class="mt-auto pt-4 border-t border-slate-100 dark:border-slate-800 flex justify-end items-center"><a href="${article.link}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-slate-50 dark:bg-slate-800 text-slate-400 dark:text-slate-400 hover:bg-brand-50 dark:hover:bg-brand-900/50 hover:text-brand-600 dark:hover:text-brand-400 transition-all" title="Open directly to source"><i data-lucide="external-link" class="w-3.5 h-3.5"></i></a></div></div>`;
                    articlesGridEl.appendChild(card); delayCounter++;
                });
            });
            lucide.createIcons();
        }

        // --- Reader Mode ---
        function toggleReaderMode() { isReaderMode = !isReaderMode; applyReaderMode(); }
        function applyReaderMode() {
            const btn = document.getElementById('readerModeBtn'); const desc = document.getElementById('articleModalDescription'); const title = document.getElementById('articleModalTitle'); const imgContainer = document.getElementById('articleModalImageContainer'); const modalContent = document.getElementById('articleModalContent'); const innerContainer = document.getElementById('articleInnerContainer'); const scrollArea = document.getElementById('articleScrollArea'); const footer = document.getElementById('articleModalFooter'); const header = document.getElementById('articleModalHeader');
            if(isReaderMode) {
                btn.classList.add('text-brand-500', 'dark:text-brand-400', 'bg-brand-50', 'dark:bg-brand-900/30'); btn.classList.remove('text-slate-400', 'dark:text-slate-500', 'bg-slate-50', 'dark:bg-slate-800/50');
                imgContainer.classList.add('!hidden'); innerContainer.classList.add('max-w-[700px]', 'mx-auto'); title.classList.add('!text-4xl', 'md:!text-5xl', 'text-center'); desc.classList.add('!text-xl', 'md:!text-2xl', 'leading-loose');
                scrollArea.classList.remove('bg-slate-50/30', 'dark:bg-slate-900'); scrollArea.classList.add('bg-[#fdfbf7]', 'dark:bg-[#111827]'); modalContent.classList.remove('bg-white', 'dark:bg-slate-900'); modalContent.classList.add('bg-[#fdfbf7]', 'dark:bg-[#111827]'); footer.classList.remove('bg-white', 'dark:bg-slate-900'); footer.classList.add('bg-[#fdfbf7]', 'dark:bg-[#111827]'); header.classList.remove('bg-white/80', 'dark:bg-slate-900/80'); header.classList.add('bg-[#fdfbf7]/90', 'dark:bg-[#111827]/90');
            } else {
                btn.classList.remove('text-brand-500', 'dark:text-brand-400', 'bg-brand-50', 'dark:bg-brand-900/30'); btn.classList.add('text-slate-400', 'dark:text-slate-500', 'bg-slate-50', 'dark:bg-slate-800/50');
                const article = displayedArticles[openedArticleIndex]; if (article && article.imageUrl) imgContainer.classList.remove('!hidden');
                innerContainer.classList.remove('max-w-[700px]', 'mx-auto'); title.classList.remove('!text-4xl', 'md:!text-5xl', 'text-center'); desc.classList.remove('!text-xl', 'md:!text-2xl', 'leading-loose');
                scrollArea.classList.add('bg-slate-50/30', 'dark:bg-slate-900'); scrollArea.classList.remove('bg-[#fdfbf7]', 'dark:bg-[#111827]'); modalContent.classList.add('bg-white', 'dark:bg-slate-900'); modalContent.classList.remove('bg-[#fdfbf7]', 'dark:bg-[#111827]'); footer.classList.add('bg-white', 'dark:bg-slate-900'); footer.classList.remove('bg-[#fdfbf7]', 'dark:bg-[#111827]'); header.classList.add('bg-white/80', 'dark:bg-slate-900/80'); header.classList.remove('bg-[#fdfbf7]/90', 'dark:bg-[#111827]/90');
            }
        }

        // --- Save & Read ---
        function markAllAsRead() { if(!displayedArticles.length) return; displayedArticles.forEach(a => readArticles.add(a.link)); localStorage.setItem('currently_read', JSON.stringify([...readArticles])); updateView(); }
        function markAsRead(link) { if(!readArticles.has(link)) { readArticles.add(link); localStorage.setItem('currently_read', JSON.stringify([...readArticles])); updateView(); } }
        function toggleSaveArticle(event, index) {
            event.stopPropagation(); const article = displayedArticles[index]; if(!article) return;
            const savedIndex = savedArticles.findIndex(sa => sa.link === article.link);
            if(savedIndex >= 0) savedArticles.splice(savedIndex, 1); else savedArticles.push(article);
            localStorage.setItem('currently_saved', JSON.stringify(savedArticles)); updateSavedBadge();
            if(activeFeedId === '__saved__') { currentRawArticles = savedArticles; updateView(); } else updateView();
        }
        function toggleSaveCurrentArticle() { if (openedArticleIndex !== null) { toggleSaveArticle({stopPropagation: ()=>{}}, openedArticleIndex); const article = displayedArticles[openedArticleIndex]; const isSaved = savedArticles.some(sa => sa.link === article.link); const icon = document.getElementById('articleModalSaveIcon'); if(isSaved) icon.classList.add('fill-brand-500', 'text-brand-500'); else icon.classList.remove('fill-brand-500', 'text-brand-500'); } }
        function updateSavedBadge() { const badge = document.getElementById('savedBadge'); if(savedArticles.length > 0) { badge.textContent = savedArticles.length; badge.classList.remove('hidden'); } else badge.classList.add('hidden'); }
        function selectSavedArticles() {
            activeFeedId = '__saved__'; renderFeedList(); if(window.innerWidth < 768) toggleMobileMenu(false); hideNotificationBanner(); resetFilters();
            currentFeedTitleEl.textContent = 'Saved For Later'; currentFeedMetaEl.textContent = `${savedArticles.length} stories stored offline`;
            if(savedArticles.length === 0) { document.getElementById('emptyStateTitle').textContent = 'No Saved Articles'; document.getElementById('emptyStateMsg').textContent = 'Click the bookmark icon on any article to save it here for later reading.'; controlsBar.classList.add('hidden'); showState('empty'); } 
            else { currentRawArticles = [...savedArticles]; updateView(); showState('content'); }
        }

        function showState(state) {
            loadingStateEl.classList.add('hidden'); errorStateEl.classList.add('hidden'); emptyStateEl.classList.add('hidden'); articlesGridEl.classList.add('hidden');
            if(state !== 'content' && activeFeedId !== '__saved__' && activeFeedId !== '__all__' && (!activeFeedId || !activeFeedId.startsWith('folder_'))) controlsBar.classList.add('hidden');
            switch(state) { case 'loading': loadingStateEl.classList.remove('hidden'); break; case 'error': errorStateEl.classList.remove('hidden'); break; case 'empty': emptyStateEl.classList.remove('hidden'); break; case 'content': articlesGridEl.classList.remove('hidden'); controlsBar.classList.remove('hidden'); break; }
        }

        // --- Settings & UI Management ---
        function openAddFolderModal() { addFolderModal.classList.remove('hidden'); setTimeout(() => { addFolderModal.classList.remove('opacity-0'); document.getElementById('addFolderModalContent').classList.remove('scale-95'); }, 10); document.getElementById('folderNameInput').focus(); if(window.innerWidth < 768) toggleMobileMenu(false); }
        function closeAddFolderModal() { addFolderModal.classList.add('opacity-0'); document.getElementById('addFolderModalContent').classList.add('scale-95'); setTimeout(() => { addFolderModal.classList.add('hidden'); document.getElementById('addFolderForm').reset(); }, 300); }
        function handleAddFolder(e) { e.preventDefault(); const name = document.getElementById('folderNameInput').value.trim(); if(name) { folders.push({ id: 'folder_' + Date.now(), name: name, expanded: true }); saveFolders(); renderFeedList(); closeAddFolderModal(); } }
        function removeFolder(e, id) { e.stopPropagation(); openConfirmModal('Delete Folder', 'Delete this folder? Sources inside will become unassigned.', 'Delete', () => { folders = folders.filter(f => f.id !== id); feeds.forEach(f => { if(f.folderId === id) delete f.folderId; }); saveFolders(); saveFeeds(); renderFeedList(); }); }
        
        function openAddFeedModal() {
            const select = document.getElementById('feedFolderInput'); select.innerHTML = '<option value="">None (Unassigned)</option>'; folders.forEach(f => { select.innerHTML += `<option value="${f.id}">${f.name}</option>`; }); document.getElementById('folderSelectContainer').classList.remove('hidden');
            addFeedModal.classList.remove('hidden'); setTimeout(() => { addFeedModal.classList.remove('opacity-0'); document.getElementById('addFeedModalContent').classList.remove('scale-95'); }, 10); document.getElementById('feedNameInput').focus(); if(window.innerWidth < 768) toggleMobileMenu(false);
        }
        function closeAddFeedModal() { addFeedModal.classList.add('opacity-0'); document.getElementById('addFeedModalContent').classList.add('scale-95'); setTimeout(() => { addFeedModal.classList.add('hidden'); document.getElementById('addFeedForm').reset(); }, 300); }
        function handleAddFeed(e) {
            e.preventDefault(); const nameInput = document.getElementById('feedNameInput').value.trim(); let urlInput = document.getElementById('feedUrlInput').value.trim(); const folderId = document.getElementById('feedFolderInput').value;
            if (!nameInput || !urlInput) return; if (!/^https?:\/\//i.test(urlInput)) urlInput = 'https://' + urlInput;
            const newFeed = { id: Date.now().toString(), name: nameInput, url: urlInput, icon: 'rss' }; if(folderId) newFeed.folderId = folderId;
            feeds.push(newFeed); saveFeeds(); renderFeedList(); closeAddFeedModal(); selectFeed(newFeed.id);
        }
        function removeFeed(e, id) { e.stopPropagation(); openConfirmModal('Remove Source', 'Are you sure you want to remove this source?', 'Remove', () => { feeds = feeds.filter(f => f.id !== id); delete feedUnreadBadge[id]; saveFeeds(); saveBadges(); renderFeedList(); if (activeFeedId === id) { if(feeds.length > 0) selectAllFeeds(); else { activeFeedId = null; currentFeedTitleEl.textContent = 'Welcome to Currently'; currentFeedMetaEl.textContent = ''; document.getElementById('emptyStateTitle').textContent = 'No Sources Selected'; document.getElementById('emptyStateMsg').textContent = 'Choose a feed from the sidebar or add your own to start reading.'; showState('empty'); } } }); }
        
        function toggleMobileMenu(forceState) { const isClosing = forceState === false || !sidebar.classList.contains('-translate-x-full'); if (isClosing) { sidebar.classList.add('-translate-x-full'); mobileOverlay.classList.add('hidden'); } else { sidebar.classList.remove('-translate-x-full'); mobileOverlay.classList.remove('hidden'); } }
        
        function openSettingsModal() {
            document.getElementById('refreshIntervalInput').value = appSettings.refreshInterval || 15;
            document.getElementById('cycleSpeedInput').value = appSettings.cycleSpeed || 10;
            document.getElementById('themeInput').value = appSettings.theme || 'auto';
            document.getElementById('densityInput').value = appSettings.density || 'comfortable';
            document.getElementById('tvLayoutInput').value = appSettings.tvLayout || 'split';
            document.getElementById('tvQrCodeInput').value = appSettings.tvQrCode || 'show';
            settingsModal.classList.remove('hidden'); setTimeout(() => { settingsModal.classList.remove('opacity-0'); document.getElementById('settingsModalContent').classList.remove('scale-95'); }, 10); if(window.innerWidth < 768) toggleMobileMenu(false);
        }
        function closeSettingsModal() { settingsModal.classList.add('opacity-0'); document.getElementById('settingsModalContent').classList.add('scale-95'); setTimeout(() => { settingsModal.classList.add('hidden'); }, 300); }
        function handleSaveSettings(e) {
            e.preventDefault(); 
            const val = parseInt(document.getElementById('refreshIntervalInput').value, 10);
            const speedVal = parseInt(document.getElementById('cycleSpeedInput').value, 10);
            if(val > 0) appSettings.refreshInterval = val;
            if(speedVal > 0) appSettings.cycleSpeed = speedVal;
            
            appSettings.theme = document.getElementById('themeInput').value;
            appSettings.density = document.getElementById('densityInput').value;
            appSettings.tvLayout = document.getElementById('tvLayoutInput').value;
            appSettings.tvQrCode = document.getElementById('tvQrCodeInput').value;
            
            localStorage.setItem('currently_settings', JSON.stringify(appSettings));
            applyTheme(); updateView();
            
            closeSettingsModal(); if(activeFeedId && activeFeedId !== '__saved__') { if(activeFeedId === '__all__') selectAllFeeds(); else if(activeFeedId.startsWith('folder_')) selectFolder(activeFeedId); else selectFeed(activeFeedId); }
        }
        function clearCache() { openConfirmModal('Clear Cache', 'Clear all cached articles? This will require re-fetching data.', 'Clear Data', () => { feedCache = {}; feedUnreadBadge = {}; localStorage.removeItem('currently_cache'); localStorage.removeItem('currently_badges'); if(activeFeedId && activeFeedId !== '__saved__') refreshCurrentFeed(); }); }
        function clearReadHistory() { openConfirmModal('Reset History', 'Clear your read history? All articles will appear as unread.', 'Reset History', () => { readArticles.clear(); localStorage.removeItem('currently_read'); updateView(); }); }

        function exportBackup() {
            const data = { feeds: feeds, folders: folders, settings: appSettings };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `currently_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        function triggerImport() { document.getElementById('importFileInput').click(); }

        function handleImportData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.feeds && Array.isArray(data.feeds)) {
                        openConfirmModal('Restore Backup', 'This will overwrite your current sources, folders, and settings. Proceed?', 'Restore', () => {
                            feeds = data.feeds; folders = data.folders || [];
                            if (data.settings) { appSettings = { ...appSettings, ...data.settings }; localStorage.setItem('currently_settings', JSON.stringify(appSettings)); applyTheme(); }
                            saveFeeds(); saveFolders(); renderFeedList(); selectAllFeeds(); closeSettingsModal();
                        });
                    } else { openConfirmModal('Import Failed', 'The selected file is not a valid Currently backup.', 'OK', () => {}); }
                } catch (err) { openConfirmModal('Import Failed', 'Could not parse the JSON backup file.', 'OK', () => {}); }
                event.target.value = ''; // Reset input to allow re-importing same file if needed
            };
            reader.readAsText(file);
        }

        // --- Article Modal Logic ---
        function navigateArticle(direction) {
            if (openedArticleIndex === null) return;
            const newIndex = openedArticleIndex + direction;
            if (newIndex >= 0 && newIndex < displayedArticles.length) {
                populateArticleModal(newIndex);
                document.getElementById('articleScrollArea').scrollTop = 0;
            }
        }

        function populateArticleModal(index) {
            openedArticleIndex = index; 
            const article = displayedArticles[index]; 
            if (!article) return;
            
            markAsRead(article.link);
            document.getElementById('articleModalDate').textContent = article.date; 
            document.getElementById('articleModalTitle').textContent = article.title;
            
            const imgContainer = document.getElementById('articleModalImageContainer'); 
            const imgEl = document.getElementById('articleModalImage');
            if (article.imageUrl && !isReaderMode) { imgEl.src = article.imageUrl; imgContainer.classList.remove('!hidden', 'hidden'); } else { imgContainer.classList.add('!hidden'); imgEl.src = ''; }
            
            document.getElementById('articleModalDescription').innerHTML = article.fullContent || article.description; 
            document.getElementById('articleModalLink').href = article.link;
            
            const isSaved = savedArticles.some(sa => sa.link === article.link); const icon = document.getElementById('articleModalSaveIcon'); if(isSaved) icon.classList.add('fill-brand-500', 'text-brand-500'); else icon.classList.remove('fill-brand-500', 'text-brand-500');
            
            // Toggle Navigation Buttons
            const prevBtn = document.getElementById('articleModalPrevBtn');
            const nextBtn = document.getElementById('articleModalNextBtn');
            if (prevBtn) prevBtn.disabled = (index === 0);
            if (nextBtn) nextBtn.disabled = (index === displayedArticles.length - 1);

            applyReaderMode();
            lucide.createIcons();
        }

        function openArticleModal(index) {
            populateArticleModal(index);
            articleModal.classList.remove('hidden'); 
            setTimeout(() => { articleModal.classList.remove('opacity-0'); document.getElementById('articleModalContent').classList.remove('scale-95'); }, 10); 
            document.body.style.overflow = 'hidden'; 
        }

        function closeArticleModal() { 
            articleModal.classList.add('opacity-0'); document.getElementById('articleModalContent').classList.add('scale-95'); 
            setTimeout(() => { articleModal.classList.add('hidden'); document.body.style.overflow = ''; openedArticleIndex = null; }, 300); 
        }
        
        // --- Display (TV) Mode ---
        let displayModeTimer = null;
        let displayModeIndex = 0;
        let tvTouchStartX = 0;
        let tvTouchEndX = 0;

        function handleTvTouchStart(e) {
            tvTouchStartX = e.changedTouches[0].screenX;
        }

        function handleTvTouchEnd(e) {
            tvTouchEndX = e.changedTouches[0].screenX;
            handleTvSwipe();
        }

        function handleTvSwipe() {
            const threshold = 50;
            if (tvTouchStartX - tvTouchEndX > threshold) {
                // Swiped left -> Next Slide
                displayModeIndex++;
                renderDisplaySlide();
            } else if (tvTouchEndX - tvTouchStartX > threshold) {
                // Swiped right -> Prev Slide
                displayModeIndex--;
                if (displayModeIndex < 0) displayModeIndex = Math.max(0, displayedArticles.length - 1);
                renderDisplaySlide();
            }
        }

        function startDisplayMode() {
            if (!displayedArticles || displayedArticles.length === 0) return alert('No articles available to display.');
            
            const overlay = document.getElementById('displayModeOverlay');
            overlay.classList.remove('hidden');
            setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(e => console.warn("Fullscreen request denied", e));
            }

            displayModeIndex = 0;
            renderDisplaySlide();
        }

        function stopDisplayMode() {
            const overlay = document.getElementById('displayModeOverlay');
            overlay.classList.add('opacity-0');
            setTimeout(() => overlay.classList.add('hidden'), 500);
            
            clearTimeout(displayModeTimer);
            
            if (document.fullscreenElement) {
                document.exitFullscreen().catch(e => console.warn(e));
            }
        }

        function renderDisplaySlide() {
            clearTimeout(displayModeTimer);
            
            if (displayModeIndex >= displayedArticles.length) displayModeIndex = 0; 
            if (displayModeIndex < 0) displayModeIndex = Math.max(0, displayedArticles.length - 1);
            
            const article = displayedArticles[displayModeIndex];
            
            document.getElementById('displayModeDate').textContent = article.date + (article.feedName ? ` • ${article.feedName}` : '');
            
            const titleEl = document.getElementById('displayModeTitle');
            const descEl = document.getElementById('displayModeDesc');
            
            titleEl.textContent = article.title;
            
            // Clean rich text description for pure text summary in TV mode
            const tmp = document.createElement('div');
            tmp.innerHTML = article.description;
            descEl.textContent = tmp.textContent || tmp.innerText;
            
            const innerGrid = document.getElementById('displayModeInnerGrid');
            const imgWrap = document.getElementById('displayModeImgWrapper');
            const imgEl = document.getElementById('displayModeImg');
            const bgEl = document.getElementById('displayModeBg');
            const textContainer = document.getElementById('displayModeTextContainer');
            
            const isImmersive = appSettings.tvLayout === 'immersive';
            
            if (article.imageUrl) {
                imgEl.src = article.imageUrl;
                bgEl.style.backgroundImage = `url(${article.imageUrl})`;
                
                if (isImmersive) {
                    innerGrid.className = "relative z-10 max-w-7xl mx-auto px-8 w-full flex flex-col items-end pb-20 md:pb-32 h-full justify-end";
                    imgWrap.classList.add('hidden');
                    textContainer.className = "w-full z-20 drop-shadow-[0_10px_10px_rgba(0,0,0,0.8)]";
                    titleEl.classList.add('drop-shadow-2xl');
                    descEl.classList.remove('text-slate-300');
                    descEl.classList.add('text-white', 'drop-shadow-lg');
                    
                    bgEl.classList.remove('blur-3xl', 'opacity-30', 'scale-110');
                    bgEl.classList.add('opacity-50', 'blur-sm'); 
                } else {
                    innerGrid.className = "relative z-10 max-w-7xl mx-auto px-8 w-full flex flex-col md:flex-row gap-12 lg:gap-20 items-center h-full";
                    imgWrap.classList.remove('hidden');
                    textContainer.className = "w-full md:w-1/2 flex flex-col justify-center z-20";
                    titleEl.classList.remove('drop-shadow-2xl');
                    descEl.classList.add('text-slate-300');
                    descEl.classList.remove('text-white', 'drop-shadow-lg');
                    
                    bgEl.classList.add('blur-3xl', 'opacity-30', 'scale-110');
                    bgEl.classList.remove('opacity-50', 'blur-sm');
                }
            } else {
                bgEl.style.backgroundImage = 'none';
                innerGrid.className = "relative z-10 max-w-7xl mx-auto px-8 w-full flex flex-col items-center justify-center h-full text-center";
                imgWrap.classList.add('hidden');
                textContainer.className = "w-full flex flex-col justify-center items-center z-20 max-w-4xl mx-auto";
                titleEl.classList.remove('drop-shadow-2xl');
                descEl.classList.add('text-slate-300');
                descEl.classList.remove('text-white', 'drop-shadow-lg');
            }
            
            // TV QR Code Rendering
            const qrContainer = document.getElementById('displayModeQr');
            const qrImg = document.getElementById('displayModeQrImg');
            
            if (appSettings.tvQrCode !== 'hide' && article.link) {
                // Generate QR Code pointing to the article
                qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(article.link)}&bgcolor=ffffff&color=0f172a&margin=0`;
                qrContainer.classList.remove('hidden');
            } else {
                qrContainer.classList.add('hidden');
            }
            
            lucide.createIcons();

            const speedMs = (appSettings.cycleSpeed || 10) * 1000;
            const progressBar = document.getElementById('displayModeProgress');
            
            // Reset Progress Bar
            progressBar.style.transition = 'none';
            progressBar.style.width = '0%';
            
            // Trigger animation
            setTimeout(() => {
                progressBar.style.transition = `width ${speedMs}ms linear`;
                progressBar.style.width = '100%';
            }, 50);

            // Queue Next Slide
            displayModeTimer = setTimeout(() => {
                displayModeIndex++;
                renderDisplaySlide();
            }, speedMs);
        }

        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>