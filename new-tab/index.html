<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Primary Meta Tags -->
<title>New Tab – Customizable Local Dashboard</title>
<meta name="title" content="New Tab – Customizable Local Dashboard" />
<meta name="description" content="Customize your dashboard with draggable widgets like search, clock, and notes. Stay private with local storage, full control over layout and style." />

<!-- Favicon configuration -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Cdefs%3E%3ClinearGradient%20id%3D%22grad%22%20x1%3D%220%25%22%20y1%3D%220%25%22%20x2%3D%22100%25%22%20y2%3D%22100%25%22%3E%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23e4e4f7%22%20%2F%3E%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23ededee%22%20%2F%3E%3C%2FlinearGradient%3E%3C%2Fdefs%3E%3Crect%20width%3D%22100%22%20height%3D%22100%22%20rx%3D%2225%22%20fill%3D%22url(%23grad)%22%2F%3E%3Ctext%20x%3D%2250%22%20y%3D%2252%22%20font-family%3D%22system-ui%2C%20-apple-system%2C%20sans-serif%22%20font-size%3D%2269%22%20text-anchor%3D%22middle%22%20dominant-baseline%3D%22middle%22%20fill%3D%22%23ffffff%22%3E%F0%9F%93%8D%3C%2Ftext%3E%3C%2Fsvg%3E">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="manifest" href="/site.webmanifest">

<!-- Open Graph -->
<meta property="og:type" content="website" />
<meta property="og:url" content="https://stefone.com/new-tab/" />
<meta property="og:title" content="New Tab – Customizable Local Dashboard" />
<meta property="og:description" content="Customize your dashboard with draggable widgets like search, clock, and notes. Stay private with local storage, full control over layout and style." />
<meta property="og:image" content="https://stefone.com/assets/thumbs/new-tab.png" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:image:alt" content="New Tab – Customizable Local Dashboard preview" />

<!-- Twitter / X -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="New Tab – Customizable Local Dashboard" />
<meta name="twitter:description" content="Customize your dashboard with draggable widgets like search, clock, and notes. Stay private with local storage, full control over layout and style." />
<meta name="twitter:image" content="https://stefone.com/assets/thumbs/new-tab.png" />

<!-- Optional -->
<meta name="theme-color" content="#e4e4f7">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for in-browser JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #111827; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, createContext, useContext } = React;

        // --- Global Dashboard Context ---
        const DashboardContext = createContext();

        // --- Inline Icons ---
        const Icon = ({ d, size = 24, className = '', ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{__html: d}} {...props} />
        );
        
        const ICONS = {
            Clock: '<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',
            StickyNote: '<path d="M15.5 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2V8.5L15.5 3Z"/><path d="M15 3v6h6"/>',
            LinkIcon: '<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>',
            Rss: '<path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/>',
            Timer: '<line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/>',
            CalendarIcon: '<rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/>',
            Settings: '<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/>',
            Lock: '<rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>',
            Unlock: '<rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/>',
            Plus: '<path d="M5 12h14"/><path d="M12 5v14"/>',
            X: '<path d="M18 6 6 18"/><path d="M6 6l12 12"/>',
            GripHorizontal: '<circle cx="12" cy="9" r="1"/><circle cx="19" cy="9" r="1"/><circle cx="5" cy="9" r="1"/><circle cx="12" cy="15" r="1"/><circle cx="19" cy="15" r="1"/><circle cx="5" cy="15" r="1"/>',
            Maximize2: '<polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" x2="14" y1="3" y2="10"/><line x1="3" x2="10" y1="21" y2="14"/>',
            Trash2: '<path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>',
            RotateCcw: '<path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>',
            ArrowLeft: '<path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>',
            Search: '<circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/>'
        };

        const ClockIcon = (props) => <Icon d={ICONS.Clock} {...props} />;
        const StickyNoteIcon = (props) => <Icon d={ICONS.StickyNote} {...props} />;
        const LinkIcon = (props) => <Icon d={ICONS.LinkIcon} {...props} />;
        const RssIcon = (props) => <Icon d={ICONS.Rss} {...props} />;
        const TimerIcon = (props) => <Icon d={ICONS.Timer} {...props} />;
        const CalendarIcon = (props) => <Icon d={ICONS.CalendarIcon} {...props} />;
        const SettingsIcon = (props) => <Icon d={ICONS.Settings} {...props} />;
        const LockIcon = (props) => <Icon d={ICONS.Lock} {...props} />;
        const UnlockIcon = (props) => <Icon d={ICONS.Unlock} {...props} />;
        const PlusIcon = (props) => <Icon d={ICONS.Plus} {...props} />;
        const XIcon = (props) => <Icon d={ICONS.X} {...props} />;
        const GripHorizontalIcon = (props) => <Icon d={ICONS.GripHorizontal} {...props} />;
        const Maximize2Icon = (props) => <Icon d={ICONS.Maximize2} {...props} />;
        const Trash2Icon = (props) => <Icon d={ICONS.Trash2} {...props} />;
        const RotateCcwIcon = (props) => <Icon d={ICONS.RotateCcw} {...props} />;
        const ArrowLeftIcon = (props) => <Icon d={ICONS.ArrowLeft} {...props} />;
        const SearchIcon = (props) => <Icon d={ICONS.Search} {...props} />;

        // --- Theme Configurations ---
        const THEMES = {
            blue: { name: 'Blue', hex: '#3b82f6', bg: 'bg-blue-500', hover: 'hover:bg-blue-400', text: 'text-blue-500', ring: 'hover:ring-blue-400', focusRing: 'focus:ring-blue-400', shadow: 'shadow-blue-500/50', groupHover: 'group-hover:text-blue-300' },
            emerald: { name: 'Emerald', hex: '#10b981', bg: 'bg-emerald-500', hover: 'hover:bg-emerald-400', text: 'text-emerald-500', ring: 'hover:ring-emerald-400', focusRing: 'focus:ring-emerald-400', shadow: 'shadow-emerald-500/50', groupHover: 'group-hover:text-emerald-300' },
            purple: { name: 'Purple', hex: '#a855f7', bg: 'bg-purple-500', hover: 'hover:bg-purple-400', text: 'text-purple-500', ring: 'hover:ring-purple-400', focusRing: 'focus:ring-purple-400', shadow: 'shadow-purple-500/50', groupHover: 'group-hover:text-purple-300' },
            rose: { name: 'Rose', hex: '#f43f5e', bg: 'bg-rose-500', hover: 'hover:bg-rose-400', text: 'text-rose-500', ring: 'hover:ring-rose-400', focusRing: 'focus:ring-rose-400', shadow: 'shadow-rose-500/50', groupHover: 'group-hover:text-rose-300' },
            orange: { name: 'Orange', hex: '#f97316', bg: 'bg-orange-500', hover: 'hover:bg-orange-400', text: 'text-orange-500', ring: 'hover:ring-orange-400', focusRing: 'focus:ring-orange-400', shadow: 'shadow-orange-500/50', groupHover: 'group-hover:text-orange-300' },
        };

        const STYLES = {
            glass: { name: 'Glassmorphism', container: 'backdrop-blur-xl border-white/20 bg-white/10', header: 'bg-black/20 border-white/10' },
            dark: { name: 'Solid Dark', container: 'bg-gray-900/95 border-gray-700 shadow-black/50', header: 'bg-gray-800 border-gray-700' },
            transparent: { name: 'Minimal Transparent', container: 'backdrop-blur-sm border-transparent bg-transparent hover:border-white/10 hover:bg-white/5', header: 'bg-transparent border-transparent' }
        };

        // --- Default State ---
        const DEFAULT_BG = "https://images.unsplash.com/photo-1506744626753-1436eba1b32f?ixlib=rb-4.0.3&auto=format&fit=crop&w=2560&q=80";

        const DEFAULT_WIDGETS = [
            { id: 'search-1', type: 'search', x: 340, y: 30, w: 440, h: 80, data: {} },
            { id: 'clock-1', type: 'clock', x: 50, y: 130, w: 320, h: 160, data: {} },
            { id: 'notes-1', type: 'notes', x: 400, y: 130, w: 300, h: 300, data: { text: "Welcome to your new dashboard!\n\nClick the 'Unlock & Edit' button at the bottom to move and resize these widgets." } },
            { id: 'links-1', type: 'links', x: 50, y: 310, w: 320, h: 250, data: { links: [{ title: 'Google', url: 'https://google.com' }, { title: 'GitHub', url: 'https://github.com' }] } },
            { id: 'calendar-1', type: 'calendar', x: 730, y: 130, w: 320, h: 340, data: {} },
            { id: 'stopwatch-1', type: 'stopwatch', x: 400, y: 450, w: 300, h: 200, data: {} },
            { id: 'rss-1', type: 'rss', x: 730, y: 490, w: 320, h: 350, data: { url: 'https://feeds.bbci.co.uk/news/world/rss.xml' } }
        ];

        // --- Helper Hook for Debouncing ---
        function useDebounce(value, delay) {
            const [debouncedValue, setDebouncedValue] = useState(value);
            useEffect(() => {
                const handler = setTimeout(() => { setDebouncedValue(value); }, delay);
                return () => clearTimeout(handler);
            }, [value, delay]);
            return debouncedValue;
        }

        function App() {
            const [widgets, setWidgets] = useState([]);
            const [bgImage, setBgImage] = useState(DEFAULT_BG);
            const [themeColor, setThemeColor] = useState('blue');
            const [widgetStyle, setWidgetStyle] = useState('glass');
            const [isLocked, setIsLocked] = useState(true);
            const [showAddMenu, setShowAddMenu] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [snapToGrid, setSnapToGrid] = useState(true);

            const GRID_SIZE = 20;
            const STORAGE_KEY = 'my-new-tab-dashboard';
            
            // Drag and Resize State
            const [dragging, setDragging] = useState(null);
            const [resizing, setResizing] = useState(null);

            const containerRef = useRef(null);
            const isLoadedRef = useRef(false);

            // --- Auto-Center Logic ---
            const centerWidgets = useCallback((widgetsList) => {
                if (!widgetsList || widgetsList.length === 0) return widgetsList;
                
                let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
                
                widgetsList.forEach(w => {
                    if (w.x < minX) minX = w.x;
                    if (w.x + w.w > maxX) maxX = w.x + w.w;
                    if (w.y < minY) minY = w.y;
                    if (w.y + w.h > maxY) maxY = w.y + w.h;
                });
                
                const groupWidth = maxX - minX;
                const groupHeight = maxY - minY;
                
                // SAFEGUARD: Ensure target positions never clip off the top or left edges!
                const targetX = Math.max(20, (window.innerWidth - groupWidth) / 2);
                const targetY = Math.max(40, (window.innerHeight - groupHeight) / 2);
                
                const offsetX = targetX - minX;
                const offsetY = targetY - minY;
                
                return widgetsList.map(w => ({
                    ...w,
                    x: Math.round(w.x + offsetX),
                    y: Math.round(w.y + offsetY)
                }));
            }, []);

            // --- Load Data from Local Storage ---
            useEffect(() => {
                try {
                    const savedData = localStorage.getItem(STORAGE_KEY);
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        setWidgets(data.widgets || centerWidgets(DEFAULT_WIDGETS));
                        setBgImage(data.bgImage || DEFAULT_BG);
                        if (data.themeColor && THEMES[data.themeColor]) setThemeColor(data.themeColor);
                        if (data.widgetStyle && STYLES[data.widgetStyle]) setWidgetStyle(data.widgetStyle);
                        if (data.snapToGrid !== undefined) setSnapToGrid(data.snapToGrid);
                    } else {
                        setWidgets(centerWidgets(DEFAULT_WIDGETS));
                    }
                } catch (e) {
                    console.error("Error loading local data", e);
                    setWidgets(centerWidgets(DEFAULT_WIDGETS));
                }
                isLoadedRef.current = true;
            }, [centerWidgets]);

            // --- Save Data to Local Storage ---
            const debouncedWidgets = useDebounce(widgets, 1000);
            
            useEffect(() => {
                if (!isLoadedRef.current) return;
                try {
                    const dataToSave = {
                        widgets: debouncedWidgets,
                        bgImage: bgImage,
                        themeColor: themeColor,
                        widgetStyle: widgetStyle,
                        snapToGrid: snapToGrid
                    };
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                } catch (e) {
                    console.error("Error saving local data", e);
                }
            }, [debouncedWidgets, bgImage, themeColor, widgetStyle, snapToGrid]);

            // --- Window Resize Auto-Centering ---
            useEffect(() => {
                let timeoutId;
                const handleResize = () => {
                    setWidgets(prev => centerWidgets(prev));
                };
                const debouncedResize = () => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(handleResize, 500);
                };
                window.addEventListener('resize', debouncedResize);
                return () => {
                    window.removeEventListener('resize', debouncedResize);
                    clearTimeout(timeoutId);
                };
            }, [centerWidgets]);

            // --- Widget Interaction Logic ---
            const updateWidgetData = (id, newData) => {
                setWidgets(prev => prev.map(w => w.id === id ? { ...w, data: { ...w.data, ...newData } } : w));
            };

            const removeWidget = (id) => {
                setWidgets(prev => prev.filter(w => w.id !== id));
            };

            const addWidget = (type) => {
                const w = type === 'search' ? 440 : 300;
                const h = type === 'clock' ? 160 : type === 'search' ? 80 : 300;
                
                const newWidget = {
                    id: `${type}-${Date.now()}`,
                    type,
                    // Perfectly center the new widget relative to its own size
                    x: Math.max(20, (window.innerWidth / 2) - (w / 2)),
                    y: Math.max(40, (window.innerHeight / 2) - (h / 2)),
                    w,
                    h,
                    data: {}
                };
                
                if (type === 'links') newWidget.data.links = [];
                if (type === 'rss') newWidget.data.url = 'https://feeds.bbci.co.uk/news/world/rss.xml';
                
                setWidgets([...widgets, newWidget]);
                setShowAddMenu(false);
            };

            const resetLayout = () => {
                setWidgets(centerWidgets(DEFAULT_WIDGETS));
                setBgImage(DEFAULT_BG);
                setThemeColor('blue');
                setWidgetStyle('glass');
                setShowSettings(false);
            };

            // --- Drag & Resize Handlers ---
            const onPointerDownDrag = (e, id) => {
                if (isLocked) return;
                e.stopPropagation();
                const widget = widgets.find(w => w.id === id);
                setDragging({ id, startX: e.clientX, startY: e.clientY, initialX: widget.x, initialY: widget.y });
            };

            const onPointerDownResize = (e, id) => {
                if (isLocked) return;
                e.stopPropagation();
                const widget = widgets.find(w => w.id === id);
                setResizing({ id, startX: e.clientX, startY: e.clientY, initialW: widget.w, initialH: widget.h });
            };

            useEffect(() => {
                const snap = (val) => snapToGrid ? Math.round(val / GRID_SIZE) * GRID_SIZE : val;

                const onPointerMove = (e) => {
                    if (dragging) {
                        const dx = e.clientX - dragging.startX;
                        const dy = e.clientY - dragging.startY;
                        setWidgets(prev => prev.map(w => 
                            w.id === dragging.id ? { ...w, x: Math.max(0, snap(dragging.initialX + dx)), y: Math.max(0, snap(dragging.initialY + dy)) } : w
                        ));
                    } else if (resizing) {
                        const dx = e.clientX - resizing.startX;
                        const dy = e.clientY - resizing.startY;
                        setWidgets(prev => prev.map(w => 
                            w.id === resizing.id ? { ...w, w: Math.max(150, snap(resizing.initialW + dx)), h: Math.max(80, snap(resizing.initialH + dy)) } : w
                        ));
                    }
                };

                const onPointerUp = () => {
                    setDragging(null);
                    setResizing(null);
                };

                if (dragging || resizing) {
                    window.addEventListener('pointermove', onPointerMove);
                    window.addEventListener('pointerup', onPointerUp);
                }
                return () => {
                    window.removeEventListener('pointermove', onPointerMove);
                    window.removeEventListener('pointerup', onPointerUp);
                };
            }, [dragging, resizing, snapToGrid]);


            // --- Renderers ---
            const renderWidgetContent = (widget) => {
                switch (widget.type) {
                    case 'search': return <SearchWidget />;
                    case 'clock': return <ClockWidget />;
                    case 'notes': return <NotesWidget data={widget.data} onChange={(d) => updateWidgetData(widget.id, d)} />;
                    case 'links': return <LinksWidget data={widget.data} onChange={(d) => updateWidgetData(widget.id, d)} />;
                    case 'calendar': return <CalendarWidget />;
                    case 'stopwatch': return <StopwatchWidget />;
                    case 'rss': return <RssWidget data={widget.data} onChange={(d) => updateWidgetData(widget.id, d)} />;
                    default: return null;
                }
            };

            const activeTheme = THEMES[themeColor];
            const activeStyle = STYLES[widgetStyle];

            return (
                <DashboardContext.Provider value={{ isLocked, theme: activeTheme, style: activeStyle }}>
                    <div 
                        className="w-full h-screen overflow-hidden relative font-sans text-white select-none transition-colors duration-500 bg-gray-900"
                        style={{
                            backgroundImage: `linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0.6)), url(${bgImage})`,
                            backgroundSize: 'cover',
                            backgroundPosition: 'center',
                        }}
                        ref={containerRef}
                    >
                        {/* Background Overlay for Editing Mode */}
                        {!isLocked && (
                            <div className="absolute inset-0 bg-black/30 pointer-events-none z-0 border-[6px] border-white/50 transition-all duration-300">
                                {snapToGrid && (
                                    <div
                                        className="absolute inset-0 opacity-20"
                                        style={{
                                            backgroundImage: 'linear-gradient(to right, white 1px, transparent 1px), linear-gradient(to bottom, white 1px, transparent 1px)',
                                            backgroundSize: `${GRID_SIZE}px ${GRID_SIZE}px`
                                        }}
                                    />
                                )}
                                <div className={`absolute top-4 left-1/2 -translate-x-1/2 ${activeTheme.bg} text-white px-6 py-2 rounded-full font-bold shadow-lg animate-pulse`}>
                                    EDIT MODE ACTIVE
                                </div>
                            </div>
                        )}

                        {/* Widgets Workspace */}
                        <div className="absolute inset-0 z-10 overflow-hidden">
                            {widgets.map(widget => (
                                <div
                                    key={widget.id}
                                    className={`absolute flex flex-col rounded-3xl shadow-2xl border transition-shadow duration-300
                                        ${activeStyle.container}
                                        ${!isLocked ? `hover:ring-4 ${activeTheme.ring} ring-offset-transparent cursor-grab active:cursor-grabbing` : 'pointer-events-auto'}
                                        ${dragging?.id === widget.id ? 'z-50 opacity-90 scale-[1.02]' : 'z-10'}
                                    `}
                                    style={{
                                        left: widget.x,
                                        top: widget.y,
                                        width: widget.w,
                                        height: widget.h,
                                    }}
                                    onPointerDown={(e) => onPointerDownDrag(e, widget.id)}
                                >
                                    {/* Widget Header (visible in edit mode) */}
                                    {!isLocked && (
                                        <div className={`flex justify-between items-center p-3 rounded-t-3xl border-b backdrop-blur-md ${activeStyle.header}`}>
                                            <div className="flex items-center space-x-2 opacity-70">
                                                <GripHorizontalIcon size={18} />
                                                <span className="text-xs font-semibold uppercase tracking-wider">{widget.type}</span>
                                            </div>
                                            <button 
                                                onPointerDown={(e) => e.stopPropagation()} 
                                                onClick={() => removeWidget(widget.id)}
                                                className="p-1.5 hover:bg-red-500/80 rounded-full transition-colors"
                                            >
                                                <Trash2Icon size={16} />
                                            </button>
                                        </div>
                                    )}

                                    {/* Widget Content */}
                                    <div 
                                        className="flex-1 overflow-hidden p-5 flex flex-col"
                                        onPointerDown={(e) => !isLocked && e.stopPropagation()} 
                                    >
                                        {renderWidgetContent(widget)}
                                    </div>

                                    {/* Resize Handle */}
                                    {!isLocked && (
                                        <div 
                                            className="absolute bottom-2 right-2 w-6 h-6 cursor-se-resize flex items-center justify-center opacity-50 hover:opacity-100 hover:bg-white/20 rounded-full transition-all"
                                            onPointerDown={(e) => onPointerDownResize(e, widget.id)}
                                        >
                                            <Maximize2Icon size={14} className="transform rotate-90" />
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>

                        {/* Bottom Control Bar Wrapper */}
                        <div className={`absolute bottom-0 left-0 w-full h-32 flex items-end justify-center pb-6 z-50 transition-opacity duration-300 ${isLocked ? 'opacity-0 hover:opacity-100' : 'opacity-100'}`}>
                            <div className="flex items-center space-x-4 bg-black/40 backdrop-blur-xl border border-white/10 p-3 rounded-full shadow-2xl pointer-events-auto">
                                <a 
                                    href="/projects/"
                                    className="p-3 rounded-full hover:bg-white/20 text-white/80 hover:text-white transition-all"
                                    title="Back to Projects"
                                >
                                    <ArrowLeftIcon size={24} />
                                </a>
                                <div className="w-px h-8 bg-white/20 mx-2"></div>

                                <button 
                                    onClick={() => setShowAddMenu(!showAddMenu)}
                                    className={`p-3 rounded-full transition-all ${showAddMenu ? 'bg-white/30 text-white' : 'hover:bg-white/20 text-white/80 hover:text-white'}`}
                                    title="Add Widget"
                                >
                                    <PlusIcon size={24} />
                                </button>
                                <button 
                                    onClick={() => setShowSettings(!showSettings)}
                                    className={`p-3 rounded-full transition-all ${showSettings ? 'bg-white/30 text-white' : 'hover:bg-white/20 text-white/80 hover:text-white'}`}
                                    title="Settings"
                                >
                                    <SettingsIcon size={24} />
                                </button>
                                <div className="w-px h-8 bg-white/20 mx-2"></div>
                                <button 
                                    onClick={() => setIsLocked(!isLocked)}
                                    className={`flex items-center space-x-2 px-6 py-3 rounded-full font-semibold transition-all shadow-lg
                                        ${isLocked ? 'bg-white/10 hover:bg-white/20 text-white' : `${activeTheme.bg} ${activeTheme.hover} text-white ${activeTheme.shadow}`}
                                    `}
                                >
                                    {isLocked ? <LockIcon size={20} /> : <UnlockIcon size={20} />}
                                    <span>{isLocked ? 'Lock Layout' : 'Unlock & Edit'}</span>
                                </button>
                            </div>
                        </div>

                        {/* Add Widget Menu Overlay */}
                        {showAddMenu && (
                            <div className="absolute bottom-24 left-1/2 -translate-x-1/2 z-50 bg-black/60 backdrop-blur-2xl border border-white/10 p-4 rounded-3xl shadow-2xl flex space-x-4">
                                {[
                                    { type: 'search', icon: SearchIcon, label: 'Search' },
                                    { type: 'clock', icon: ClockIcon, label: 'Clock' },
                                    { type: 'notes', icon: StickyNoteIcon, label: 'Notes' },
                                    { type: 'links', icon: LinkIcon, label: 'Links' },
                                    { type: 'calendar', icon: CalendarIcon, label: 'Calendar' },
                                    { type: 'stopwatch', icon: TimerIcon, label: 'Timer' },
                                    { type: 'rss', icon: RssIcon, label: 'RSS' }
                                ].map(w => (
                                    <button 
                                        key={w.type}
                                        onClick={() => addWidget(w.type)}
                                        className="flex flex-col items-center justify-center p-4 w-24 h-24 rounded-2xl hover:bg-white/10 transition-all border border-transparent hover:border-white/20"
                                    >
                                        <w.icon size={32} className="mb-2 opacity-80" />
                                        <span className="text-xs font-semibold">{w.label}</span>
                                    </button>
                                ))}
                            </div>
                        )}

                        {/* Settings Modal */}
                        {showSettings && (
                            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 w-[420px] bg-black/80 backdrop-blur-3xl border border-white/20 p-8 rounded-3xl shadow-2xl">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold flex items-center"><SettingsIcon className="mr-3" /> Settings</h2>
                                    <button onClick={() => setShowSettings(false)} className="hover:bg-white/10 p-2 rounded-full"><XIcon size={20}/></button>
                                </div>
                                
                                <div className="space-y-6">
                                    {/* Themes */}
                                    <div>
                                        <label className="block text-sm font-semibold mb-3 text-white">Theme Color</label>
                                        <div className="flex space-x-3">
                                            {Object.entries(THEMES).map(([key, t]) => (
                                                <button
                                                    key={key}
                                                    onClick={() => setThemeColor(key)}
                                                    className={`w-8 h-8 rounded-full transition-all ${themeColor === key ? 'scale-125 ring-2 ring-offset-2 ring-offset-black ring-white shadow-lg' : 'hover:scale-110 opacity-70 hover:opacity-100'}`}
                                                    style={{ backgroundColor: t.hex }}
                                                    title={t.name}
                                                />
                                            ))}
                                        </div>
                                    </div>

                                    {/* Widget Style */}
                                    <div className="pt-4 border-t border-white/10">
                                        <label className="block text-sm font-semibold mb-3 text-white">Widget Style</label>
                                        <div className="grid grid-cols-3 gap-2">
                                            {Object.entries(STYLES).map(([key, s]) => (
                                                <button
                                                    key={key}
                                                    onClick={() => setWidgetStyle(key)}
                                                    className={`p-2 text-xs font-semibold rounded-lg border transition-all flex flex-col items-center text-center
                                                        ${widgetStyle === key ? 'bg-white/20 border-white/50 text-white' : 'bg-white/5 border-transparent text-white/50 hover:bg-white/10'}
                                                    `}
                                                >
                                                    {s.name}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Background Image */}
                                    <div className="pt-4 border-t border-white/10">
                                        <label className="block text-sm font-semibold mb-2 opacity-80">Background Image URL</label>
                                        <input 
                                            type="text" 
                                            value={bgImage}
                                            onChange={(e) => setBgImage(e.target.value)}
                                            className={`w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white focus:outline-none focus:border-transparent focus:ring-2 ${activeTheme.focusRing}`}
                                            placeholder="https://..."
                                        />
                                    </div>

                                    <div className="flex items-center justify-between pt-4 border-t border-white/10">
                                        <div>
                                            <label className="block text-sm font-semibold text-white">Snap to Grid</label>
                                            <p className="text-xs opacity-50">Align widgets perfectly when editing.</p>
                                        </div>
                                        <button
                                            onClick={() => setSnapToGrid(!snapToGrid)}
                                            className={`w-12 h-6 rounded-full transition-colors relative ${snapToGrid ? activeTheme.bg : 'bg-white/20'}`}
                                        >
                                            <div className={`absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform ${snapToGrid ? 'translate-x-6' : 'translate-x-0'}`} />
                                        </button>
                                    </div>

                                    <div className="pt-4 border-t border-white/10">
                                        <button 
                                            onClick={resetLayout}
                                            className="w-full flex items-center justify-center space-x-2 py-3 bg-red-500/20 hover:bg-red-500/40 text-red-200 rounded-xl transition-all"
                                        >
                                            <RotateCcwIcon size={18} />
                                            <span>Reset Default Layout</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </DashboardContext.Provider>
            );
        }

        // --- WIDGET COMPONENTS ---

        function SearchWidget() {
            const { theme } = useContext(DashboardContext);
            const [query, setQuery] = useState('');
            const inputRef = useRef(null);

            useEffect(() => {
                // Focus the input when the search widget mounts (e.g., on page load)
                if (inputRef.current) {
                    inputRef.current.focus();
                }
            }, []);

            const handleSearch = (e) => {
                e.preventDefault();
                if (query.trim()) {
                    window.location.href = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
                }
            };

            return (
                <div className="w-full h-full flex flex-col justify-center items-center" onPointerDown={(e) => e.stopPropagation()}>
                    <form onSubmit={handleSearch} className="w-full relative flex items-center">
                        <SearchIcon size={24} className="absolute left-5 opacity-50 pointer-events-none" />
                        <input 
                            ref={inputRef}
                            type="text" 
                            value={query}
                            onChange={(e) => setQuery(e.target.value)}
                            placeholder="Search the web..."
                            className={`w-full bg-black/20 hover:bg-black/30 focus:bg-black/40 border border-white/20 rounded-full py-4 pl-14 pr-6 text-lg outline-none transition-all focus:ring-2 focus:border-transparent ${theme.focusRing} backdrop-blur-sm`}
                        />
                    </form>
                </div>
            );
        }

        function ClockWidget() {
            const [time, setTime] = useState(new Date());

            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            return (
                <div className="w-full h-full flex flex-col items-center justify-center pointer-events-none">
                    <div className="text-7xl font-bold tracking-tighter drop-shadow-md">
                        {time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                    </div>
                    <div className="text-xl opacity-80 mt-2 font-medium drop-shadow-sm">
                        {time.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' })}
                    </div>
                </div>
            );
        }

        function NotesWidget({ data, onChange }) {
            return (
                <div className="w-full h-full flex flex-col">
                    <div className="flex items-center mb-3 opacity-70">
                        <StickyNoteIcon size={18} className="mr-2" />
                        <h3 className="font-semibold text-sm uppercase tracking-wider">Quick Notes</h3>
                    </div>
                    <textarea
                        className="flex-1 w-full bg-transparent resize-none outline-none text-white placeholder-white/30 custom-scrollbar"
                        value={data.text || ''}
                        onChange={(e) => onChange({ text: e.target.value })}
                        placeholder="Type something..."
                        onPointerDown={(e) => e.stopPropagation()} 
                    />
                </div>
            );
        }

        function LinksWidget({ data, onChange }) {
            const { theme } = useContext(DashboardContext);
            const [newLink, setNewLink] = useState('');
            const [newTitle, setNewTitle] = useState('');
            const [adding, setAdding] = useState(false);
            const links = data.links || [];

            const addLink = (e) => {
                e.preventDefault();
                if (newLink && newTitle) {
                    onChange({ links: [...links, { title: newTitle, url: newLink.startsWith('http') ? newLink : `https://${newLink}` }] });
                    setNewLink(''); setNewTitle(''); setAdding(false);
                }
            };

            const removeLink = (index) => {
                onChange({ links: links.filter((_, i) => i !== index) });
            };

            return (
                <div className="w-full h-full flex flex-col">
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center opacity-70">
                            <LinkIcon size={18} className="mr-2" />
                            <h3 className="font-semibold text-sm uppercase tracking-wider">Bookmarks</h3>
                        </div>
                        <button 
                            onClick={() => setAdding(!adding)} 
                            className="p-1.5 hover:bg-white/20 rounded-full transition-all"
                            onPointerDown={(e) => e.stopPropagation()}
                        >
                            {adding ? <XIcon size={16} /> : <PlusIcon size={16} />}
                        </button>
                    </div>

                    {adding && (
                        <form onSubmit={addLink} className="mb-4 space-y-2" onPointerDown={(e) => e.stopPropagation()}>
                            <input 
                                type="text" placeholder="Title (e.g. Reddit)" value={newTitle} onChange={e => setNewTitle(e.target.value)}
                                className={`w-full bg-white/10 rounded-lg px-3 py-2 text-sm outline-none focus:bg-white/20 focus:ring-1 ${theme.focusRing}`} autoFocus
                            />
                            <div className="flex space-x-2">
                                <input 
                                    type="text" placeholder="URL (reddit.com)" value={newLink} onChange={e => setNewLink(e.target.value)}
                                    className={`flex-1 bg-white/10 rounded-lg px-3 py-2 text-sm outline-none focus:bg-white/20 focus:ring-1 ${theme.focusRing}`}
                                />
                                <button type="submit" className={`${theme.bg} ${theme.hover} px-3 py-2 rounded-lg text-sm font-semibold transition-colors`}>Add</button>
                            </div>
                        </form>
                    )}

                    <div className="flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-2" onPointerDown={(e) => e.stopPropagation()}>
                        {links.map((link, i) => (
                            <div key={i} className="flex items-center group bg-white/5 hover:bg-white/10 rounded-xl transition-colors">
                                <a 
                                    href={link.url} target="_blank" rel="noopener noreferrer" 
                                    className={`flex-1 p-3 truncate font-medium text-sm flex items-center transition-colors ${theme.groupHover}`}
                                >
                                    <img 
                                        src={`https://www.google.com/s2/favicons?domain=${link.url}&sz=32`} 
                                        alt="" className="w-5 h-5 mr-3 rounded-full bg-white/20"
                                        onError={(e) => { e.target.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJyZ2JhKDI1NSwyNTUsMjU1LDAuNSkiIHN0cm9rZS13aWR0aD0iMiI+PGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiLz48L3N2Zz4='; }}
                                    />
                                    {link.title}
                                </a>
                                <button 
                                    onClick={() => removeLink(i)} 
                                    className="p-3 opacity-0 group-hover:opacity-100 hover:text-red-400 transition-all"
                                >
                                    <XIcon size={16} />
                                </button>
                            </div>
                        ))}
                        {links.length === 0 && !adding && <p className="text-center text-sm opacity-50 mt-4">No bookmarks yet. Click + to add.</p>}
                    </div>
                </div>
            );
        }

        function StopwatchWidget() {
            const { theme } = useContext(DashboardContext);
            const [time, setTime] = useState(0);
            const [isRunning, setIsRunning] = useState(false);
            const timerRef = useRef(null);

            useEffect(() => {
                if (isRunning) {
                    timerRef.current = setInterval(() => setTime(t => t + 10), 10);
                } else {
                    clearInterval(timerRef.current);
                }
                return () => clearInterval(timerRef.current);
            }, [isRunning]);

            const formatTime = (ms) => {
                const mins = Math.floor(ms / 60000);
                const secs = Math.floor((ms % 60000) / 1000);
                const millis = Math.floor((ms % 1000) / 10);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${millis.toString().padStart(2, '0')}`;
            };

            return (
                <div className="w-full h-full flex flex-col items-center justify-center" onPointerDown={(e) => e.stopPropagation()}>
                    <div className="flex items-center mb-4 opacity-70 absolute top-5 left-5">
                        <TimerIcon size={18} className="mr-2" />
                        <h3 className="font-semibold text-sm uppercase tracking-wider">Stopwatch</h3>
                    </div>
                    
                    <div className="text-5xl font-mono font-light tracking-wider mb-6 drop-shadow-lg">
                        {formatTime(time)}
                    </div>
                    
                    <div className="flex space-x-4">
                        <button 
                            onClick={() => setIsRunning(!isRunning)}
                            className={`w-16 h-16 rounded-full flex items-center justify-center shadow-lg transition-all border-2
                                ${isRunning ? 'bg-red-500/20 border-red-500 text-red-200 hover:bg-red-500/40' : `${theme.bg} ${theme.shadow} border-transparent text-white ${theme.hover}`}
                            `}
                        >
                            <span className="font-semibold">{isRunning ? 'Stop' : 'Start'}</span>
                        </button>
                        <button 
                            onClick={() => { setIsRunning(false); setTime(0); }}
                            className="w-16 h-16 rounded-full flex items-center justify-center bg-white/10 hover:bg-white/20 border-2 border-white/30 transition-all font-semibold"
                        >
                            Reset
                        </button>
                    </div>
                </div>
            );
        }

        function CalendarWidget() {
            const { theme } = useContext(DashboardContext);
            const today = new Date();
            const [currentMonth, setCurrentMonth] = useState(new Date(today.getFullYear(), today.getMonth(), 1));

            const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
            const startDay = currentMonth.getDay();

            const prevMonth = () => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1));
            const nextMonth = () => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1));

            const days = [];
            for (let i = 0; i < startDay; i++) days.push(null);
            for (let i = 1; i <= daysInMonth; i++) days.push(i);

            const isToday = (day) => {
                return day === today.getDate() && currentMonth.getMonth() === today.getMonth() && currentMonth.getFullYear() === today.getFullYear();
            };

            return (
                <div className="w-full h-full flex flex-col" onPointerDown={(e) => e.stopPropagation()}>
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="font-bold text-lg drop-shadow-sm">
                            {currentMonth.toLocaleDateString([], { month: 'long', year: 'numeric' })}
                        </h3>
                        <div className="flex space-x-2">
                            <button onClick={prevMonth} className="p-1 hover:bg-white/20 rounded-md transition-all">&lt;</button>
                            <button onClick={nextMonth} className="p-1 hover:bg-white/20 rounded-md transition-all">&gt;</button>
                        </div>
                    </div>

                    <div className="grid grid-cols-7 gap-1 text-center text-xs font-semibold opacity-70 mb-2">
                        {['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'].map(d => <div key={d}>{d}</div>)}
                    </div>

                    <div className="grid grid-cols-7 gap-1 flex-1">
                        {days.map((day, i) => (
                            <div 
                                key={i} 
                                className={`flex items-center justify-center text-sm rounded-lg transition-all
                                    ${day ? 'hover:bg-white/10 cursor-default' : ''}
                                    ${isToday(day) ? `${theme.bg} font-bold shadow-md ${theme.shadow} text-white` : ''}
                                `}
                            >
                                {day}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function RssWidget({ data, onChange }) {
            const { theme } = useContext(DashboardContext);
            const [feed, setFeed] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [editingUrl, setEditingUrl] = useState(false);
            const [tempUrl, setTempUrl] = useState(data.url || '');

            useEffect(() => {
                const fetchFeed = async () => {
                    setLoading(true); setError(null);
                    try {
                        let feedUrl = data.url;
                        if (feedUrl && !/^https?:\/\//i.test(feedUrl)) {
                            feedUrl = 'https://' + feedUrl;
                        }
                        const response = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feedUrl)}`);
                        const result = await response.json();
                        if (result.status === 'ok') {
                            setFeed(result.items);
                        } else {
                            setError('Could not load feed.');
                        }
                    } catch (err) {
                        setError('Error fetching feed.');
                    } finally {
                        setLoading(false);
                    }
                };
                if (data.url) fetchFeed();
            }, [data.url]);

            const saveUrl = (e) => {
                e.preventDefault();
                let newUrl = tempUrl.trim();
                if (newUrl && !/^https?:\/\//i.test(newUrl)) {
                    newUrl = 'https://' + newUrl;
                }
                onChange({ url: newUrl });
                setEditingUrl(false);
            };

            return (
                <div className="w-full h-full flex flex-col">
                    <div className="flex items-center justify-between mb-3 opacity-70">
                        <div className="flex items-center">
                            <RssIcon size={18} className="mr-2" />
                            <h3 className="font-semibold text-sm uppercase tracking-wider">Latest News</h3>
                        </div>
                        <button onClick={() => setEditingUrl(!editingUrl)} className="p-1 hover:bg-white/20 rounded transition-all" onPointerDown={e => e.stopPropagation()}>
                            <SettingsIcon size={14} />
                        </button>
                    </div>

                    {editingUrl ? (
                        <form onSubmit={saveUrl} className="mb-4 flex space-x-2" onPointerDown={(e) => e.stopPropagation()}>
                            <input 
                                type="text" value={tempUrl} onChange={e => setTempUrl(e.target.value)}
                                className={`flex-1 bg-white/10 rounded-lg px-3 py-2 text-sm outline-none focus:bg-white/20 focus:ring-1 ${theme.focusRing}`}
                                placeholder="RSS URL"
                            />
                            <button type="submit" className={`${theme.bg} ${theme.hover} px-3 py-2 rounded-lg text-sm font-semibold transition-colors`}>Save</button>
                        </form>
                    ) : null}

                    <div className="flex-1 overflow-y-auto custom-scrollbar space-y-3 pr-2" onPointerDown={(e) => e.stopPropagation()}>
                        {loading && <div className="text-sm opacity-50 text-center mt-4 animate-pulse">Loading feed...</div>}
                        {error && <div className="text-sm text-red-300 bg-red-500/20 p-3 rounded-xl">{error}</div>}
                        
                        {!loading && !error && feed.map((item, i) => (
                            <a 
                                key={i} href={item.link} target="_blank" rel="noopener noreferrer"
                                className="block group bg-white/5 hover:bg-white/10 p-3 rounded-xl transition-all border border-transparent hover:border-white/10"
                            >
                                <h4 className={`font-semibold text-sm leading-tight mb-1 transition-colors line-clamp-2 ${theme.groupHover}`}>{item.title}</h4>
                                <div className="text-xs opacity-50 flex items-center justify-between mt-2">
                                    <span className="truncate">{item.author || new URL(item.link).hostname.replace('www.','')}</span>
                                    <span>{new Date(item.pubDate).toLocaleDateString()}</span>
                                </div>
                            </a>
                        ))}
                    </div>
                </div>
            );
        }

        // Render Application
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>