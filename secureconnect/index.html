<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SecureConnect Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; }
        /* Hide scrollbar for clean UI */
        ::-webkit-scrollbar { display: none; }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        .glass-button {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
        }
        .glass-button:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .animate-pulse-slow {
            animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(1.05); }
        }
        
        video {
            transform: scaleX(-1); /* Mirror effect for natural feel */
            object-fit: cover;
        }
        /* Except for remote video which shouldn't always be mirrored depending on use case */
        .no-mirror { transform: none; }

        /* Custom gradient text */
        .text-gradient {
            background: linear-gradient(135deg, #34d399 0%, #22d3ee 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="h-screen w-full flex flex-col overflow-hidden relative">

    <!-- Ambient Background -->
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
        <div class="absolute -top-[20%] -left-[10%] w-[50vw] h-[50vw] bg-emerald-500/10 rounded-full blur-[120px] animate-pulse-slow"></div>
        <div class="absolute -bottom-[20%] -right-[10%] w-[50vw] h-[50vw] bg-cyan-500/10 rounded-full blur-[120px] animate-pulse-slow" style="animation-delay: 2s;"></div>
    </div>

    <!-- Navbar -->
    <nav class="flex justify-between items-center px-6 py-5 z-50 absolute top-0 w-full pointer-events-none">
        <div class="flex items-center gap-4 pointer-events-auto">
            <a href="/projects/" class="glass-button w-10 h-10 rounded-full flex items-center justify-center text-white/70 hover:text-white group" aria-label="Back to Projects">
                <i class="fas fa-arrow-left text-sm group-hover:-translate-x-0.5 transition-transform"></i>
            </a>
            <div class="flex items-center gap-2.5">
                <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-emerald-500 to-cyan-600 flex items-center justify-center shadow-lg shadow-emerald-500/20">
                    <i class="fas fa-shield-alt text-white text-xs"></i>
                </div>
                <span class="font-semibold tracking-tight text-white/90 hidden sm:block">SecureConnect</span>
            </div>
        </div>
        <div id="connectionStatus" class="hidden pointer-events-auto px-4 py-1.5 rounded-full text-xs font-semibold bg-red-500/10 text-red-400 border border-red-500/20 backdrop-blur-md shadow-lg shadow-black/10">
            Disconnected
        </div>
    </nav>

    <!-- Main Container -->
    <main id="app" class="flex-grow flex flex-col items-center justify-center p-4 relative z-10">
        
        <!-- SETUP SCREEN (For Local Use) -->
        <div id="configScreen" class="hidden w-full max-w-lg glass-panel p-8 rounded-3xl border border-yellow-500/20 shadow-2xl relative z-50">
            <h2 class="text-2xl font-bold text-white mb-2">Configuration Required</h2>
            <p class="text-slate-400 text-sm mb-6">
                This app uses Firebase for connections. Since you are running locally, the environment variables are missing.
            </p>
            <ol class="text-slate-300 text-xs list-decimal pl-5 mb-6 space-y-2">
                <li>Go to the <a href="https://console.firebase.google.com/" target="_blank" class="text-cyan-400 underline">Firebase Console</a> and create a project.</li>
                <li>Go to Project Settings > General > Add Web App.</li>
                <li>Copy the <code class="bg-black/30 px-1 py-0.5 rounded text-yellow-400">firebaseConfig</code> object (JSON) and paste it below.</li>
                <li>Ensure <strong>Firestore Database</strong> and <strong>Authentication (Anonymous)</strong> are enabled in your console.</li>
            </ol>
            <textarea id="manualConfigInput" rows="6" placeholder='{ "apiKey": "...", "authDomain": "...", ... }' class="w-full bg-black/40 border border-slate-700 rounded-xl p-4 text-xs font-mono text-white mb-4 focus:outline-none focus:border-cyan-500/50"></textarea>
            <button onclick="window.manualInit()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl transition-all">
                Initialize App
            </button>
        </div>

        <!-- MODE SELECTION (Home) -->
        <div id="homeScreen" class="hidden w-full max-w-md space-y-8 transition-all duration-500 ease-out transform translate-y-0 opacity-100">
            <div class="text-center space-y-3 mb-10">
                <h1 class="text-4xl font-bold text-white tracking-tight">
                    <span class="text-gradient">Remote Monitor</span>
                </h1>
                <p class="text-slate-400 text-sm font-medium">Turn this device into a security camera or a monitor.</p>
            </div>

            <div class="grid grid-cols-1 gap-5">
                <!-- Viewer Button -->
                <button onclick="app.setMode('viewer')" class="group relative p-6 rounded-2xl glass-panel hover:bg-white/[0.08] transition-all duration-300 border-l-4 border-emerald-500 text-left hover:shadow-xl hover:shadow-emerald-900/10 hover:-translate-y-1">
                    <div class="absolute right-6 top-6 w-12 h-12 rounded-full bg-emerald-500/10 flex items-center justify-center text-emerald-400 group-hover:bg-emerald-500/20 group-hover:scale-110 transition-all duration-300">
                        <i class="fas fa-desktop text-xl"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-1.5">Create Code</h3>
                    <p class="text-slate-400 text-xs leading-relaxed w-3/4">Use this device as the <strong>Monitor</strong>. Generate a code to link a camera.</p>
                </button>

                <!-- Camera Button -->
                <button onclick="app.setMode('camera')" class="group relative p-6 rounded-2xl glass-panel hover:bg-white/[0.08] transition-all duration-300 border-l-4 border-cyan-500 text-left hover:shadow-xl hover:shadow-cyan-900/10 hover:-translate-y-1">
                    <div class="absolute right-6 top-6 w-12 h-12 rounded-full bg-cyan-500/10 flex items-center justify-center text-cyan-400 group-hover:bg-cyan-500/20 group-hover:scale-110 transition-all duration-300">
                        <i class="fas fa-video text-xl"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-1.5">Enter Code</h3>
                    <p class="text-slate-400 text-xs leading-relaxed w-3/4">Use this device as the <strong>Camera</strong>. Connect to a remote monitor.</p>
                </button>
            </div>
        </div>

        <!-- VIEWER INTERFACE -->
        <div id="viewerScreen" class="hidden w-full h-full flex flex-col items-center justify-center relative">
            
            <!-- Code Display -->
            <div id="codeDisplay" class="absolute z-10 flex flex-col items-center justify-center bg-slate-900/90 inset-0 backdrop-blur-md transition-all duration-500">
                <div class="p-10 rounded-3xl glass-panel text-center max-w-sm w-full mx-4 border border-emerald-500/20 shadow-[0_0_80px_rgba(16,185,129,0.1)]">
                    <p class="text-emerald-400/80 text-xs font-bold uppercase tracking-widest mb-6">Connection Code</p>
                    <div id="generatedCode" class="text-6xl font-mono font-bold text-white tracking-widest mb-8 select-all drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]">
                        ...
                    </div>
                    <div class="flex items-center justify-center gap-3 text-slate-300 text-sm bg-white/5 py-2 px-4 rounded-full w-fit mx-auto border border-white/5">
                        <i class="fas fa-circle-notch fa-spin text-emerald-400"></i>
                        <span>Waiting for camera...</span>
                    </div>
                    <button onclick="app.reset()" class="mt-8 text-slate-500 hover:text-white text-sm font-medium transition-colors">Cancel</button>
                </div>
            </div>

            <!-- Remote Stream Container -->
            <div class="w-full h-full rounded-2xl overflow-hidden relative bg-black shadow-2xl flex items-center justify-center border border-white/5 ring-1 ring-white/5">
                <video id="remoteVideo" autoplay playsinline class="w-full h-full no-mirror object-contain"></video>
                <div id="streamPlaceholder" class="absolute inset-0 flex items-center justify-center text-slate-700/50">
                    <i class="fas fa-video-slash text-7xl"></i>
                </div>
            </div>

            <!-- Viewer Controls -->
            <div class="absolute bottom-8 left-0 right-0 flex justify-center gap-4 z-20 pointer-events-none">
                <div class="bg-black/40 backdrop-blur-xl p-2 rounded-full border border-white/10 flex gap-2 pointer-events-auto shadow-2xl">
                    <button onclick="app.toggleMuteRemote()" id="btnMute" class="w-12 h-12 rounded-full bg-white/10 text-white flex items-center justify-center hover:bg-white/20 transition-all hover:scale-105 active:scale-95">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <button onclick="app.toggleFullscreen()" class="w-12 h-12 rounded-full bg-white/10 text-white flex items-center justify-center hover:bg-white/20 transition-all hover:scale-105 active:scale-95">
                        <i class="fas fa-expand"></i>
                    </button>
                    <div class="w-px h-8 bg-white/10 self-center mx-1"></div>
                    <button onclick="app.reset()" class="w-12 h-12 rounded-full bg-red-500/80 text-white flex items-center justify-center hover:bg-red-600 transition-all hover:scale-105 active:scale-95 shadow-lg shadow-red-500/20">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- CAMERA INTERFACE -->
        <div id="cameraScreen" class="hidden w-full max-w-md flex flex-col items-center">
            
            <!-- Code Input Form -->
            <div id="codeInputForm" class="w-full glass-panel p-8 rounded-3xl border border-cyan-500/20 shadow-2xl">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-gradient-to-br from-cyan-500/20 to-blue-500/20 rounded-2xl flex items-center justify-center mx-auto mb-4 text-cyan-400 shadow-inner border border-white/5">
                        <i class="fas fa-camera text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white">Connect Camera</h3>
                    <p class="text-slate-400 text-xs mt-2">Enter the code displayed on the Monitor device.</p>
                </div>

                <div class="space-y-4">
                    <input type="number" id="codeJump" placeholder="000 000" class="w-full bg-black/30 border border-slate-700/50 rounded-xl p-4 text-center text-2xl font-mono tracking-widest text-white focus:outline-none focus:border-cyan-500/50 focus:ring-1 focus:ring-cyan-500/50 transition-all placeholder-slate-700">
                    <button onclick="app.connectCamera()" id="btnConnect" class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg shadow-cyan-900/20 hover:shadow-cyan-900/40 hover:-translate-y-0.5 flex items-center justify-center gap-2">
                        <span>Start Streaming</span>
                        <i class="fas fa-arrow-right text-sm"></i>
                    </button>
                    <button onclick="app.reset()" class="w-full text-slate-500 text-sm py-2 hover:text-slate-300 transition-colors">Cancel</button>
                </div>
            </div>

            <!-- Active Camera View (Hidden until connected usually, but we show preview) -->
            <div id="cameraPreviewContainer" class="hidden fixed inset-0 z-50 bg-black">
                <video id="localVideo" autoplay playsinline muted class="w-full h-full object-cover opacity-70"></video>
                
                <!-- Overlay UI -->
                <div class="absolute inset-0 flex flex-col items-center justify-between p-8 pt-20">
                    <div class="bg-red-500 text-white px-4 py-1.5 rounded-full text-xs font-bold animate-pulse shadow-[0_0_20px_rgba(239,68,68,0.4)] border border-red-400/50 backdrop-blur-sm">
                        <i class="fas fa-circle text-[8px] mr-2 align-middle"></i>LIVE STREAMING
                    </div>
                    
                    <div class="text-center space-y-4 w-full max-w-xs mb-8">
                        
                        <div class="grid grid-cols-2 gap-4">
                             <button onclick="app.toggleCamera()" class="h-14 rounded-2xl bg-black/40 backdrop-blur-md text-white hover:bg-white/10 transition-colors border border-white/10 flex items-center justify-center">
                                <i class="fas fa-video text-xl"></i>
                            </button>
                            <button onclick="app.toggleMic()" class="h-14 rounded-2xl bg-black/40 backdrop-blur-md text-white hover:bg-white/10 transition-colors border border-white/10 flex items-center justify-center">
                                <i class="fas fa-microphone text-xl"></i>
                            </button>
                        </div>

                        <button onclick="app.reset()" class="w-full bg-red-500/90 backdrop-blur hover:bg-red-600 text-white font-bold py-4 rounded-2xl transition-all shadow-lg flex items-center justify-center gap-2">
                            <i class="fas fa-stop"></i>
                            <span>Stop Stream</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Error Toast -->
    <div id="toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-red-500/90 backdrop-blur-md text-white px-6 py-3 rounded-2xl shadow-2xl opacity-0 transition-all duration-300 pointer-events-none z-[60] text-sm font-medium flex items-center gap-3 border border-red-400/20 translate-y-4">
        <div class="w-6 h-6 rounded-full bg-white/20 flex items-center justify-center shrink-0">
            <i class="fas fa-exclamation text-xs"></i>
        </div>
        <span id="toastMsg">Error message</span>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, deleteDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for the app instance
        let firebaseApp, auth, db, appId;

        // WebRTC Config
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // Application State
        class SecureConnect {
            constructor() {
                this.localStream = null;
                this.peerConnection = null;
                this.unsubscribe = null;
                this.currentDocPath = null;
                this.role = null; // 'viewer' or 'camera'
                
                // UI Elements
                this.els = {
                    configScreen: document.getElementById('configScreen'),
                    home: document.getElementById('homeScreen'),
                    viewer: document.getElementById('viewerScreen'),
                    camera: document.getElementById('cameraScreen'),
                    codeDisplay: document.getElementById('codeDisplay'),
                    generatedCode: document.getElementById('generatedCode'),
                    remoteVideo: document.getElementById('remoteVideo'),
                    localVideo: document.getElementById('localVideo'),
                    cameraPreview: document.getElementById('cameraPreviewContainer'),
                    codeInput: document.getElementById('codeInputForm'),
                    status: document.getElementById('connectionStatus'),
                    streamPlaceholder: document.getElementById('streamPlaceholder'),
                    toast: document.getElementById('toast'),
                    toastMsg: document.getElementById('toastMsg'),
                    inputField: document.getElementById('codeJump'),
                    btnConnect: document.getElementById('btnConnect')
                };

                this.checkEnvironment();
            }

            checkEnvironment() {
                // Check if running in Canvas (env vars exist) or Local (env vars undefined)
                if (typeof __firebase_config !== 'undefined') {
                    // Running in Canvas
                    const config = JSON.parse(__firebase_config);
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
                    this.initializeFirebase(config);
                    this.els.home.classList.remove('hidden'); // Show home immediately
                } else {
                    // Running Locally - Show Config Screen
                    this.els.configScreen.classList.remove('hidden');
                }
            }

            async initializeFirebase(config) {
                try {
                    firebaseApp = initializeApp(config);
                    auth = getAuth(firebaseApp);
                    db = getFirestore(firebaseApp);
                    
                    // Auth Flow
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    console.log("Authenticated");
                    this.authReady = true;
                } catch (error) {
                    console.error("Firebase Init Error:", error);
                    this.showError("Failed to initialize Firebase. Check config.");
                }
            }

            // Called by the manual init button
            async manualInitialize(configJson) {
                try {
                    const config = JSON.parse(configJson);
                    // Use a generic app ID for local testing
                    appId = 'local-dev-app';
                    await this.initializeFirebase(config);
                    
                    // Transition UI
                    this.els.configScreen.classList.add('hidden');
                    this.els.home.classList.remove('hidden');
                } catch (e) {
                    this.showError("Invalid JSON Configuration");
                }
            }

            // --- UI LOGIC ---

            setMode(mode) {
                this.role = mode;
                this.els.home.classList.add('opacity-0', '-translate-y-4');
                setTimeout(() => {
                    this.els.home.classList.add('hidden');
                    this.els.home.classList.remove('opacity-0', '-translate-y-4');
                    
                    if (mode === 'viewer') {
                        this.els.viewer.classList.remove('hidden');
                        this.startViewer();
                    } else {
                        this.els.camera.classList.remove('hidden');
                        this.els.cameraPreview.classList.add('hidden');
                        this.els.codeInput.classList.remove('hidden');
                        this.els.inputField.focus();
                    }
                }, 300);
            }

            reset() {
                // Cleanup WebRTC
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => track.stop());
                    this.localStream = null;
                }
                if (this.peerConnection) {
                    this.peerConnection.close();
                    this.peerConnection = null;
                }
                
                // Cleanup Firestore
                if (this.unsubscribe) this.unsubscribe();
                // Ideally delete the doc if we created it
                if (this.role === 'viewer' && this.currentDocPath && db) {
                    deleteDoc(doc(db, this.currentDocPath)).catch(e => console.log("Cleanup warning:", e));
                }

                // Reset UI
                this.els.home.classList.remove('hidden');
                this.els.viewer.classList.add('hidden');
                this.els.camera.classList.add('hidden');
                this.els.cameraPreview.classList.add('hidden');
                this.els.codeDisplay.classList.remove('hidden'); // Show code overlay again for next time
                this.els.status.classList.add('hidden');
                this.els.remoteVideo.srcObject = null;
                this.els.localVideo.srcObject = null;
                this.els.inputField.value = '';
                this.els.btnConnect.disabled = false;
                this.els.btnConnect.innerHTML = `<span>Start Streaming</span><i class="fas fa-arrow-right text-sm"></i>`;
                
                this.role = null;
            }

            showError(msg) {
                this.els.toastMsg.innerText = msg;
                this.els.toast.classList.remove('opacity-0', 'translate-y-4');
                setTimeout(() => this.els.toast.classList.add('opacity-0', 'translate-y-4'), 3000);
            }

            setStatus(status) {
                const el = this.els.status;
                el.classList.remove('hidden');
                if (status === 'connected') {
                    el.className = "px-4 py-1.5 rounded-full text-xs font-semibold bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 backdrop-blur-md shadow-lg shadow-emerald-500/10";
                    el.innerHTML = '<i class="fas fa-wifi mr-1.5"></i> Connected';
                    // Hide code overlay on viewer
                    if (this.role === 'viewer') {
                        this.els.codeDisplay.classList.add('hidden');
                        this.els.streamPlaceholder.classList.add('hidden');
                    }
                } else if (status === 'connecting') {
                    el.className = "px-4 py-1.5 rounded-full text-xs font-semibold bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 backdrop-blur-md";
                    el.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-1.5"></i> Connecting...';
                } else {
                    el.className = "px-4 py-1.5 rounded-full text-xs font-semibold bg-red-500/10 text-red-400 border border-red-500/20 backdrop-blur-md";
                    el.innerHTML = 'Disconnected';
                }
            }

            // --- VIEWER LOGIC (Host) ---

            async startViewer() {
                if (!this.authReady) return this.showError("Not connected to database");
                
                const code = Math.floor(100000 + Math.random() * 900000).toString();
                this.els.generatedCode.innerText = code.substring(0,3) + ' ' + code.substring(3,6);
                
                // Firestore Path: public/data/sessions/{code}
                const sessionPath = `artifacts/${appId}/public/data/sessions`;
                const docRef = doc(db, sessionPath, code);
                this.currentDocPath = `${sessionPath}/${code}`;

                try {
                    // Create session
                    await setDoc(docRef, { created: new Date().toISOString() });
                    
                    // Listen for camera joining (OFFER)
                    this.unsubscribe = onSnapshot(docRef, async (snapshot) => {
                        const data = snapshot.data();
                        if (!data) return;

                        // 1. If we receive an OFFER from camera
                        if (data.offer && !this.peerConnection) {
                            this.setStatus('connecting');
                            await this.createViewerPeerConnection(docRef, data.offer);
                        }

                        // 2. Add ICE candidates from camera
                        if (data.cameraCandidates && this.peerConnection) {
                            for (const candidate of data.cameraCandidates) {
                                await this.peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                            }
                        }
                    });

                } catch (e) {
                    console.error(e);
                    this.showError("Failed to create connection code.");
                }
            }

            async createViewerPeerConnection(docRef, offer) {
                this.peerConnection = new RTCPeerConnection(rtcConfig);

                // Handle incoming stream
                this.peerConnection.ontrack = (event) => {
                    this.els.remoteVideo.srcObject = event.streams[0];
                    this.setStatus('connected');
                };

                // Collect Viewer ICE candidates
                this.peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        updateDoc(docRef, {
                            viewerCandidates: arrayUnion(event.candidate.toJSON())
                        });
                    }
                };

                // State handling
                this.peerConnection.onconnectionstatechange = () => {
                    if (this.peerConnection.connectionState === 'disconnected') {
                        this.setStatus('disconnected');
                        this.showError("Camera disconnected");
                        // Optional: Reset to code screen
                        this.els.codeDisplay.classList.remove('hidden');
                        this.els.streamPlaceholder.classList.remove('hidden');
                    }
                };

                // Set Remote & Create Answer
                await this.peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await this.peerConnection.createAnswer();
                await this.peerConnection.setLocalDescription(answer);

                const answerData = {
                    type: answer.type,
                    sdp: answer.sdp
                };

                await updateDoc(docRef, { answer: answerData });
            }

            toggleMuteRemote() {
                this.els.remoteVideo.muted = !this.els.remoteVideo.muted;
                const btn = document.getElementById('btnMute');
                btn.innerHTML = this.els.remoteVideo.muted ? '<i class="fas fa-volume-mute text-red-400"></i>' : '<i class="fas fa-volume-up"></i>';
            }

            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }


            // --- CAMERA LOGIC (Client) ---

            async connectCamera() {
                if (!this.authReady) return this.showError("Not connected to database");

                const rawCode = this.els.inputField.value.replace(/\s/g, ''); // Remove spaces
                if (rawCode.length !== 6) {
                    this.showError("Please enter a valid 6-digit code.");
                    return;
                }

                this.els.btnConnect.disabled = true;
                this.els.btnConnect.innerHTML = `<i class="fas fa-circle-notch fa-spin text-sm"></i> Connecting...`;

                const sessionPath = `artifacts/${appId}/public/data/sessions`;
                const docRef = doc(db, sessionPath, rawCode);
                this.currentDocPath = `${sessionPath}/${rawCode}`;

                try {
                    // Check if code exists first (security)
                    // Note: In real app, we should use getDoc first, but onSnapshot handles it too. 
                    // Let's attach listener immediately.
                    
                    // Get User Media
                    this.localStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' }, // Try back camera first
                        audio: true 
                    });
                    
                    this.els.localVideo.srcObject = this.localStream;
                    this.els.codeInput.classList.add('hidden');
                    this.els.cameraPreview.classList.remove('hidden');

                    this.peerConnection = new RTCPeerConnection(rtcConfig);

                    // Add Tracks
                    this.localStream.getTracks().forEach(track => {
                        this.peerConnection.addTrack(track, this.localStream);
                    });

                    // ICE Candidates
                    this.peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            updateDoc(docRef, {
                                cameraCandidates: arrayUnion(event.candidate.toJSON())
                            });
                        }
                    };

                    // Listen for Answer
                    this.unsubscribe = onSnapshot(docRef, async (snapshot) => {
                        const data = snapshot.data();
                        if (!data) {
                            this.showError("Invalid Code or Session Expired");
                            this.reset();
                            return;
                        }

                        // Set Remote Description (Answer)
                        if (data.answer && !this.peerConnection.currentRemoteDescription) {
                             const answer = new RTCSessionDescription(data.answer);
                             await this.peerConnection.setRemoteDescription(answer);
                             this.setStatus('connected');
                        }

                        // Add Viewer ICE candidates
                        if (data.viewerCandidates) {
                            for (const candidate of data.viewerCandidates) {
                                await this.peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                            }
                        }
                    });

                    // Create Offer
                    const offer = await this.peerConnection.createOffer();
                    await this.peerConnection.setLocalDescription(offer);

                    const offerData = {
                        type: offer.type,
                        sdp: offer.sdp
                    };

                    await updateDoc(docRef, { offer: offerData });


                } catch (error) {
                    console.error("Camera Error:", error);
                    this.showError("Access denied or connection failed.");
                    this.reset();
                }
            }

            toggleCamera() {
                const videoTrack = this.localStream.getVideoTracks()[0];
                if(videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    this.showError(videoTrack.enabled ? "Camera On" : "Camera Off");
                }
            }

            toggleMic() {
                const audioTrack = this.localStream.getAudioTracks()[0];
                if(audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    this.showError(audioTrack.enabled ? "Mic On" : "Mic Muted");
                }
            }
        }

        // Initialize App
        window.app = new SecureConnect();
        
        // Expose manual init to window for the button click
        window.manualInit = () => {
            const val = document.getElementById('manualConfigInput').value;
            window.app.manualInitialize(val);
        };
    </script>
</body>
</html>